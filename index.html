<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="theme-color" content="#0b3d2e" />
  <title>å¤©ä½¿ç¬‘é•·ï½œå‰µä½œå·¥ä½œå®¤ï¼ˆPWAï¼‰å…¨åŠŸèƒ½ç‰ˆ</title>

  <link rel="manifest" href="./manifest.json">
  <link rel="icon" href="./icon-192.png">

  <style>
    :root{
      --bg:#0b3d2e;
      --card:#0f4a37;
      --card2:#11533d;
      --txt:#eef7f1;
      --muted:#cfe6db;
      --accent:#f0a04b;
      --danger:#ff6b6b;
      --ok:#4cd964;
      --border: rgba(255,255,255,.12);
      --shadow: 0 10px 30px rgba(0,0,0,.25);
      --radius: 18px;
      --ink: rgba(0,0,0,.22);
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: system-ui, -apple-system, "Noto Sans TC", Segoe UI, Roboto, Arial, sans-serif;
      background:
        radial-gradient(1200px 900px at 30% -10%, rgba(240,160,75,.25), transparent 55%),
        radial-gradient(1200px 900px at 110% 20%, rgba(76,217,100,.18), transparent 45%),
        linear-gradient(180deg, #082f24, var(--bg));
      color:var(--txt);
      min-height:100vh;
      padding:18px 12px 40px;
    }
    .wrap{max-width:1100px;margin:0 auto}
    header{
      display:flex;gap:12px;align-items:center;justify-content:space-between;
      margin-bottom:12px;flex-wrap:wrap;
    }
    .brand{display:flex;align-items:center;gap:10px}
    .logo{
      width:40px;height:40px;border-radius:14px;
      background: rgba(255,255,255,.08);
      border:1px solid var(--border);
      display:grid;place-items:center;
      box-shadow: var(--shadow);
      font-weight:900;
    }
    .brandTxt{display:flex;flex-direction:column;gap:2px}
    .brandTxt h1{font-size:18px;margin:0;font-weight:950;letter-spacing:.5px}
    .brandTxt .sub{font-size:12px;color:var(--muted);line-height:1.4}
    .topBtns{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}

    button{
      border:1px solid var(--border);
      background: rgba(255,255,255,.06);
      color: var(--txt);
      padding:10px 12px;
      border-radius: 12px;
      cursor:pointer;
      transition: transform .05s ease, background .2s ease;
      font-weight:850;
    }
    button:active{transform: translateY(1px)}
    button.primary{
      background: linear-gradient(180deg, rgba(240,160,75,.95), rgba(240,160,75,.82));
      border-color: rgba(0,0,0,.1);
      color:#1b1b1b;
    }
    button.ok{
      background: rgba(76,217,100,.12);
      border-color: rgba(76,217,100,.35);
      color:#d9ffe4;
    }
    button.danger{
      background: rgba(255,107,107,.12);
      border-color: rgba(255,107,107,.35);
      color:#ffd5d5;
    }
    button.ghost{background: transparent}
    a{color:#ffd3a0}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.06), rgba(255,255,255,.03));
      border:1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .tabs{
      display:flex;gap:8px;flex-wrap:wrap;
      padding:10px 12px 0;
    }
    .tab{
      padding:9px 10px;
      border-radius: 999px;
      border:1px solid var(--border);
      background: rgba(255,255,255,.05);
      font-size:12px;
      font-weight:950;
      cursor:pointer;
      user-select:none;
    }
    .tab.active{
      background: rgba(240,160,75,.18);
      border-color: rgba(240,160,75,.45);
    }
    .status{
      display:flex;gap:8px;align-items:center;flex-wrap:wrap;
      padding:10px 14px 0;
    }
    .pill{
      font-size:11px;
      padding:4px 8px;
      border-radius: 999px;
      border:1px solid var(--border);
      color: var(--muted);
    }
    .bd{padding:14px}
    .grid{display:grid;grid-template-columns:1fr;gap:12px;margin-top:12px}
    @media(min-width:980px){ .grid{grid-template-columns: 1.2fr .8fr;} }

    .hd{
      padding:14px 14px 10px;
      border-bottom: 1px solid var(--border);
      display:flex;justify-content:space-between;align-items:flex-start;gap:10px;
    }
    .title{margin:0;font-size:14px;font-weight:950;letter-spacing:.5px}
    .hint{margin:4px 0 0;color:var(--muted);font-size:12px;line-height:1.55}
    .row{display:grid;grid-template-columns:1fr;gap:10px}
    @media(min-width:760px){
      .row.two{grid-template-columns:1fr 1fr}
      .row.three{grid-template-columns:1fr 1fr 1fr}
    }
    label{font-size:12px;color:var(--muted);display:block;margin:0 0 6px}
    input, select, textarea{
      width:100%;
      padding:10px 10px;
      border-radius: 12px;
      border:1px solid rgba(255,255,255,.15);
      background: rgba(0,0,0,.18);
      color:var(--txt);
      outline:none;
    }
    textarea{min-height:120px;resize:vertical;line-height:1.6}
    .small{font-size:12px;color:var(--muted);line-height:1.55}
    .kbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
    .divider{height:1px;background:rgba(255,255,255,.12);margin:12px 0}
    .sectionSep{height:10px}
    code.inline{background:rgba(0,0,0,.25);padding:2px 6px;border-radius:8px;border:1px solid rgba(255,255,255,.12)}

    .toast{
      position:fixed;left:50%;bottom:16px;transform:translateX(-50%);
      background: rgba(0,0,0,.78);
      border:1px solid rgba(255,255,255,.18);
      padding:10px 12px;border-radius: 999px;
      font-size:12px;color:#fff;
      box-shadow: var(--shadow);
      opacity:0; pointer-events:none;
      transition: opacity .2s ease, transform .2s ease;
      z-index:999;
    }
    .toast.show{opacity:1; transform:translateX(-50%) translateY(-2px);}

    /* list cards */
    .list{display:grid;gap:10px}
    .item{
      border:1px solid rgba(255,255,255,.12);
      border-radius: 14px;
      background: rgba(0,0,0,.14);
      padding:12px;
    }
    .itemTop{
      display:flex;justify-content:space-between;gap:10px;flex-wrap:wrap;
      align-items:flex-start;
    }
    .itemTitle{font-weight:950;font-size:13px;margin:0 0 4px}
    .badges{display:flex;gap:6px;flex-wrap:wrap}
    .badge{
      font-size:11px;padding:3px 8px;border-radius:999px;
      border:1px solid rgba(255,255,255,.14);
      color:var(--muted);
      background: rgba(255,255,255,.04);
    }
    .itemBtns{display:flex;gap:8px;flex-wrap:wrap}
    .mono{
      font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      font-size:11px;
      white-space:pre-wrap;
      background: rgba(0,0,0,.18);
      border: 1px solid rgba(255,255,255,.10);
      border-radius: 12px;
      padding:10px;
    }

    dialog{
      border:1px solid rgba(255,255,255,.18);
      border-radius:18px;
      max-width:920px;width:92vw;
      background:#082f24;color:var(--txt);
      box-shadow:var(--shadow);
    }
  </style>
</head>

<body>
<div class="wrap">

  <header>
    <div class="brand">
      <div class="logo">å¹¸</div>
      <div class="brandTxt">
        <h1>å¤©ä½¿ç¬‘é•·ï½œå‰µä½œå·¥ä½œå®¤ï¼ˆPWAï¼‰å…¨åŠŸèƒ½ç‰ˆ</h1>
        <div class="sub">ç´ æåº« Ã— å’’èªåŒ…åº« Ã— å‰µä½œ/å®Œç¨¿ Ã— æ–‡å®£åº« Ã— ç™¼ç‰‡æ‰“åŒ… Ã— é›²ç«¯å‚™ä»½ Ã— æ¬å®¶åŒ¯å‡º</div>
      </div>
    </div>

    <div class="topBtns">
      <button id="btnSaveAll" class="ok">ä¿å­˜ï¼ˆæœ¬æ©Ÿï¼‰</button>
      <button id="btnCloud" class="primary">â˜ï¸ ä¸€éµé›²ç«¯å‚™ä»½</button>
      <button id="btnCloudCfg" class="ghost">âš™ï¸ é›²ç«¯è¨­å®š</button>
      <button id="btnExport" class="primary">ğŸ“¦ åŒ¯å‡º JSONï¼ˆæ¬å®¶ï¼‰</button>
      <button id="btnImport" class="ok">ğŸ“¥ åŒ¯å…¥ JSON</button>
      <input id="fileImport" type="file" accept="application/json" hidden>
    </div>
  </header>

  <div class="card">
    <div class="tabs" id="tabs"></div>

    <div class="status">
      <span class="pill" id="pillLocal">æœ¬æ©Ÿï¼šæœªå„²å­˜</span>
      <span class="pill" id="pillCloud">é›²ç«¯ï¼šæœªè¨­å®š</span>
      <span class="pill" id="pillCounts">ç´ æ0ï½œå®Œç¨¿0ï½œæ–‡å®£0ï½œæ‰“åŒ…0ï½œå’’èª0</span>
      <span class="pill" id="pillLast">æ›´æ–°ï¼šâ€”</span>
      <span class="pill" id="pillLastCloud">ä¸Šæ¬¡é›²ç«¯ï¼šâ€”</span>
    </div>

    <div class="bd" id="view"></div>
  </div>

  <div class="toast" id="toast">å®Œæˆ</div>

  <!-- Cloud settings dialog -->
  <dialog id="dlgCloud">
    <form method="dialog" style="margin:0">
      <div class="hd" style="border-bottom:1px solid rgba(255,255,255,.12)">
        <div>
          <p class="title" style="margin:0">âš™ï¸ é›²ç«¯è¨­å®šï¼ˆGoogle è¡¨å–®å‚™ä»½ï¼‰</p>
          <p class="hint" style="margin:6px 0 0">
            é€™è£¡æ¡ç”¨ã€ŒæŠŠæ•´åŒ…è³‡æ–™ JSONã€é€åˆ° Google è¡¨å–®ï¼ˆå¯«é€²è©¦ç®—è¡¨ï¼‰ã€‚<br>
            ä½ åªè¦åšä¸€æ¬¡ï¼šå¡« <b>formResponse URL</b> + <b>entry idï¼ˆJSONæ¬„ä½ï¼‰</b> å³å¯ã€‚
          </p>
        </div>
        <button value="cancel">é—œé–‰</button>
      </div>

      <div class="bd">
        <div class="row">
          <div>
            <label>â‘  formResponse URLï¼ˆå¿…å¡«ï¼‰</label>
            <input id="cfgFormResponse" placeholder="ä¾‹å¦‚ï¼šhttps://docs.google.com/forms/d/e/XXXX/formResponse">
            <div class="small">
              ä½ çš„çŸ­ç¶²å€ï¼ˆä½ ä¹‹å‰çµ¦éï¼‰å¯ç”¨ä¾†æ‰¾åˆ°è¡¨å–®ï¼š<br>
              <code class="inline">https://forms.gle/FdNdqNSZ24v6GH7CA</code><br><br>
              å–å¾—æ–¹å¼ï¼šè¡¨å–®ç·¨è¼¯ â†’ å³ä¸Šã€Œâ‹®ã€â†’ å–å¾—é å…ˆå¡«å¯«é€£çµ â†’ é€£çµè£¡æœƒçœ‹åˆ° entry.xxxxxx<br>
              formResponse é€šå¸¸æ˜¯ï¼š<code class="inline">https://docs.google.com/forms/d/e/.../formResponse</code>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row two">
          <div>
            <label>â‘¡ entry idï¼ˆJSON ä¸»æ¬„ä½ï¼Œå¿…å¡«ï¼‰</label>
            <input id="cfgEntryJson" placeholder="ä¾‹å¦‚ï¼šentry.1234567890">
            <div class="small">å»ºè­°è¡¨å–®æ–°å¢ä¸€é¡Œã€Œé•·æ–‡å­—ã€ï¼šåç¨±å¯å«ã€Œå‚™ä»½JSONã€ã€‚</div>
          </div>
          <div>
            <label>ï¼ˆå¯é¸ï¼‰entry idï¼ˆå‚™è¨»/æ¨™é¡Œï¼‰</label>
            <input id="cfgEntryNote" placeholder="ä¾‹å¦‚ï¼šentry.2345678901ï¼ˆå¯ç•™ç©ºï¼‰">
          </div>
        </div>

        <div class="divider"></div>

        <div class="kbar">
          <button id="btnSaveCloudCfg" class="primary" value="default">ä¿å­˜è¨­å®š</button>
          <button id="btnTestCloud" class="ok" value="default" type="button">é€å‡ºæ¸¬è©¦</button>
          <button id="btnResetCloudCfg" class="danger" value="default" type="button">æ¸…é™¤é›²ç«¯è¨­å®š</button>
        </div>

        <div class="sectionSep"></div>

        <label>æ¸¬è©¦/ç´€éŒ„</label>
        <div class="mono" id="cloudLog" style="min-height:120px"></div>
      </div>
    </form>
  </dialog>

</div>

<script>
/** =========================================================
 * å¤©ä½¿ç¬‘é•·ï½œå‰µä½œå·¥ä½œå®¤ï¼ˆPWAï¼‰å…¨åŠŸèƒ½å–®é 
 * - ç´ æåº«ï¼ˆç”Ÿå‘½æ•…äº‹ï¼‰âœ…
 * - å’’èªåŒ…åº« âœ…
 * - å‰µä½œå€ï¼ˆæç¤º/ç”¢å‡ºï¼‰âœ…
 * - å®Œç¨¿åº« âœ…
 * - æ–‡å®£åº«ï¼ˆFB/IG/LINE/å®˜ç¶²æç¤ºï¼‰âœ…
 * - ç™¼ç‰‡æ‰“åŒ…åº« âœ…
 * - é›²ç«¯å‚™ä»½ï¼ˆGoogle Formï¼šé€æ•´åŒ… JSONï¼‰âœ…
 * - JSON åŒ¯å‡º/åŒ¯å…¥ï¼ˆæ›æ‰‹æ©Ÿæœ€ç©©ï¼‰âœ…
 * - icon 192/512 ç”Ÿæˆ âœ…
 * - ç§»é™¤å®‰è£æŒ‰éˆ• âœ…
 * ========================================================= */

const $ = (id)=>document.getElementById(id);
const LS_KEY = "angel_studio_full_v1_data";
const CLOUD_KEY = "angel_studio_full_v1_cloud_cfg";

/* ---------- enums ---------- */
const SERIES = ["å¹¸ç¦æ•™é¤Š","å¿ƒè…¦ç§‘å­¸","å¿ƒéˆæ„Ÿæ‚Ÿ","è©©è©äººç”Ÿ","å¹¸ç¦å°è…¦è¢‹","å…¶ä»–"];
const PURPOSE = ["æ›¸ç¨¿","é•·å½±ç‰‡å£èªªç¨¿","çŸ­å½±ç‰‡","Podcast","èª²ç¨‹","ç™¼ç‰‡æ‰“åŒ…","èª²ç¨‹æ‰“åŒ…"];
const PROMO_TYPE = ["è©¦ç”¨æ´»å‹•ä»‹ç´¹","å·¥å…·æ¨å»£","ç¤¾ç¾¤è²¼æ–‡","é–‹èª²å®£å‚³","å…è²»é«”é©—é‚€è«‹","å®˜ç¶²/ä»‹ç´¹é ","å…¶ä»–"];
const PROMO_PLATFORM = ["FBï¼ˆé•·æ–‡ï¼‰","IGï¼ˆç²¾ç°¡ï¼‰","LINEï¼ˆç¾¤çµ„ï¼‰","å®˜ç¶²ï¼ˆå®Œæ•´ï¼‰"];

const TAB_ITEMS = [
  {key:"materials", name:"ç´ æåº«ï¼ˆç”Ÿå‘½æ•…äº‹ï¼‰"},
  {key:"create", name:"å‰µä½œå€"},
  {key:"finals", name:"å®Œç¨¿åº«"},
  {key:"promo", name:"æ–‡å®£åº«"},
  {key:"publish", name:"ç™¼ç‰‡æ‰“åŒ…"},
  {key:"spells", name:"å’’èªåŒ…åº«"},
  {key:"backup", name:"è¨­å®š/å‚™ä»½"},
];

/* ---------- state ---------- */
const state = {
  tab: "materials",
  data: {
    updatedAt: null,
    lastCloudAt: null,

    materials: [], // {id,title,scene,feel,insight,tool,series,createdAt,updatedAt}
    spells: [],    // {id,title,category,content,createdAt,updatedAt}

    create: { series:"å¹¸ç¦æ•™é¤Š", purpose:"æ›¸ç¨¿", topic:"", body:"", output:"", prompt:"", linkMaterialId:"" },
    finals: [],    // {id,series,purpose,topic,body,output,createdAt,updatedAt}
    promoDraft: {
      tool:"å¹¸ç¦æ•™é¤Šï½œé›¶ç”¨éŒ¢ç·´åŠŸæˆ¿", series:"å¹¸ç¦æ•™é¤Š", type:"è©¦ç”¨æ´»å‹•ä»‹ç´¹", platform:"FBï¼ˆé•·æ–‡ï¼‰",
      title:"", body:"", tags:"#å¹¸ç¦æ•™é¤Š #é›¶ç”¨éŒ¢ç·´åŠŸæˆ¿", links:"", cta:"ç•™è¨€ï¼šã€Œç†æ™ºéšŠé•·å ±åˆ°ï¼ã€ä¸€èµ·äº¤æµ", prompt:""
    },
    promos: [],    // {id,tool,series,type,platform,title,body,tags,links,cta,createdAt,updatedAt}

    publishDraft: { title:"", date:"", intro:"", hashtags:"#å¹¸ç¦æ•™é¤Š #å¤©ä½¿ç¬‘é•·", toolLinks:"", notes:"" },
    publishes: []  // {id,title,date,intro,hashtags,toolLinks,notes,createdAt,updatedAt}
  },
  cloud: {
    formResponse:"",
    entryJson:"",
    entryNote:"",
  },
  filters: {
    materialsQuery:"",
    finalsQuery:"",
    promoQuery:"",
    promoTool:"å…¨éƒ¨",
    promoSeries:"å…¨éƒ¨",
    promoType:"å…¨éƒ¨",
    publishQuery:"",
    spellsQuery:"",
    spellsCat:"å…¨éƒ¨",
  }
};

/* ---------- utils ---------- */
function nowISO(){ return new Date().toISOString(); }
function fmt(ts){
  if(!ts) return "â€”";
  const d=new Date(ts);
  if(Number.isNaN(d.getTime())) return "â€”";
  return d.toLocaleString("zh-Hant",{hour12:false});
}
function uid(){ return Math.random().toString(16).slice(2)+"-"+Date.now().toString(16); }
function toast(msg="å®Œæˆ"){
  const t=$("toast"); t.textContent=msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 1400);
}
function escapeHtml(s){
  return (s??"").replace(/[&<>"']/g, m=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[m]));
}
async function copyText(text){
  try{
    await navigator.clipboard.writeText(text);
    toast("å·²è¤‡è£½");
  }catch(e){
    const ta=document.createElement("textarea");
    ta.value=text; document.body.appendChild(ta);
    ta.select(); document.execCommand("copy");
    ta.remove(); toast("å·²è¤‡è£½");
  }
}

/* ---------- persistence ---------- */
function loadAll(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(raw){
      const obj = JSON.parse(raw);
      if(obj?.data){
        // merge
        state.data = {...state.data, ...obj.data};
        state.data.create = {...state.data.create, ...(obj.data.create||{})};
        state.data.promoDraft = {...state.data.promoDraft, ...(obj.data.promoDraft||{})};
        state.data.publishDraft = {...state.data.publishDraft, ...(obj.data.publishDraft||{})};
      }
    }
  }catch(e){}

  try{
    const raw = localStorage.getItem(CLOUD_KEY);
    if(raw){
      const cfg = JSON.parse(raw);
      if(cfg) state.cloud = {...state.cloud, ...cfg};
    }
  }catch(e){}
}
function saveAll(){
  state.data.updatedAt = nowISO();
  localStorage.setItem(LS_KEY, JSON.stringify({data:state.data}, null, 2));
  updatePills();
  toast("å·²ä¿å­˜");
}
function updatePills(){
  $("pillLocal").textContent = state.data.updatedAt ? `æœ¬æ©Ÿï¼šå·²ä¿å­˜ï¼ˆ${fmt(state.data.updatedAt)}ï¼‰` : "æœ¬æ©Ÿï¼šæœªå„²å­˜";
  $("pillCloud").textContent = isCloudReady() ? "é›²ç«¯ï¼šå·²è¨­å®š âœ…" : "é›²ç«¯ï¼šæœªè¨­å®š";
  $("pillCounts").textContent =
    `ç´ æ${state.data.materials.length}ï½œå®Œç¨¿${state.data.finals.length}ï½œæ–‡å®£${state.data.promos.length}ï½œæ‰“åŒ…${state.data.publishes.length}ï½œå’’èª${state.data.spells.length}`;
  $("pillLast").textContent = `æ›´æ–°ï¼š${fmt(state.data.updatedAt)}`;
  $("pillLastCloud").textContent = `ä¸Šæ¬¡é›²ç«¯ï¼š${fmt(state.data.lastCloudAt)}`;
}

/* ---------- prompts (æ ¸å¿ƒï¼šä¾ä½  CTA è¦å‰‡) ---------- */
function ctaForSeries(series, purpose){
  // ä½ å…ˆå‰è¦å‰‡ï¼š
  // - å¹¸ç¦æ•™é¤Šï¼šé•·ç‰‡ CTA ä¸»é  +ã€Œæ¯é€±äº”æ›´æ–°ã€
  // - è©©è©äººç”Ÿï¼šæ²’æœ‰é•·ç‰‡ï¼›ä¸­/çŸ­/short CTA ä¸»é  +ã€Œæ¯é€±ä¸€æ›´æ–°ã€
  // - å…¶ä»–ï¼šä¸»é  +ã€Œæ¯é€±æ›´æ–°ã€(ä¿å®ˆ)
  if(series==="å¹¸ç¦æ•™é¤Š" && purpose==="é•·å½±ç‰‡å£èªªç¨¿"){
    return "CTAï¼ˆå°åˆ°ä¸»é ï¼‰ï¼šå¦‚æœä½ ä¹Ÿåœ¨ç·´ç¿’æŠŠå¿ƒç«™ç©©ï¼Œæ­¡è¿ä¾†åˆ°å¤©ä½¿ç¬‘é•·çš„ä¸»é ã€‚é€™è£¡æœ‰å¿ƒç†å­¸ã€è…¦ç¥ç¶“ç§‘å­¸ã€å¿ƒéˆæˆé•·èˆ‡å¹¸ç¦æ•™é¤Šç³»åˆ—å½±ç‰‡ï¼Œé™ªä½ æŠŠå¿ƒä¸€æ¬¡ä¸€æ¬¡æ”¾å›ä¸­é–“ã€‚ï½œæ¯é€±äº”æ›´æ–°";
  }
  if(series==="è©©è©äººç”Ÿ"){
    // è©©è©äººç”Ÿä¸åšé•·ç‰‡ï¼›è‹¥ä»é¸é•·ç‰‡ï¼Œå°±æé†’ä¸æ”¾ CTA
    if(purpose==="é•·å½±ç‰‡å£èªªç¨¿") return "ï¼ˆæé†’ï¼šè©©è©äººç”Ÿé•·ç‰‡ä½ åå¥½ä¸æ”¾ CTAï¼›è‹¥æ˜¯ä¸­/çŸ­ç‰‡æ‰æ”¾ä¸»é å¼•æµï¼šæ¯é€±ä¸€æ›´æ–°ï¼‰";
    return "CTAï¼ˆå°åˆ°ä¸»é ï¼‰ï¼šæ›´å¤šè©©è©äººç”Ÿèˆ‡ç”Ÿæ´»ç·´ç¿’ï¼Œéƒ½åœ¨å¤©ä½¿ç¬‘é•·ä¸»é ï½œæ¯é€±ä¸€æ›´æ–°";
  }
  return "CTAï¼ˆå°åˆ°ä¸»é ï¼‰ï¼šæ›´å¤šå¿ƒç†å­¸ã€è…¦ç¥ç¶“ç§‘å­¸èˆ‡å¹¸ç¦æ•™é¤Šå…§å®¹ï¼Œéƒ½åœ¨å¤©ä½¿ç¬‘é•·ä¸»é ï½œæ¯é€±æ›´æ–°";
}

function buildCreatePrompt(){
  const c = state.data.create;
  const base = `ä½ æ˜¯ã€Œå¤©ä½¿ç¬‘é•·ã€çš„å”ä½œå¤¥ä¼´ã€‚è«‹ä¾ç…§ä»¥ä¸‹è¼¸å…¥ï¼Œç”¢å‡ºæˆ‘éœ€è¦çš„ç‰ˆæœ¬ã€‚å“ç‰Œèªæ„Ÿï¼šæŠŠå¿ƒç«™ç©©ã€æ´»å¾—è‡ªåœ¨ï¼›ä¸èªªæ•™ã€æº«æŸ”è€Œç¯¤å®šï¼›è¦æœ‰ç•«é¢æ„Ÿï¼›è¦å¯è½åœ°ã€å¯ç›´æ¥ä½¿ç”¨ã€‚`;

  const blocks = {
    "å¹¸ç¦æ•™é¤Š": [
      "å£å»ï¼šè¼•é¬†æº«é¦¨é™ªä¼´ã€ä¸èªªæ•™ã€å¸¶ç•«é¢æ„Ÿã€‚",
      "çµæ§‹ï¼šHook â†’ æ‰¿è«¾ â†’ å®Œæ•´æ•…äº‹/æƒ…å¢ƒ â†’ å¿ƒè…¦ç§‘å­¸è§£æï¼ˆå‰é¡è‘‰/æä»æ ¸/è‡ªæ§åŠ›ï¼‰â†’ å¥½ç”¨å·¥å…·ï¼ˆæ–¹æ³•/è©±è¡“/ç·´ç¿’ï¼‰â†’ CTAã€‚",
      ctaForSeries(c.series, c.purpose)
    ],
    "å¿ƒè…¦ç§‘å­¸": [
      "å£å»ï¼šè¦ªæ°‘å¹½é»˜ã€æ˜“æ‡‚ã€æœ‰æ¯”å–»ã€‚",
      "æ­£æ–‡ï¼šå°‡åŸæ–‡æ”¹å¯«ç‚º 1000â€“2500 å­—ï¼Œæ¸…æ¥šåˆ†æ®µï¼Œçµ¦å‡ºå¯åŸ·è¡Œæ–¹æ³•ã€‚",
      ctaForSeries(c.series, c.purpose)
    ],
    "è©©è©äººç”Ÿ": [
      "å£å»ï¼šæ–‡é›…å“²å­¸ã€æ¸…äº®ä½†ä¸è‰±æ¾€ã€‚",
      "çµæ§‹ï¼šHook â†’ ä½œè€…ç°¡ä»‹ â†’ å‰µä½œèƒŒæ™¯ â†’ è©©è©å…§å®¹è§£æ â†’ å¿ƒç†å­¸/è…¦ç¥ç¶“å»¶ä¼¸ â†’ ç”Ÿæ´»é‹ç”¨ï¼ˆå¯è½åœ°ï¼‰â†’ 1000â€“1500 å­—ã€‚",
      ctaForSeries(c.series, c.purpose)
    ],
    "å¿ƒéˆæ„Ÿæ‚Ÿ": [
      "å£å»ï¼šå“²æ€ã€ç™¼äººæ·±çœã€æº«æŸ”æœ‰åŠ›é‡ã€‚",
      "æŠŠéˆæ„Ÿ/åŸæ–‡å»¶ä¼¸æˆ 1000â€“1500 å­—çŸ­æ–‡ï¼Œæœ€å¾Œçµ¦ 3 å€‹è½åœ°ç·´ç¿’ã€‚",
      ctaForSeries(c.series, c.purpose)
    ],
    "å¹¸ç¦å°è…¦è¢‹": [
      "å£å»ï¼šæ·ºé¡¯æ˜“æ‡‚ã€è¼•é¬†æ´»æ½‘ï¼Œé©åˆè¦ªå­å…±è®€ã€‚",
      "æŠŠä¸»é¡Œå»¶ä¼¸æˆ 800â€“1200 å­—æ•…äº‹ï¼‹å®¶é•·æé†’ 3 é»ã€‚",
      "CTAï¼šå¼•å°å®¶é•·åˆ°ä¸»é çœ‹å®Œæ•´ç³»åˆ—èˆ‡å·¥å…·ã€‚"
    ],
    "å…¶ä»–": [
      "å£å»ï¼šä¾è¼¸å…¥èª¿æ•´ã€‚",
      "è¼¸å‡ºï¼šå…ˆåšå¯ç”¨ç‰ˆæœ¬ï¼Œå†çµ¦ 3 ç¨®ä¸åŒé¢¨æ ¼è®Šé«”ã€‚"
    ]
  };

  const purposeHint =
    c.purpose==="æ›¸ç¨¿" ? "ã€ä½ è¦ç”¢å‡ºï¼šæ›¸ç¨¿ç‰ˆã€‘å¿…é ˆåŠ å…¥å¿ƒç†å­¸ï¼‹è…¦ç¥ç¶“ç§‘å­¸è§£æï¼Œä¸¦åœ¨å…¶åŸºç¤ä¸Šæå‡ºæ–¹æ³•èˆ‡å·¥å…·ï¼ˆå¯ç·´ç¿’ã€å¯æ•™å­¸ï¼‰ã€‚" :
    c.purpose==="èª²ç¨‹" ? "ã€ä½ è¦ç”¢å‡ºï¼šèª²ç¨‹ç‰ˆã€‘è«‹åšï¼šèª²ç¨‹ç›®æ¨™â†’å–®å…ƒæµç¨‹â†’è¬›ç¾©é‡é»â†’ç·´ç¿’â†’ä½œæ¥­â†’å·¥å…·ï¼ˆå¯åšæˆPWAç·´ç¿’ï¼‰ã€‚" :
    c.purpose==="èª²ç¨‹æ‰“åŒ…" ? "ã€ä½ è¦ç”¢å‡ºï¼šèª²ç¨‹æ‰“åŒ…ã€‘è«‹æ•´ç†ï¼šæ¨¡çµ„/å–®å…ƒ/è¬›ç¾©/ç·´ç¿’/ä½œæ¥­/å·¥å…·é€£çµ/éœ€è¦çš„ç´ ææ¸…å–®ã€‚" :
    c.purpose==="ç™¼ç‰‡æ‰“åŒ…" ? "ã€ä½ è¦ç”¢å‡ºï¼šç™¼ç‰‡æ‰“åŒ…ã€‘è«‹æ•´ç†ï¼šå½±ç‰‡ä»‹ç´¹ï¼ˆ100å­—å…§ï¼‰ï¼‹å·¥å…·é€£çµï¼‹Hashtagsï¼‹é è¨ˆç™¼ç‰‡æ—¥æœŸå»ºè­°ï¼‹å°é¢æ–‡å­—å»ºè­°ï¼ˆå¦‚éœ€ï¼‰ã€‚" :
    c.purpose==="é•·å½±ç‰‡å£èªªç¨¿" ? "ã€ä½ è¦ç”¢å‡ºï¼šé•·å½±ç‰‡å£èªªç¨¿ã€‘è«‹ â‰¥3000 å­—ï¼ˆè‹¥ç³»åˆ—è¨­å®šå…è¨±ï¼‰ï¼Œå« Hook/æ‰¿è«¾/æ­£æ–‡/CTAï¼ˆä¾è¦å‰‡ï¼‰ã€‚" :
    c.purpose==="çŸ­å½±ç‰‡" ? "ã€ä½ è¦ç”¢å‡ºï¼šçŸ­å½±ç‰‡ã€‘è«‹çµ¦ 3 ç§’ Hookï¼‹ä¸»é«” 30â€“45 ç§’ï¼‹æ”¶å°¾ CTAï¼ˆå¼•æµä¸»é ï¼‰ã€‚" :
    "ã€ä½ è¦ç”¢å‡ºï¼šPodcastã€‘è«‹çµ¦åˆ†æ®µå£æ¢ã€åœé “é»ã€ä»¥åŠå¯å£èªåŒ–çš„è½‰å ´å¥ã€‚";

  const prompt = [
    base,
    `ã€ç³»åˆ—ã€‘${c.series}`,
    `ã€ç”¨é€”ã€‘${c.purpose}`,
    `ã€ä¸»é¡Œã€‘${c.topic||"ï¼ˆæœªå¡«ï¼‰"}`,
    `ã€åŸæ–‡/ç´ æã€‘\n${c.body||"ï¼ˆæœªè²¼ï¼‰"}`,
    "",
    purposeHint,
    "",
    "ã€ç³»åˆ—å’’èªåŒ…ã€‘",
    ...(blocks[c.series] || blocks["å…¶ä»–"])
  ].join("\n");

  return prompt;
}

function buildPromoPrompt(){
  const p = state.data.promoDraft;
  const base = `ä½ æ˜¯ã€Œå¤©ä½¿ç¬‘é•·ã€çš„è¡ŒéŠ·æ–‡æ¡ˆå”ä½œå¤¥ä¼´ã€‚è«‹æŠŠæˆ‘æä¾›çš„ç´ æå¯«æˆå¯ç›´æ¥ç™¼å¸ƒçš„æ¨å»£æ–‡å®£ã€‚èªæ°£ï¼šæº«æš–ã€ä¿è½ã€æœ‰ç•«é¢ï¼›ä¸æ²¹ï¼›æŠŠåƒ¹å€¼è¬›æ¸…æ¥šã€‚`;

  const must = [
    "å¿…å‚™å…ƒç´ ï¼š",
    "1) ç—›é»æå•ï¼ˆä½ å®¶ä¹Ÿæœ‰â€¦ï¼Ÿï¼‰",
    "2) ä¸€å¥è©±å®šä½ï¼ˆé€™æ˜¯ä»€éº¼ã€å¹«èª°ã€è§£æ±ºä»€éº¼ï¼‰",
    "3) 3â€“5 å€‹äº®é»æ¢åˆ—ï¼ˆå¯å«è…¦ç§‘å­¸/è¡Œç‚ºè¨“ç·´/æˆå°±æ„Ÿï¼‰",
    "4) æ˜ç¢ºè¡Œå‹•æŒ‡ä»¤ï¼ˆé»é€£çµ/åŠ å…¥ä¸»ç•«é¢/çœ‹èªªæ˜ï¼‰",
    "5) äº’å‹•å¼•å°ï¼ˆç•™è¨€å¥/åˆ†äº«/ç§è¨Šï¼‰",
  ].join("\n");

  const variants = [
    "è«‹åŒä¸€ä»½å…§å®¹æä¾›ä»¥ä¸‹ç‰ˆæœ¬ï¼š",
    "A) FB é•·æ–‡ç‰ˆï¼šæœ‰æ•…äº‹ã€æœ‰é‹ªé™³ã€æœ‰æ¢åˆ—ã€æœ‰ CTA",
    "B) IG ç²¾ç°¡ç‰ˆï¼šçŸ­å¥ã€åˆ†è¡Œã€Emoji é©é‡ã€é‡é» 5 è¡Œå…§",
    "C) LINE ç¾¤çµ„ç‰ˆï¼šæ›´å£èªã€æ›´çŸ­ã€æ›´ç›´æ¥",
    "D) å®˜ç¶²ä»‹ç´¹ç‰ˆï¼šè¼ƒå®Œæ•´ï¼ˆå¯å« FAQ 3 é¡Œï¼‰",
  ].join("\n");

  return [
    base,
    `ã€é—œè¯å·¥å…·/å°ˆæ¡ˆã€‘${p.tool}`,
    `ã€ç³»åˆ—ã€‘${p.series}`,
    `ã€æ–‡å®£ç”¨é€”ã€‘${p.type}`,
    `ã€ç›®æ¨™å¹³å°ï¼ˆé€™æ¬¡ä¸»ç‰ˆæœ¬ï¼‰ã€‘${p.platform}`,
    `ã€æ¨™é¡Œ/ä¸»é¡Œã€‘${p.title||"ï¼ˆæœªå¡«ï¼‰"}`,
    `ã€é€£çµã€‘${p.links||"ï¼ˆæœªå¡«ï¼‰"}`,
    `ã€Hashtagsã€‘${p.tags||"ï¼ˆæœªå¡«ï¼‰"}`,
    `ã€äº’å‹•/CTAã€‘${p.cta||"ï¼ˆæœªå¡«ï¼‰"}`,
    "",
    "ã€ç´ æ/è‰ç¨¿ã€‘",
    p.body||"ï¼ˆæœªè²¼ï¼‰",
    "",
    must,
    "",
    variants,
    "",
    "è¼¸å‡ºæ ¼å¼ï¼šå…ˆçµ¦ä¸»ç‰ˆæœ¬ï¼ˆå°æ‡‰ç›®æ¨™å¹³å°ï¼‰ï¼Œå†çµ¦ A/B/C/D å››ç‰ˆã€‚"
  ].join("\n");
}

/* ---------- cloud backup (Google Form POST) ---------- */
function isCloudReady(){
  return !!(state.cloud.formResponse && state.cloud.entryJson);
}
function cloudLog(msg){
  const el = $("cloudLog");
  if(!el) return;
  el.textContent = `[${new Date().toLocaleTimeString("zh-Hant",{hour12:false})}] ${msg}\n` + el.textContent;
}

async function postToGoogleForm(payload){
  const formBody = new URLSearchParams(payload).toString();
  await fetch(state.cloud.formResponse, {
    method: "POST",
    mode: "no-cors",
    headers: { "Content-Type":"application/x-www-form-urlencoded;charset=UTF-8" },
    body: formBody
  });
}

async function cloudBackup({test=false}={}){
  if(!isCloudReady()){
    toast("å…ˆè¨­å®šé›²ç«¯");
    $("dlgCloud").showModal();
    cloudLog("é›²ç«¯å°šæœªè¨­å®šï¼šè«‹å¡« formResponse + entryJsonã€‚");
    return;
  }

  // å…ˆä¿å­˜æœ¬æ©Ÿå†é€
  saveAll();

  const snapshot = JSON.stringify({
    exportedAt: nowISO(),
    data: state.data
  }, null, 0);

  const note = test
    ? `ã€æ¸¬è©¦é€å‡ºã€‘${new Date().toLocaleString("zh-Hant",{hour12:false})}`
    : `ã€æ­£å¼å‚™ä»½ã€‘${new Date().toLocaleString("zh-Hant",{hour12:false})}`;

  const payload = {};
  payload[state.cloud.entryJson] = snapshot;
  if(state.cloud.entryNote) payload[state.cloud.entryNote] = note;

  try{
    await postToGoogleForm(payload);
    if(!test){
      state.data.lastCloudAt = nowISO();
      state.data.updatedAt = nowISO();
      localStorage.setItem(LS_KEY, JSON.stringify({data:state.data}, null, 2));
      updatePills();
    }
    toast(test ? "æ¸¬è©¦å·²é€å‡º" : "å·²é›²ç«¯å‚™ä»½");
    cloudLog(test
      ? "æ¸¬è©¦é€å‡ºå®Œæˆï¼ˆno-cors ç„¡æ³•è®€å›å‚³ï¼›è«‹åˆ°è©¦ç®—è¡¨ç¢ºèªæ–°å¢ä¸€åˆ—ï¼‰ã€‚"
      : "å‚™ä»½é€å‡ºå®Œæˆï¼ˆno-corsï¼‰ã€‚");
  }catch(e){
    toast("é€å‡ºå¤±æ•—");
    cloudLog("é€å‡ºå¤±æ•—ï¼š" + e.message);
    alert("é›²ç«¯é€å‡ºå¤±æ•—ï¼š\n" + e.message + "\n\nå¸¸è¦‹åŸå› ï¼š\n- formResponse URL ä¸æ­£ç¢º\n- entry id ä¸æ­£ç¢º\n- ç¶²è·¯æˆ–ç€è¦½å™¨é™åˆ¶");
  }
}

function saveCloudCfg(){
  state.cloud.formResponse = $("cfgFormResponse").value.trim();
  state.cloud.entryJson = $("cfgEntryJson").value.trim();
  state.cloud.entryNote = $("cfgEntryNote").value.trim();
  localStorage.setItem(CLOUD_KEY, JSON.stringify(state.cloud, null, 2));
  updatePills();
  toast("å·²ä¿å­˜è¨­å®š");
  cloudLog("å·²ä¿å­˜é›²ç«¯è¨­å®šã€‚");
}
function resetCloudCfg(){
  if(!confirm("ç¢ºå®šæ¸…é™¤é›²ç«¯è¨­å®šï¼Ÿæ¸…é™¤å¾Œå°±ä¸èƒ½ä¸€éµå‚™ä»½ï¼Œç›´åˆ°ä½ å†å¡«ä¸€æ¬¡ã€‚")) return;
  state.cloud = {formResponse:"", entryJson:"", entryNote:""};
  localStorage.removeItem(CLOUD_KEY);
  $("cfgFormResponse").value = "";
  $("cfgEntryJson").value = "";
  $("cfgEntryNote").value = "";
  updatePills();
  toast("å·²æ¸…é™¤");
  cloudLog("å·²æ¸…é™¤é›²ç«¯è¨­å®šã€‚");
}

/* ---------- local export/import ---------- */
function exportJSON(){
  saveAll();
  const blob = new Blob([JSON.stringify({data:state.data, cloud:state.cloud}, null, 2)], {type:"application/json"});
  const a = document.createElement("a");
  a.href = URL.createObjectURL(blob);
  a.download = `angel-studio-full-backup-${new Date().toISOString().slice(0,10)}.json`;
  a.click();
  URL.revokeObjectURL(a.href);
  toast("å·²åŒ¯å‡º JSON");
}
function importJSON(file){
  const reader = new FileReader();
  reader.onload = ()=>{
    try{
      const obj = JSON.parse(reader.result);
      if(obj?.data){
        state.data = {...state.data, ...obj.data};
      }
      if(obj?.cloud){
        state.cloud = {...state.cloud, ...obj.cloud};
        localStorage.setItem(CLOUD_KEY, JSON.stringify(state.cloud, null, 2));
      }
      saveAll();
      render();
      toast("å·²åŒ¯å…¥å®Œæˆ");
    }catch(e){
      alert("JSON è§£æå¤±æ•—ï¼š" + e.message);
    }
  };
  reader.readAsText(file);
}

/* ---------- icon generator ---------- */
function drawIcon(size){
  const canvas=document.createElement("canvas");
  canvas.width=canvas.height=size;
  const ctx=canvas.getContext("2d");

  const grad=ctx.createLinearGradient(0,0,size,size);
  grad.addColorStop(0,"#0b3d2e");
  grad.addColorStop(1,"#082f24");
  ctx.fillStyle=grad; ctx.fillRect(0,0,size,size);

  ctx.fillStyle="rgba(240,160,75,.35)";
  ctx.beginPath(); ctx.arc(size*0.35,size*0.28,size*0.32,0,Math.PI*2); ctx.fill();

  ctx.fillStyle="rgba(255,255,255,.92)";
  ctx.beginPath();
  ctx.moveTo(size*0.22,size*0.62);
  ctx.quadraticCurveTo(size*0.35,size*0.36,size*0.56,size*0.38);
  ctx.quadraticCurveTo(size*0.42,size*0.44,size*0.35,size*0.58);
  ctx.quadraticCurveTo(size*0.55,size*0.52,size*0.74,size*0.40);
  ctx.quadraticCurveTo(size*0.62,size*0.60,size*0.44,size*0.68);
  ctx.quadraticCurveTo(size*0.33,size*0.73,size*0.22,size*0.62);
  ctx.fill();

  ctx.fillStyle="#f0a04b";
  ctx.beginPath(); ctx.arc(size*0.72,size*0.28,size*0.06,0,Math.PI*2); ctx.fill();

  ctx.fillStyle="rgba(255,255,255,.90)";
  ctx.font = `900 ${Math.round(size*0.10)}px system-ui, -apple-system, "Noto Sans TC"`;
  ctx.textAlign="center";
  ctx.fillText("å¤©ä½¿ç¬‘é•·", size*0.50, size*0.90);

  return canvas;
}
function downloadCanvas(canvas, filename){
  canvas.toBlob((blob)=>{
    const a=document.createElement("a");
    a.href=URL.createObjectURL(blob);
    a.download=filename;
    a.click();
    setTimeout(()=>URL.revokeObjectURL(a.href),1200);
  },"image/png");
}

/* ---------- render tabs ---------- */
function renderTabs(){
  const tabs=$("tabs");
  tabs.innerHTML="";
  TAB_ITEMS.forEach(t=>{
    const el=document.createElement("div");
    el.className="tab"+(state.tab===t.key?" active":"");
    el.textContent=t.name;
    el.onclick=()=>{ state.tab=t.key; render(); renderTabs(); };
    tabs.appendChild(el);
  });
}

/* ---------- materials (ç´ æåº«) ---------- */
function renderMaterials(){
  const q=(state.filters.materialsQuery||"").trim().toLowerCase();
  let items=state.data.materials.slice().sort((a,b)=> (b.updatedAt||b.createdAt).localeCompare(a.updatedAt||a.createdAt));
  if(q){
    items = items.filter(x=>{
      const blob = `${x.title} ${x.scene} ${x.feel} ${x.insight} ${x.tool} ${x.series}`.toLowerCase();
      return blob.includes(q);
    });
  }

  const draft = state._materialDraft || {
    id:"",
    title:"",
    scene:"",
    feel:"",
    insight:"",
    tool:"",
    series:"å¹¸ç¦æ•™é¤Š"
  };

  return `
  <div class="grid">
    <div class="card">
      <div class="hd">
        <div>
          <p class="title">ğŸ“š ç´ æåº«ï¼ˆç”Ÿå‘½æ•…äº‹ï¼‰</p>
          <p class="hint">ç´ æä¸æ˜¯ç¨¿ä»¶ï¼Œæ˜¯ã€Œæºé ­ã€ã€‚å…ˆå­˜çœŸå¯¦å ´æ™¯ï¼Œä¹‹å¾Œä¸€éµè½‰æˆå‰µä½œç´ æã€‚</p>
        </div>
        <div class="kbar">
          <button id="btnMatSave" class="ok">${draft.id ? "è¦†è“‹ä¿å­˜" : "ä¿å­˜ç´ æ"}</button>
          <button id="btnMatClear" class="ghost">æ¸…ç©ºè¡¨å–®</button>
        </div>
      </div>

      <div class="bd">
        <div class="row two">
          <div>
            <label>ç´ ææ¨™é¡Œï¼ˆå»ºè­°ä¸€å¥è©±å‘½åï¼‰</label>
            <input id="m_title" value="${escapeHtml(draft.title)}" placeholder="ä¾‹å¦‚ï¼šè¶…å¸‚è£¡è«‡é›¶ç”¨éŒ¢åƒ¹ç¢¼ï¼šå­©å­çš„ã€ç­‰ä¸€ä¸‹ã€">
          </div>
          <div>
            <label>é—œè¯ç³»åˆ—</label>
            <select id="m_series">
              ${SERIES.map(s=>`<option ${s===draft.series?"selected":""}>${s}</option>`).join("")}
            </select>
          </div>
        </div>

        <div class="row two">
          <div>
            <label>ç”Ÿå‘½å ´æ™¯ï¼ˆäº‹æƒ…æ€éº¼ç™¼ç”Ÿçš„ï¼‰</label>
            <textarea id="m_scene" placeholder="ä¾‹å¦‚ï¼šæ”¾å­¸å¾Œå»è¶…å¸‚â€¦">${escapeHtml(draft.scene)}</textarea>
          </div>
          <div>
            <label>ç•¶ä¸‹æ„Ÿå—ï¼ˆä½ /å­©å­çš„ç‹€æ…‹ï¼‰</label>
            <textarea id="m_feel" placeholder="ä¾‹å¦‚ï¼šæˆ‘æœ‰é»ç·Šå¼µã€å­©å­æƒ³è¦ä½†æ‹‰ä¸ä½â€¦">${escapeHtml(draft.feel)}</textarea>
          </div>
        </div>

        <div class="row two">
          <div>
            <label>ä½ æƒ³å‚³é”çš„æ´è¦‹ï¼ˆä½ å­¸åˆ°ä»€éº¼ï¼‰</label>
            <textarea id="m_insight" placeholder="ä¾‹å¦‚ï¼šä¸æ˜¯ç®¡ä½å­©å­ï¼Œæ˜¯é™ªä»–æŠŠå‰è»Šç³»çµ±è£å¥½â€¦">${escapeHtml(draft.insight)}</textarea>
          </div>
          <div>
            <label>é—œè¯å·¥å…·/ä½œå“ï¼ˆå¯é¸ï¼‰</label>
            <textarea id="m_tool" style="min-height:120px" placeholder="ä¾‹å¦‚ï¼šé›¶ç”¨éŒ¢ç·´åŠŸæˆ¿é€£çµã€æŸæ”¯å½±ç‰‡ã€æŸå€‹èª²ç¨‹">${escapeHtml(draft.tool)}</textarea>
          </div>
        </div>

        <div class="divider"></div>

        <div class="kbar">
          <button id="btnMatToCreate" class="primary">â¡ï¸ ä¸€éµå¸¶å…¥å‰µä½œå€ï¼ˆç•¶æ­£æ–‡ç´ æï¼‰</button>
          <button id="btnMatCopy" >è¤‡è£½æ­¤ç´ æ</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div>
          <p class="title">ğŸ—‚ ç´ ææœå°‹èˆ‡ç®¡ç†</p>
          <p class="hint">å¯æœå°‹æ¨™é¡Œ/å ´æ™¯/æ„Ÿå—/æ´è¦‹/å·¥å…·ã€‚é»ã€Œç·¨è¼¯ã€å³å¯å›å¡«åˆ°ä¸Šæ–¹è¡¨å–®ã€‚</p>
        </div>
      </div>
      <div class="bd">
        <div class="row two">
          <div>
            <label>æœå°‹ï¼ˆé—œéµå­—ï¼‰</label>
            <input id="m_query" value="${escapeHtml(state.filters.materialsQuery||"")}" placeholder="ä¾‹å¦‚ï¼šè¶…å¸‚ / é›¶ç”¨éŒ¢ / ç­‰ä¸€ä¸‹">
          </div>
          <div class="small" style="display:flex;align-items:flex-end">
            å°æŠ€å·§ï¼šä½ å¯«æ•…äº‹æ™‚å…ˆä¸Ÿç´ æåº«ï¼Œä¹‹å¾Œå†ç”¨å‰µä½œå€ç”¢å‡ºå£èªªç¨¿/æ›¸ç¨¿ã€‚
          </div>
        </div>

        <div class="divider"></div>

        <div class="list" id="matList">
          ${items.length===0 ? `<div class="small">ç›®å‰æ²’æœ‰ç´ æã€‚å…ˆåœ¨å·¦å´æ–°å¢ä¸€ç­†å§ã€‚</div>` : items.map(renderMaterialItem).join("")}
        </div>
      </div>
    </div>
  </div>`;
}

function renderMaterialItem(x){
  const time = fmt(x.updatedAt||x.createdAt);
  return `
    <div class="item" data-id="${escapeHtml(x.id)}">
      <div class="itemTop">
        <div>
          <div class="itemTitle">${escapeHtml(x.title||"(æœªå‘½åç´ æ)")}</div>
          <div class="badges">
            <span class="badge">${escapeHtml(x.series||"")}</span>
            <span class="badge">æ›´æ–°ï¼š${escapeHtml(time)}</span>
          </div>
        </div>
        <div class="itemBtns">
          <button class="btnMatEdit">ç·¨è¼¯</button>
          <button class="btnMatUse primary">å¸¶å…¥å‰µä½œ</button>
          <button class="btnMatDel danger">åˆªé™¤</button>
        </div>
      </div>
      <div class="sectionSep"></div>
      <div class="mono">${escapeHtml((x.scene||"").slice(0, 360))}${(x.scene||"").length>360?"â€¦":""}</div>
    </div>
  `;
}

/* ---------- create (å‰µä½œå€) ---------- */
function renderCreate(){
  const c=state.data.create;
  c.prompt = buildCreatePrompt();
  const linked = c.linkMaterialId ? state.data.materials.find(m=>m.id===c.linkMaterialId) : null;

  return `
  <div class="grid">
    <div class="card">
      <div class="hd">
        <div>
          <p class="title">âœï¸ å‰µä½œå€ï¼ˆå£èªªç¨¿ / æ›¸ç¨¿ / èª²ç¨‹ / æ‰“åŒ…ï¼‰</p>
          <p class="hint">å…ˆè²¼åŸæ–‡/ç´ æ â†’ è¤‡è£½å’’èªåŒ… â†’ è®“ AI ç”¢å‡º â†’ å†è²¼å›ä¾† â†’ å¯å­˜æˆã€Œå®Œç¨¿ã€ã€‚</p>
          ${linked ? `<div class="small">å·²é€£çµç´ æï¼š<code class="inline">${escapeHtml(linked.title)}</code></div>` : ``}
        </div>
        <div class="kbar">
          <button id="btnCreateCopyAll">è¤‡è£½å…¨éƒ¨</button>
          <button id="btnCreateSaveFinal" class="ok">å­˜æˆå®Œç¨¿</button>
        </div>
      </div>

      <div class="bd">
        <div class="row three">
          <div>
            <label>ç³»åˆ—</label>
            <select id="c_series">${SERIES.map(s=>`<option ${s===c.series?"selected":""}>${s}</option>`).join("")}</select>
          </div>
          <div>
            <label>ç”¨é€”</label>
            <select id="c_purpose">${PURPOSE.map(s=>`<option ${s===c.purpose?"selected":""}>${s}</option>`).join("")}</select>
          </div>
          <div>
            <label>ä¸»é¡Œ</label>
            <input id="c_topic" value="${escapeHtml(c.topic)}" placeholder="ä¾‹å¦‚ï¼šç„¡æ¬²å‰‡å‰›ï½œé›¶ç”¨éŒ¢ç·´åŠŸæˆ¿">
          </div>
        </div>

        <div class="sectionSep"></div>

        <div class="row">
          <div>
            <label>åŸæ–‡/ç´ æï¼ˆæ•…äº‹å…¨æ–‡ã€æ›¸ç¨¿æ®µè½ã€å½±ç‰‡æ­£æ–‡ï¼‰</label>
            <textarea id="c_body" placeholder="è²¼é€²ä¾†...">${escapeHtml(c.body)}</textarea>
          </div>
        </div>

        <div class="divider"></div>

        <div class="row two">
          <div>
            <label>ğŸª„ å”ä½œæç¤ºï¼ˆå’’èªåŒ…ï¼‰</label>
            <textarea id="c_prompt" readonly>${escapeHtml(c.prompt)}</textarea>
            <div class="kbar" style="margin-top:8px">
              <button id="btnCreateCopyPrompt">è¤‡è£½å’’èªåŒ…</button>
              <button id="btnCreateSaveSpell" class="primary">æ”¶è—æˆå’’èª</button>
            </div>
          </div>

          <div>
            <label>ğŸ§© ç”¢å‡ºå€ï¼ˆAI ç”Ÿæˆå¾Œè²¼å›ä¾†ï¼‰</label>
            <textarea id="c_output" placeholder="æŠŠ AI ç”¢å‡ºè²¼åœ¨é€™è£¡...">${escapeHtml(c.output)}</textarea>
            <div class="kbar" style="margin-top:8px">
              <button id="btnCreateCopyOut">è¤‡è£½ç”¢å‡º</button>
              <button id="btnCreateClearOut" class="danger">æ¸…ç©ºç”¢å‡º</button>
            </div>
          </div>
        </div>

        <div class="divider"></div>

        <div class="small">
          å°æé†’ï¼šè‹¥ä½ è¦åšã€Œç™¼ç‰‡æ‰“åŒ…ã€ï¼Œè«‹åˆ°ã€Œç™¼ç‰‡æ‰“åŒ…ã€åˆ†é å»ºç«‹ä¸€ç­†ï¼ˆä¹‹å¾Œå¯è¤‡ç”¨ï¼‰ã€‚
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div>
          <p class="title">ğŸ§­ å¿«æ·</p>
          <p class="hint">å¸¸ç”¨å‹•ç·šï¼šç´ æåº« â†’ å‰µä½œå€ â†’ å®Œç¨¿åº« â†’ ç™¼ç‰‡æ‰“åŒ…/æ–‡å®£åº« â†’ é›²ç«¯å‚™ä»½</p>
        </div>
      </div>
      <div class="bd">
        <div class="kbar">
          <button id="btnGoMaterials">å›ç´ æåº«</button>
          <button id="btnGoFinals">å»å®Œç¨¿åº«</button>
          <button id="btnGoPromo">å»æ–‡å®£åº«</button>
          <button id="btnGoPublish">å»ç™¼ç‰‡æ‰“åŒ…</button>
        </div>
        <div class="divider"></div>
        <div class="small">
          âœ… ä½ ç¾åœ¨ç•«é¢é¡¯ç¤ºã€Œæœªå•Ÿç”¨é›¢ç·š localStorageã€æ˜¯æ­£å¸¸çš„ï¼šä»£è¡¨è³‡æ–™ç›®å‰å­˜åœ¨æ‰‹æ©Ÿæœ¬æ©Ÿã€‚<br>
          è¦é¿å…æ›æ‰‹æ©Ÿæ¶ˆå¤±ï¼šè«‹å®šæœŸæŒ‰ <code class="inline">ğŸ“¦ åŒ¯å‡º JSON</code>ï¼Œæˆ–ç”¨ <code class="inline">â˜ï¸ ä¸€éµé›²ç«¯å‚™ä»½</code>ã€‚
        </div>
      </div>
    </div>
  </div>`;
}

/* ---------- finals (å®Œç¨¿åº«) ---------- */
function renderFinals(){
  const q=(state.filters.finalsQuery||"").trim().toLowerCase();
  let items=state.data.finals.slice().sort((a,b)=> (b.updatedAt||b.createdAt).localeCompare(a.updatedAt||a.createdAt));
  if(q){
    items = items.filter(x=>{
      const blob = `${x.series} ${x.purpose} ${x.topic} ${x.body} ${x.output}`.toLowerCase();
      return blob.includes(q);
    });
  }
  return `
  <div class="grid">
    <div class="card">
      <div class="hd">
        <div>
          <p class="title">âœ… å®Œç¨¿åº«</p>
          <p class="hint">æŠŠå‰µä½œå€çš„ã€Œç”¢å‡ºã€å­˜é€²ä¾†ï¼Œä¹‹å¾Œè¦æ”¹ç¨¿ã€è¦æ‰“åŒ…ã€è¦åšæ–‡å®£ï¼Œéƒ½å¯ä»¥å›ä¾†æ‰¾ã€‚</p>
        </div>
        <div class="kbar">
          <button id="btnFinalsCopyAll">è¤‡è£½ç›®å‰é é¢æ¸…å–®ï¼ˆæ‘˜è¦ï¼‰</button>
        </div>
      </div>

      <div class="bd">
        <div class="row two">
          <div>
            <label>æœå°‹ï¼ˆé—œéµå­—ï¼‰</label>
            <input id="f_query" value="${escapeHtml(state.filters.finalsQuery||"")}" placeholder="ä¾‹å¦‚ï¼šç„¡æ¬²å‰‡å‰› / é›¶ç”¨éŒ¢ / ç­‰ä¸€ä¸‹">
          </div>
          <div class="small" style="display:flex;align-items:flex-end">
            æé†’ï¼šå®Œç¨¿ä¸æ˜¯ç´ æï¼›å®Œç¨¿æ˜¯ã€Œå¯ä»¥ç”¨çš„æˆå“ã€ï¼Œé©åˆå›æ”¶å†åˆ©ç”¨ã€‚
          </div>
        </div>

        <div class="divider"></div>

        <div class="list" id="finalList">
          ${items.length===0 ? `<div class="small">ç›®å‰æ²’æœ‰å®Œç¨¿ã€‚åˆ°ã€Œå‰µä½œå€ã€æŒ‰ã€Œå­˜æˆå®Œç¨¿ã€å³å¯ã€‚</div>` : items.map(renderFinalItem).join("")}
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div>
          <p class="title">ğŸ§© å¿«é€Ÿæ“ä½œ</p>
          <p class="hint">é»ã€Œå¸¶å›å‰µä½œã€â†’ ä½ å°±èƒ½åœ¨å‰µä½œå€ç¹¼çºŒæ”¹æˆ–å†ç”Ÿæˆæ–°ç‰ˆæœ¬ã€‚</p>
        </div>
      </div>
      <div class="bd">
        <div class="small">
          âœ… ä½ è¦åšã€Œæ´»å‹•æ–‡å®£ã€ï¼šå¾å®Œç¨¿æŠ½äº®é» â†’ å»æ–‡å®£åº«ç”Ÿæˆ FB/IG/LINE/å®˜ç¶²å››ç‰ˆã€‚<br>
          âœ… ä½ è¦åšã€Œç™¼ç‰‡æ‰“åŒ…ã€ï¼šå¾å®Œç¨¿è¤‡è£½æ®µè½ â†’ å»ç™¼ç‰‡æ‰“åŒ…åº«å¡«ä¸€ç­†ã€‚<br>
        </div>
      </div>
    </div>
  </div>`;
}
function renderFinalItem(x){
  const time=fmt(x.updatedAt||x.createdAt);
  return `
    <div class="item" data-id="${escapeHtml(x.id)}">
      <div class="itemTop">
        <div>
          <div class="itemTitle">${escapeHtml(x.topic||"(æœªå‘½åå®Œç¨¿)")}</div>
          <div class="badges">
            <span class="badge">${escapeHtml(x.series||"")}</span>
            <span class="badge">${escapeHtml(x.purpose||"")}</span>
            <span class="badge">æ›´æ–°ï¼š${escapeHtml(time)}</span>
          </div>
        </div>
        <div class="itemBtns">
          <button class="btnFinalUse primary">å¸¶å›å‰µä½œ</button>
          <button class="btnFinalCopy">è¤‡è£½</button>
          <button class="btnFinalDel danger">åˆªé™¤</button>
        </div>
      </div>
      <div class="sectionSep"></div>
      <div class="mono">${escapeHtml((x.output||"").slice(0, 520))}${(x.output||"").length>520?"â€¦":""}</div>
    </div>
  `;
}

/* ---------- promo (æ–‡å®£åº«) ---------- */
function renderPromo(){
  const p=state.data.promoDraft;
  p.prompt = buildPromoPrompt();

  const q=(state.filters.promoQuery||"").trim().toLowerCase();
  const filterTool=state.filters.promoTool||"å…¨éƒ¨";
  const filterSeries=state.filters.promoSeries||"å…¨éƒ¨";
  const filterType=state.filters.promoType||"å…¨éƒ¨";

  let items=state.data.promos.slice().sort((a,b)=> (b.updatedAt||b.createdAt).localeCompare(a.updatedAt||a.createdAt));
  if(filterTool!=="å…¨éƒ¨") items=items.filter(x=>x.tool===filterTool);
  if(filterSeries!=="å…¨éƒ¨") items=items.filter(x=>x.series===filterSeries);
  if(filterType!=="å…¨éƒ¨") items=items.filter(x=>x.type===filterType);
  if(q){
    items = items.filter(x=>{
      const blob = `${x.tool} ${x.series} ${x.type} ${x.title} ${x.body} ${x.tags} ${x.links}`.toLowerCase();
      return blob.includes(q);
    });
  }

  const tools=Array.from(new Set(state.data.promos.map(x=>x.tool))).sort();

  return `
  <div class="grid">
    <div class="card">
      <div class="hd">
        <div>
          <p class="title">ğŸ“£ æ–‡å®£ï¼æ¨å»£å…§å®¹å‰µä½œ</p>
          <p class="hint">å»ºç«‹å¯é‡ç”¨çš„å®£å‚³è³‡ç”¢ï¼šåŒä¸€ä»½ç´ æä¸€éµè®Š FB/IG/LINE/å®˜ç¶²å››ç‰ˆã€‚</p>
        </div>
        <div class="kbar">
          <button id="btnPromoSave" class="ok">ä¿å­˜åˆ°æ–‡å®£åº«</button>
          <button id="btnPromoCopyAll">è¤‡è£½æ–‡å®£ï¼ˆå«å’’èªåŒ…ï¼‰</button>
        </div>
      </div>

      <div class="bd">
        <div class="row two">
          <div>
            <label>é—œè¯å·¥å…· / å°ˆæ¡ˆ</label>
            <input id="p_tool" value="${escapeHtml(p.tool)}" placeholder="ä¾‹å¦‚ï¼šå¹¸ç¦æ•™é¤Šï½œé›¶ç”¨éŒ¢ç·´åŠŸæˆ¿">
          </div>
          <div>
            <label>ç³»åˆ—</label>
            <select id="p_series">${SERIES.map(s=>`<option ${s===p.series?"selected":""}>${s}</option>`).join("")}</select>
          </div>
        </div>

        <div class="row three">
          <div>
            <label>æ–‡å®£ç”¨é€”</label>
            <select id="p_type">${PROMO_TYPE.map(s=>`<option ${s===p.type?"selected":""}>${s}</option>`).join("")}</select>
          </div>
          <div>
            <label>ç›®æ¨™å¹³å°ï¼ˆä¸»ç‰ˆæœ¬ï¼‰</label>
            <select id="p_platform">${PROMO_PLATFORM.map(s=>`<option ${s===p.platform?"selected":""}>${s}</option>`).join("")}</select>
          </div>
          <div>
            <label>æ¨™é¡Œ/ä¸»é¡Œ</label>
            <input id="p_title" value="${escapeHtml(p.title)}" placeholder="ä¾‹å¦‚ï¼šé›¶ç”¨éŒ¢ç·´åŠŸæˆ¿ï½œè©¦ç”¨æ´»å‹•ä»‹ç´¹æ–‡">
          </div>
        </div>

        <div class="row two">
          <div>
            <label>é€£çµï¼ˆå¯å¤šè¡Œï¼‰</label>
            <textarea id="p_links" style="min-height:90px" placeholder="è²¼å·¥å…·é€£çµã€æ•™å­¸é€£çµ...">${escapeHtml(p.links)}</textarea>
          </div>
          <div>
            <label>Hashtagsï¼ˆå¯å¤šè¡Œï¼‰</label>
            <textarea id="p_tags" style="min-height:90px" placeholder="#å¹¸ç¦æ•™é¤Š #é›¶ç”¨éŒ¢ç·´åŠŸæˆ¿">${escapeHtml(p.tags)}</textarea>
          </div>
        </div>

        <div class="row">
          <div>
            <label>æ–‡å®£å…§å®¹ï¼ˆè‰ç¨¿/å…¨æ–‡ï¼‰</label>
            <textarea id="p_body" placeholder="æŠŠä½ çš„æ–‡å®£è‰ç¨¿è²¼é€²ä¾†...">${escapeHtml(p.body)}</textarea>
          </div>
        </div>

        <div class="row">
          <div>
            <label>äº’å‹•/CTAï¼ˆç•™è¨€å¥ã€åˆ†äº«å¼•å°ç­‰ï¼‰</label>
            <input id="p_cta" value="${escapeHtml(p.cta)}" placeholder="ä¾‹å¦‚ï¼šç•™è¨€ã€ç†æ™ºéšŠé•·å ±åˆ°ï¼ã€ä¸€èµ·äº¤æµ">
          </div>
        </div>

        <div class="divider"></div>

        <div class="row two">
          <div>
            <label>ğŸª„ æ–‡å®£å’’èªåŒ…ï¼ˆæç¤ºï¼‰</label>
            <textarea id="p_prompt" readonly>${escapeHtml(p.prompt)}</textarea>
            <div class="kbar" style="margin-top:8px">
              <button id="btnPromoCopyPrompt">è¤‡è£½æ–‡å®£å’’èªåŒ…</button>
              <button id="btnPromoSaveSpell" class="primary">æ”¶è—æˆå’’èª</button>
            </div>
          </div>

          <div>
            <label>å¿«æ·æé†’</label>
            <div class="small">
              âœ… æ–‡å®£æ˜¯ã€Œå¯é‡ç™¼è³‡ç”¢ã€ï¼šæ¯æ¬¡åªæ”¹ 10% å°±èƒ½å†æ¨ä¸€æ¬¡ã€‚<br>
              âœ… å»ºè­°ï¼šæ¯æ¬¡ç™¼æ–‡å¾Œï¼ŒæŠŠè©²ç‰ˆæœ¬ä¿å­˜åˆ°æ–‡å®£åº«ï¼ˆæ–¹ä¾¿å›æ”¶ï¼‰ã€‚<br>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div>
          <p class="title">ğŸ—‚ æ–‡å®£å­˜æ”¾èˆ‡æœå°‹</p>
          <p class="hint">å¯ä¾å·¥å…·/ç³»åˆ—/ç”¨é€”ç¯©é¸ï¼Œä¸¦é—œéµå­—æœå°‹ï¼ˆä¸»é¡Œã€å…§æ–‡ã€æ¨™ç±¤éƒ½æœå¾—åˆ°ï¼‰ã€‚</p>
        </div>
      </div>

      <div class="bd">
        <div class="row two">
          <div>
            <label>æœå°‹ï¼ˆé—œéµå­—ï¼‰</label>
            <input id="p_query" value="${escapeHtml(state.filters.promoQuery||"")}" placeholder="ä¾‹å¦‚ï¼šè©¦ç”¨ / å…å®‰è£ / ç†æ™ºæ¶ˆè²»">
          </div>
          <div>
            <label>å·¥å…·ï¼ˆç¯©é¸ï¼‰</label>
            <select id="p_filterTool">
              <option>å…¨éƒ¨</option>
              ${tools.map(t=>`<option ${t===filterTool?"selected":""}>${escapeHtml(t)}</option>`).join("")}
            </select>
          </div>
        </div>

        <div class="row three">
          <div>
            <label>ç³»åˆ—</label>
            <select id="p_filterSeries">
              <option ${filterSeries==="å…¨éƒ¨"?"selected":""}>å…¨éƒ¨</option>
              ${SERIES.map(s=>`<option ${s===filterSeries?"selected":""}>${s}</option>`).join("")}
            </select>
          </div>
          <div>
            <label>æ–‡å®£ç”¨é€”</label>
            <select id="p_filterType">
              <option ${filterType==="å…¨éƒ¨"?"selected":""}>å…¨éƒ¨</option>
              ${PROMO_TYPE.map(s=>`<option ${s===filterType?"selected":""}>${s}</option>`).join("")}
            </select>
          </div>
          <div style="display:flex;align-items:flex-end;gap:8px;flex-wrap:wrap">
            <button id="btnPromoClear" class="ghost">æ¸…ç©ºç¯©é¸</button>
          </div>
        </div>

        <div class="divider"></div>

        <div class="list" id="promoList">
          ${items.length===0 ? `<div class="small">ç›®å‰æ²’æœ‰ç¬¦åˆçš„æ–‡å®£ã€‚ä½ å¯ä»¥å…ˆã€Œä¿å­˜åˆ°æ–‡å®£åº«ã€ã€‚</div>` : items.map(renderPromoItem).join("")}
        </div>
      </div>
    </div>
  </div>`;
}

function renderPromoItem(x){
  const time=fmt(x.updatedAt||x.createdAt);
  return `
    <div class="item" data-id="${escapeHtml(x.id)}">
      <div class="itemTop">
        <div>
          <div class="itemTitle">${escapeHtml(x.title||"(æœªå‘½åæ–‡å®£)")}</div>
          <div class="badges">
            <span class="badge">${escapeHtml(x.tool||"")}</span>
            <span class="badge">${escapeHtml(x.series||"")}</span>
            <span class="badge">${escapeHtml(x.type||"")}</span>
            <span class="badge">${escapeHtml(x.platform||"")}</span>
            <span class="badge">æ›´æ–°ï¼š${escapeHtml(time)}</span>
          </div>
        </div>
        <div class="itemBtns">
          <button class="btnPromoEdit">ç·¨è¼¯</button>
          <button class="btnPromoCopy">è¤‡è£½</button>
          <button class="btnPromoDel danger">åˆªé™¤</button>
        </div>
      </div>
      <div class="sectionSep"></div>
      <div class="mono">${escapeHtml((x.body||"").slice(0, 520))}${(x.body||"").length>520?"â€¦":""}</div>
    </div>
  `;
}

/* ---------- publish (ç™¼ç‰‡æ‰“åŒ…) ---------- */
function renderPublish(){
  const d=state.data.publishDraft;
  const q=(state.filters.publishQuery||"").trim().toLowerCase();
  let items=state.data.publishes.slice().sort((a,b)=> (b.updatedAt||b.createdAt).localeCompare(a.updatedAt||a.createdAt));
  if(q){
    items=items.filter(x=>{
      const blob = `${x.title} ${x.intro} ${x.hashtags} ${x.toolLinks} ${x.notes} ${x.date}`.toLowerCase();
      return blob.includes(q);
    });
  }

  return `
  <div class="grid">
    <div class="card">
      <div class="hd">
        <div>
          <p class="title">ğŸ“¦ ç™¼ç‰‡æ‰“åŒ…åº«</p>
          <p class="hint">ä¸€æ”¯å½±ç‰‡ä¸€ç­†ï¼šæ¨™é¡Œ/ä»‹ç´¹/hashtags/å·¥å…·é€£çµ/ä¸Šç‰‡æ—¥ã€‚ä¹‹å¾Œè¦å†æ¨åŒä¸€æ”¯å¾ˆçœåŠ›ã€‚</p>
        </div>
        <div class="kbar">
          <button id="btnPubSave" class="ok">ä¿å­˜æ‰“åŒ…</button>
          <button id="btnPubCopy">è¤‡è£½é€™ç­†æ‰“åŒ…</button>
          <button id="btnPubClear" class="ghost">æ¸…ç©ºè¡¨å–®</button>
        </div>
      </div>

      <div class="bd">
        <div class="row two">
          <div>
            <label>å½±ç‰‡æ¨™é¡Œ</label>
            <input id="pb_title" value="${escapeHtml(d.title)}" placeholder="ä¾‹å¦‚ï¼šç„¡æ¬²å‰‡å‰›ï½œå­©å­å­¸æœƒç­‰ä¸€ä¸‹ï¼Œä¸€è¼©å­é¸æ“‡åŠ›å°±é–‹å§‹é•·å‡ºä¾†">
          </div>
          <div>
            <label>é è¨ˆç™¼ç‰‡æ—¥ï¼ˆå¯ç©ºï¼‰</label>
            <input id="pb_date" value="${escapeHtml(d.date)}" placeholder="ä¾‹å¦‚ï¼š2026-01-10">
          </div>
        </div>

        <div class="row">
          <div>
            <label>å½±ç‰‡ä»‹ç´¹ï¼ˆå»ºè­° 100 å­—å…§ï¼Œå¯å¤šè¡Œï¼‰</label>
            <textarea id="pb_intro" style="min-height:90px" placeholder="è²¼ä½ çš„ 100 å­—ä»‹ç´¹...">${escapeHtml(d.intro)}</textarea>
          </div>
        </div>

        <div class="row two">
          <div>
            <label>Hashtags</label>
            <textarea id="pb_tags" style="min-height:90px">${escapeHtml(d.hashtags)}</textarea>
          </div>
          <div>
            <label>å·¥å…·/é€£çµï¼ˆå¯å¤šè¡Œï¼‰</label>
            <textarea id="pb_links" style="min-height:90px" placeholder="å·¥å…·é€£çµã€æ•™å­¸é€£çµã€è¡¨å–®...">${escapeHtml(d.toolLinks)}</textarea>
          </div>
        </div>

        <div class="row">
          <div>
            <label>å‚™è¨»ï¼ˆå°é¢å­—/ç•™è¨€å¼•å°/ç½®é ‚ç•™è¨€ï¼‰</label>
            <textarea id="pb_notes" style="min-height:90px">${escapeHtml(d.notes)}</textarea>
          </div>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div>
          <p class="title">ğŸ—‚ æœå°‹èˆ‡ç®¡ç†</p>
          <p class="hint">æœå°‹æ¨™é¡Œ/ä»‹ç´¹/hashtags/é€£çµ/å‚™è¨»ã€‚</p>
        </div>
      </div>

      <div class="bd">
        <div class="row two">
          <div>
            <label>æœå°‹ï¼ˆé—œéµå­—ï¼‰</label>
            <input id="pb_query" value="${escapeHtml(state.filters.publishQuery||"")}" placeholder="ä¾‹å¦‚ï¼šé›¶ç”¨éŒ¢ / æ¯é€±äº”æ›´æ–° / ç†æ™ºéšŠé•·">
          </div>
          <div class="small" style="display:flex;align-items:flex-end">
            å»ºè­°ï¼šæ¯æ”¯ç‰‡ä¸€ä¸Šç·šå°±å­˜ä¸€ç­†ï¼ŒåŠå¹´å¾Œä½ æœƒå¾ˆæ„Ÿè¬è‡ªå·±ã€‚
          </div>
        </div>

        <div class="divider"></div>

        <div class="list" id="pubList">
          ${items.length===0 ? `<div class="small">ç›®å‰æ²’æœ‰æ‰“åŒ…å…§å®¹ã€‚</div>` : items.map(renderPublishItem).join("")}
        </div>
      </div>
    </div>
  </div>`;
}

function renderPublishItem(x){
  const time=fmt(x.updatedAt||x.createdAt);
  return `
    <div class="item" data-id="${escapeHtml(x.id)}">
      <div class="itemTop">
        <div>
          <div class="itemTitle">${escapeHtml(x.title||"(æœªå‘½åæ‰“åŒ…)")}</div>
          <div class="badges">
            <span class="badge">æ—¥æœŸï¼š${escapeHtml(x.date||"â€”")}</span>
            <span class="badge">æ›´æ–°ï¼š${escapeHtml(time)}</span>
          </div>
        </div>
        <div class="itemBtns">
          <button class="btnPubLoad">è¼‰å…¥</button>
          <button class="btnPubCopy">è¤‡è£½</button>
          <button class="btnPubDel danger">åˆªé™¤</button>
        </div>
      </div>
      <div class="sectionSep"></div>
      <div class="mono">${escapeHtml((x.intro||"").slice(0, 360))}${(x.intro||"").length>360?"â€¦":""}</div>
    </div>
  `;
}

/* ---------- spells (å’’èªåŒ…åº«) ---------- */
function renderSpells(){
  const q=(state.filters.spellsQuery||"").trim().toLowerCase();
  const cat=state.filters.spellsCat||"å…¨éƒ¨";

  let items=state.data.spells.slice().sort((a,b)=> (b.updatedAt||b.createdAt).localeCompare(a.updatedAt||a.createdAt));
  if(cat!=="å…¨éƒ¨") items=items.filter(x=>x.category===cat);
  if(q){
    items=items.filter(x=>{
      const blob = `${x.title} ${x.category} ${x.content}`.toLowerCase();
      return blob.includes(q);
    });
  }

  const categories=Array.from(new Set(state.data.spells.map(x=>x.category))).filter(Boolean).sort();

  const draft=state._spellDraft || {id:"", title:"", category:"å‰µä½œ", content:""};

  return `
  <div class="grid">
    <div class="card">
      <div class="hd">
        <div>
          <p class="title">ğŸ§™ å’’èªåŒ…åº«ï¼ˆæç¤ºæ”¶è—ï¼‰</p>
          <p class="hint">æŠŠå¸¸ç”¨æç¤ºå­˜èµ·ä¾†ï¼šå‰µä½œæç¤ºã€æ–‡å®£æç¤ºã€èª²ç¨‹æç¤ºã€å›ºå®š CTA æ¨¡æ¿â€¦éƒ½å¯ä»¥ã€‚</p>
        </div>
        <div class="kbar">
          <button id="btnSpellSave" class="ok">${draft.id ? "è¦†è“‹ä¿å­˜" : "ä¿å­˜å’’èª"}</button>
          <button id="btnSpellClear" class="ghost">æ¸…ç©ºè¡¨å–®</button>
        </div>
      </div>

      <div class="bd">
        <div class="row two">
          <div>
            <label>å’’èªæ¨™é¡Œ</label>
            <input id="s_title" value="${escapeHtml(draft.title)}" placeholder="ä¾‹å¦‚ï¼šå¹¸ç¦æ•™é¤Šé•·ç‰‡ï½œæ¨™æº–çµæ§‹æç¤º">
          </div>
          <div>
            <label>åˆ†é¡</label>
            <input id="s_cat" value="${escapeHtml(draft.category)}" placeholder="ä¾‹å¦‚ï¼šå‰µä½œ / æ–‡å®£ / èª²ç¨‹ / CTA">
          </div>
        </div>

        <div class="row">
          <div>
            <label>å’’èªå…§å®¹</label>
            <textarea id="s_content" placeholder="è²¼ä½ çš„æç¤ºå…§å®¹...">${escapeHtml(draft.content)}</textarea>
          </div>
        </div>

        <div class="divider"></div>

        <div class="kbar">
          <button id="btnSpellCopy">è¤‡è£½æ­¤å’’èª</button>
          <button id="btnSpellToCreate" class="primary">â¡ï¸ è²¼åˆ°å‰µä½œå€æç¤ºæ¬„ï¼ˆæ‰‹å‹•ç”¨ï¼‰</button>
        </div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div>
          <p class="title">ğŸ—‚ æœå°‹èˆ‡ç®¡ç†</p>
          <p class="hint">å¯ä¾åˆ†é¡ç¯©é¸ã€é—œéµå­—æœå°‹ã€‚</p>
        </div>
      </div>

      <div class="bd">
        <div class="row two">
          <div>
            <label>æœå°‹ï¼ˆé—œéµå­—ï¼‰</label>
            <input id="s_query" value="${escapeHtml(state.filters.spellsQuery||"")}" placeholder="ä¾‹å¦‚ï¼šHook / 3000å­— / æ¯é€±äº”æ›´æ–°">
          </div>
          <div>
            <label>åˆ†é¡ï¼ˆç¯©é¸ï¼‰</label>
            <select id="s_filterCat">
              <option>å…¨éƒ¨</option>
              ${categories.map(c=>`<option ${c===cat?"selected":""}>${escapeHtml(c)}</option>`).join("")}
            </select>
          </div>
        </div>

        <div class="divider"></div>

        <div class="list" id="spellList">
          ${items.length===0 ? `<div class="small">ç›®å‰æ²’æœ‰å’’èªã€‚ä½ å¯ä»¥å¾å‰µä½œå€/æ–‡å®£åº«ä¸€éµæ”¶è—ã€‚</div>` : items.map(renderSpellItem).join("")}
        </div>
      </div>
    </div>
  </div>`;
}

function renderSpellItem(x){
  const time=fmt(x.updatedAt||x.createdAt);
  return `
    <div class="item" data-id="${escapeHtml(x.id)}">
      <div class="itemTop">
        <div>
          <div class="itemTitle">${escapeHtml(x.title||"(æœªå‘½åå’’èª)")}</div>
          <div class="badges">
            <span class="badge">${escapeHtml(x.category||"")}</span>
            <span class="badge">æ›´æ–°ï¼š${escapeHtml(time)}</span>
          </div>
        </div>
        <div class="itemBtns">
          <button class="btnSpellEdit">ç·¨è¼¯</button>
          <button class="btnSpellCopy">è¤‡è£½</button>
          <button class="btnSpellDel danger">åˆªé™¤</button>
        </div>
      </div>
      <div class="sectionSep"></div>
      <div class="mono">${escapeHtml((x.content||"").slice(0, 520))}${(x.content||"").length>520?"â€¦":""}</div>
    </div>
  `;
}

/* ---------- backup (è¨­å®š/å‚™ä»½) ---------- */
function renderBackup(){
  return `
  <div class="grid">
    <div class="card">
      <div class="hd">
        <div>
          <p class="title">ğŸ›¡ï¸ è¨­å®š/å‚™ä»½ï¼ˆæ›æ‰‹æ©Ÿæœ€ç©©ï¼‰</p>
          <p class="hint">å»ºè­°ç¿’æ…£ï¼šæ¯é€±ä¸€æ¬¡æˆ–æ¯æ¬¡å¤§æ”¹ç‰ˆ â†’ åŒ¯å‡º JSONï¼›å¹³å¸¸å¯«å®Œ â†’ ä¸€éµé›²ç«¯å‚™ä»½ã€‚</p>
        </div>
      </div>

      <div class="bd">
        <div class="kbar">
          <button id="btnBackupCloudCfg" class="primary">âš™ï¸ æ‰“é–‹é›²ç«¯è¨­å®š</button>
          <button id="btnBackupTestCloud" class="ok">é€å‡ºé›²ç«¯æ¸¬è©¦</button>
        </div>

        <div class="divider"></div>

        <div class="kbar">
          <button id="btnGen192">ç”Ÿæˆä¸¦ä¸‹è¼‰ icon-192.png</button>
          <button id="btnGen512">ç”Ÿæˆä¸¦ä¸‹è¼‰ icon-512.png</button>
        </div>

        <div class="divider"></div>

        <div class="small" style="line-height:1.7">
          âœ… Androidï¼šChrome â†’ å³ä¸Šã€Œâ‹®ã€â†’ <b>åŠ åˆ°ä¸»ç•«é¢</b><br>
          âœ… iPhoneï¼šSafari â†’ åˆ†äº« â†’ <b>åŠ å…¥ä¸»ç•«é¢</b><br><br>
          ï¼ˆæ­¤ç‰ˆå·²ä¾ä½ çš„è¦æ±‚ï¼š<b>ä¸é¡¯ç¤ºå®‰è£æŒ‰éˆ•</b>ï¼Œé¿å…å¹²æ“¾ã€‚ï¼‰
        </div>

        <div class="divider"></div>

        <label>è³‡æ–™æ¦‚æ³ï¼ˆå¿«ç…§ï¼‰</label>
        <div class="mono" id="snapshot" style="min-height:140px"></div>
      </div>
    </div>

    <div class="card">
      <div class="hd">
        <div>
          <p class="title">ğŸ“Œ ç³»çµ±ç‹€æ…‹</p>
          <p class="hint">Service Worker è¨»å†Šç‹€æ…‹èˆ‡ç°¡æ˜“ç´€éŒ„ã€‚</p>
        </div>
      </div>
      <div class="bd">
        <div class="mono" id="sysLog" style="min-height:180px"></div>
      </div>
    </div>
  </div>`;
}

/* ---------- main render ---------- */
function render(){
  const v=$("view");
  if(state.tab==="materials") v.innerHTML = renderMaterials();
  if(state.tab==="create") v.innerHTML = renderCreate();
  if(state.tab==="finals") v.innerHTML = renderFinals();
  if(state.tab==="promo") v.innerHTML = renderPromo();
  if(state.tab==="publish") v.innerHTML = renderPublish();
  if(state.tab==="spells") v.innerHTML = renderSpells();
  if(state.tab==="backup") v.innerHTML = renderBackup();

  bindEvents();
  updatePills();

  // backup snapshot
  const snap=$("snapshot");
  if(snap){
    snap.textContent = JSON.stringify({
      updatedAt: state.data.updatedAt,
      lastCloudAt: state.data.lastCloudAt,
      counts: {
        materials: state.data.materials.length,
        finals: state.data.finals.length,
        promos: state.data.promos.length,
        publishes: state.data.publishes.length,
        spells: state.data.spells.length
      }
    }, null, 2);
  }
}

/* ---------- bind events per tab ---------- */
function bindEvents(){
  // Header buttons
  $("btnSaveAll").onclick = saveAll;

  $("btnExport").onclick = exportJSON;
  $("btnImport").onclick = ()=> $("fileImport").click();
  $("fileImport").onchange = (e)=>{
    const f=e.target.files?.[0];
    if(f) importJSON(f);
    e.target.value="";
  };

  $("btnCloud").onclick = ()=> cloudBackup();
  $("btnCloudCfg").onclick = ()=>{
    $("dlgCloud").showModal();
    // bind cfg fields
    $("cfgFormResponse").value = state.cloud.formResponse || "";
    $("cfgEntryJson").value = state.cloud.entryJson || "";
    $("cfgEntryNote").value = state.cloud.entryNote || "";
    $("cloudLog").textContent = "";
    cloudLog("é–‹å•Ÿé›²ç«¯è¨­å®šã€‚");
  };

  // Cloud dialog buttons
  if($("btnSaveCloudCfg")){
    $("btnSaveCloudCfg").onclick = (e)=>{ e.preventDefault(); saveCloudCfg(); };
    $("btnTestCloud").onclick = async (e)=>{ e.preventDefault(); saveCloudCfg(); cloudLog("é–‹å§‹é€å‡ºæ¸¬è©¦â€¦"); await cloudBackup({test:true}); };
    $("btnResetCloudCfg").onclick = (e)=>{ e.preventDefault(); resetCloudCfg(); };
  }

  // Tab: materials
  if(state.tab==="materials"){
    $("m_query").oninput = (e)=>{ state.filters.materialsQuery=e.target.value; render(); };

    $("btnMatClear").onclick = ()=>{
      state._materialDraft = {id:"",title:"",scene:"",feel:"",insight:"",tool:"",series:"å¹¸ç¦æ•™é¤Š"};
      render(); toast("å·²æ¸…ç©º");
    };

    $("btnMatCopy").onclick = ()=>{
      const text = [
        `ã€æ¨™é¡Œã€‘${$("m_title").value}`,
        `ã€ç³»åˆ—ã€‘${$("m_series").value}`,
        "",
        "ã€ç”Ÿå‘½å ´æ™¯ã€‘",
        $("m_scene").value,
        "",
        "ã€æ„Ÿå—ã€‘",
        $("m_feel").value,
        "",
        "ã€æ´è¦‹ã€‘",
        $("m_insight").value,
        "",
        "ã€é—œè¯å·¥å…·ã€‘",
        $("m_tool").value,
      ].join("\n");
      copyText(text);
    };

    $("btnMatToCreate").onclick = ()=>{
      const title=$("m_title").value.trim();
      const series=$("m_series").value;
      const body = [
        `ã€ç´ ææ¨™é¡Œã€‘${title||"(æœªå¡«)"}`,
        `ã€ç”Ÿå‘½å ´æ™¯ã€‘\n${$("m_scene").value||""}`,
        `\nã€æ„Ÿå—ã€‘\n${$("m_feel").value||""}`,
        `\nã€æ´è¦‹ã€‘\n${$("m_insight").value||""}`,
        `\nã€é—œè¯å·¥å…·ã€‘\n${$("m_tool").value||""}`,
      ].join("\n");

      state.data.create.series = series;
      state.data.create.topic = title || state.data.create.topic;
      state.data.create.body = body;
      // ç¶å®šç´ æ idï¼ˆè‹¥å­˜åœ¨ï¼‰
      if(state._materialDraft?.id) state.data.create.linkMaterialId = state._materialDraft.id;

      state.tab="create"; saveAll(); renderTabs(); render();
      toast("å·²å¸¶å…¥å‰µä½œå€");
    };

    $("btnMatSave").onclick = ()=>{
      const draft = state._materialDraft || {id:""};
      const obj = {
        id: draft.id || uid(),
        title: $("m_title").value.trim(),
        series: $("m_series").value,
        scene: $("m_scene").value,
        feel: $("m_feel").value,
        insight: $("m_insight").value,
        tool: $("m_tool").value,
        createdAt: draft.id ? (draft.createdAt || nowISO()) : nowISO(),
        updatedAt: nowISO()
      };

      if(draft.id){
        state.data.materials = state.data.materials.map(x=> x.id===draft.id ? {...x, ...obj} : x);
      }else{
        state.data.materials.push(obj);
      }

      state._materialDraft = {...obj};
      saveAll();
      render();
      toast(draft.id ? "å·²è¦†è“‹ä¿å­˜" : "å·²ä¿å­˜ç´ æ");
    };

    // list actions
    const list=$("matList");
    if(list){
      list.querySelectorAll(".item").forEach(el=>{
        const id=el.getAttribute("data-id");
        const item=state.data.materials.find(x=>x.id===id);
        if(!item) return;

        el.querySelector(".btnMatEdit").onclick = ()=>{
          state._materialDraft = {...item};
          render(); toast("å·²è¼‰å…¥å¯ç·¨è¼¯");
        };
        el.querySelector(".btnMatUse").onclick = ()=>{
          state._materialDraft = {...item};
          // reuse to-create logic
          $("btnMatToCreate").click();
        };
        el.querySelector(".btnMatDel").onclick = ()=>{
          if(!confirm("åˆªé™¤é€™ç­†ç´ æï¼Ÿ")) return;
          state.data.materials = state.data.materials.filter(x=>x.id!==id);
          if(state.data.create.linkMaterialId===id) state.data.create.linkMaterialId="";
          saveAll(); render(); toast("å·²åˆªé™¤");
        };
      });
    }
  }

  // Tab: create
  if(state.tab==="create"){
    const c=state.data.create;

    $("c_series").onchange = (e)=>{ c.series=e.target.value; c.prompt=buildCreatePrompt(); saveAll(); render(); };
    $("c_purpose").onchange = (e)=>{ c.purpose=e.target.value; c.prompt=buildCreatePrompt(); saveAll(); render(); };
    $("c_topic").oninput = (e)=>{ c.topic=e.target.value; c.prompt=buildCreatePrompt(); };
    $("c_body").oninput = (e)=>{ c.body=e.target.value; c.prompt=buildCreatePrompt(); };
    $("c_output").oninput = (e)=>{ c.output=e.target.value; };

    $("btnCreateCopyPrompt").onclick = ()=> copyText(buildCreatePrompt());
    $("btnCreateCopyOut").onclick = ()=> copyText(c.output||"");

    $("btnCreateClearOut").onclick = ()=>{
      if(confirm("æ¸…ç©ºç”¢å‡ºå€ï¼Ÿ")){ c.output=""; saveAll(); render(); }
    };

    $("btnCreateCopyAll").onclick = ()=>{
      const txt = [
        `ã€ç³»åˆ—ã€‘${c.series}`,
        `ã€ç”¨é€”ã€‘${c.purpose}`,
        `ã€ä¸»é¡Œã€‘${c.topic}`,
        "",
        "ã€åŸæ–‡/ç´ æã€‘",
        c.body,
        "",
        "ã€å”ä½œæç¤ºã€‘",
        buildCreatePrompt(),
        "",
        "ã€ç”¢å‡ºã€‘",
        c.output,
      ].join("\n");
      copyText(txt);
    };

    $("btnCreateSaveFinal").onclick = ()=>{
      const item = {
        id: uid(),
        series: c.series,
        purpose: c.purpose,
        topic: c.topic || "(æœªå¡«ä¸»é¡Œ)",
        body: c.body || "",
        output: c.output || "",
        createdAt: nowISO(),
        updatedAt: nowISO()
      };
      state.data.finals.push(item);
      saveAll();
      toast("å·²å­˜æˆå®Œç¨¿");
      state.tab="finals"; renderTabs(); render();
    };

    $("btnCreateSaveSpell").onclick = ()=>{
      const s = {
        id: uid(),
        title: `${c.series}ï½œ${c.purpose}ï½œå”ä½œæç¤º`,
        category: "å‰µä½œ",
        content: buildCreatePrompt(),
        createdAt: nowISO(),
        updatedAt: nowISO()
      };
      state.data.spells.push(s);
      saveAll();
      toast("å·²æ”¶è—å’’èª");
    };

    $("btnGoMaterials").onclick = ()=>{ state.tab="materials"; renderTabs(); render(); };
    $("btnGoFinals").onclick = ()=>{ state.tab="finals"; renderTabs(); render(); };
    $("btnGoPromo").onclick = ()=>{ state.tab="promo"; renderTabs(); render(); };
    $("btnGoPublish").onclick = ()=>{ state.tab="publish"; renderTabs(); render(); };
  }

  // Tab: finals
  if(state.tab==="finals"){
    $("f_query").oninput = (e)=>{ state.filters.finalsQuery=e.target.value; render(); };

    $("btnFinalsCopyAll").onclick = ()=>{
      const txt = state.data.finals.map(x=>`- ${x.topic}ï½œ${x.series}ï½œ${x.purpose}ï½œ${fmt(x.updatedAt||x.createdAt)}`).join("\n");
      copyText(txt || "(ç›®å‰æ²’æœ‰å®Œç¨¿)");
    };

    const list=$("finalList");
    if(list){
      list.querySelectorAll(".item").forEach(el=>{
        const id=el.getAttribute("data-id");
        const item=state.data.finals.find(x=>x.id===id);
        if(!item) return;

        el.querySelector(".btnFinalCopy").onclick = ()=>{
          const txt = [
            `ã€ä¸»é¡Œã€‘${item.topic}`,
            `ã€ç³»åˆ—ã€‘${item.series}`,
            `ã€ç”¨é€”ã€‘${item.purpose}`,
            "",
            "ã€åŸæ–‡ã€‘",
            item.body,
            "",
            "ã€å®Œç¨¿ã€‘",
            item.output
          ].join("\n");
          copyText(txt);
        };

        el.querySelector(".btnFinalUse").onclick = ()=>{
          state.data.create.series=item.series;
          state.data.create.purpose=item.purpose;
          state.data.create.topic=item.topic;
          state.data.create.body=item.body;
          state.data.create.output=item.output;
          state.data.create.linkMaterialId="";
          saveAll();
          state.tab="create"; renderTabs(); render();
          toast("å·²å¸¶å›å‰µä½œå€");
        };

        el.querySelector(".btnFinalDel").onclick = ()=>{
          if(!confirm("åˆªé™¤é€™ç­†å®Œç¨¿ï¼Ÿ")) return;
          state.data.finals = state.data.finals.filter(x=>x.id!==id);
          saveAll(); render(); toast("å·²åˆªé™¤");
        };
      });
    }
  }

  // Tab: promo
  if(state.tab==="promo"){
    const p=state.data.promoDraft;

    $("p_tool").oninput=(e)=>{ p.tool=e.target.value; p.prompt=buildPromoPrompt(); };
    $("p_series").onchange=(e)=>{ p.series=e.target.value; p.prompt=buildPromoPrompt(); saveAll(); render(); };
    $("p_type").onchange=(e)=>{ p.type=e.target.value; p.prompt=buildPromoPrompt(); saveAll(); render(); };
    $("p_platform").onchange=(e)=>{ p.platform=e.target.value; p.prompt=buildPromoPrompt(); saveAll(); render(); };
    $("p_title").oninput=(e)=>{ p.title=e.target.value; p.prompt=buildPromoPrompt(); };
    $("p_links").oninput=(e)=>{ p.links=e.target.value; p.prompt=buildPromoPrompt(); };
    $("p_tags").oninput=(e)=>{ p.tags=e.target.value; p.prompt=buildPromoPrompt(); };
    $("p_body").oninput=(e)=>{ p.body=e.target.value; p.prompt=buildPromoPrompt(); };
    $("p_cta").oninput=(e)=>{ p.cta=e.target.value; p.prompt=buildPromoPrompt(); };

    $("btnPromoCopyPrompt").onclick=()=>copyText(buildPromoPrompt());

    $("btnPromoSave").onclick=()=>{
      const title=(p.title||"").trim() || `${p.tool}ï½œ${p.type}`;
      const item={
        id: uid(),
        tool: (p.tool||"").trim()||"ï¼ˆæœªå¡«å·¥å…·ï¼‰",
        series: p.series,
        type: p.type,
        platform: p.platform,
        title,
        body: p.body||"",
        links: p.links||"",
        tags: p.tags||"",
        cta: p.cta||"",
        createdAt: nowISO(),
        updatedAt: nowISO()
      };
      state.data.promos.push(item);
      saveAll(); render(); toast("å·²ä¿å­˜åˆ°æ–‡å®£åº«");
    };

    $("btnPromoCopyAll").onclick=()=>{
      const txt=[
        `ã€å·¥å…·/å°ˆæ¡ˆã€‘${p.tool}`,
        `ã€ç³»åˆ—ã€‘${p.series}`,
        `ã€ç”¨é€”ã€‘${p.type}`,
        `ã€å¹³å°ã€‘${p.platform}`,
        `ã€æ¨™é¡Œã€‘${p.title}`,
        "",
        "ã€é€£çµã€‘",
        p.links,
        "",
        "ã€Hashtagsã€‘",
        p.tags,
        "",
        "ã€æ–‡å®£å…§å®¹ã€‘",
        p.body,
        "",
        "ã€äº’å‹•/CTAã€‘",
        p.cta,
        "",
        "ã€æ–‡å®£å’’èªåŒ…ã€‘",
        buildPromoPrompt()
      ].join("\n");
      copyText(txt);
    };

    $("btnPromoSaveSpell").onclick=()=>{
      const s={
        id: uid(),
        title: `${p.series}ï½œæ–‡å®£æç¤ºï¼ˆFB/IG/LINE/å®˜ç¶²ï¼‰`,
        category:"æ–‡å®£",
        content: buildPromoPrompt(),
        createdAt: nowISO(),
        updatedAt: nowISO()
      };
      state.data.spells.push(s);
      saveAll(); toast("å·²æ”¶è—å’’èª");
    };

    $("p_query").oninput=(e)=>{ state.filters.promoQuery=e.target.value; render(); };
    $("p_filterTool").onchange=(e)=>{ state.filters.promoTool=e.target.value; render(); };
    $("p_filterSeries").onchange=(e)=>{ state.filters.promoSeries=e.target.value; render(); };
    $("p_filterType").onchange=(e)=>{ state.filters.promoType=e.target.value; render(); };
    $("btnPromoClear").onclick=()=>{
      state.filters.promoQuery="";
      state.filters.promoTool="å…¨éƒ¨";
      state.filters.promoSeries="å…¨éƒ¨";
      state.filters.promoType="å…¨éƒ¨";
      render();
    };

    const list=$("promoList");
    if(list){
      list.querySelectorAll(".item").forEach(el=>{
        const id=el.getAttribute("data-id");
        const item=state.data.promos.find(x=>x.id===id);
        if(!item) return;

        el.querySelector(".btnPromoCopy").onclick=()=>{
          const txt=[
            `ã€æ¨™é¡Œã€‘${item.title}`,
            `ã€å·¥å…·/å°ˆæ¡ˆã€‘${item.tool}`,
            `ã€ç³»åˆ—ã€‘${item.series}`,
            `ã€ç”¨é€”ã€‘${item.type}`,
            `ã€å¹³å°ã€‘${item.platform}`,
            "",
            "ã€æ–‡å®£å…§å®¹ã€‘",
            item.body,
            "",
            "ã€é€£çµã€‘",
            item.links,
            "",
            "ã€Hashtagsã€‘",
            item.tags,
            "",
            "ã€äº’å‹•/CTAã€‘",
            item.cta
          ].join("\n");
          copyText(txt);
        };

        el.querySelector(".btnPromoEdit").onclick=()=>{
          state.data.promoDraft = {
            tool:item.tool, series:item.series, type:item.type, platform:item.platform,
            title:item.title, body:item.body, tags:item.tags, links:item.links, cta:item.cta, prompt:""
          };
          saveAll(); render(); toast("å·²è¼‰å…¥è‰ç¨¿å¯ç·¨è¼¯");
        };

        el.querySelector(".btnPromoDel").onclick=()=>{
          if(!confirm("åˆªé™¤é€™ç­†æ–‡å®£ï¼Ÿ")) return;
          state.data.promos = state.data.promos.filter(x=>x.id!==id);
          saveAll(); render(); toast("å·²åˆªé™¤");
        };
      });
    }
  }

  // Tab: publish
  if(state.tab==="publish"){
    const d=state.data.publishDraft;

    $("pb_title").oninput=(e)=>{ d.title=e.target.value; };
    $("pb_date").oninput=(e)=>{ d.date=e.target.value; };
    $("pb_intro").oninput=(e)=>{ d.intro=e.target.value; };
    $("pb_tags").oninput=(e)=>{ d.hashtags=e.target.value; };
    $("pb_links").oninput=(e)=>{ d.toolLinks=e.target.value; };
    $("pb_notes").oninput=(e)=>{ d.notes=e.target.value; };

    $("btnPubClear").onclick=()=>{
      state.data.publishDraft={title:"",date:"",intro:"",hashtags:"#å¹¸ç¦æ•™é¤Š #å¤©ä½¿ç¬‘é•·",toolLinks:"",notes:""};
      saveAll(); render(); toast("å·²æ¸…ç©º");
    };

    $("btnPubCopy").onclick=()=>{
      const txt=[
        `ã€æ¨™é¡Œã€‘${d.title}`,
        `ã€æ—¥æœŸã€‘${d.date}`,
        "",
        "ã€ä»‹ç´¹ã€‘",
        d.intro,
        "",
        "ã€Hashtagsã€‘",
        d.hashtags,
        "",
        "ã€å·¥å…·/é€£çµã€‘",
        d.toolLinks,
        "",
        "ã€å‚™è¨»ã€‘",
        d.notes
      ].join("\n");
      copyText(txt);
    };

    $("btnPubSave").onclick=()=>{
      const item={
        id: uid(),
        title: d.title||"(æœªå¡«æ¨™é¡Œ)",
        date: d.date||"",
        intro: d.intro||"",
        hashtags: d.hashtags||"",
        toolLinks: d.toolLinks||"",
        notes: d.notes||"",
        createdAt: nowISO(),
        updatedAt: nowISO()
      };
      state.data.publishes.push(item);
      saveAll(); render(); toast("å·²ä¿å­˜æ‰“åŒ…");
    };

    $("pb_query").oninput=(e)=>{ state.filters.publishQuery=e.target.value; render(); };

    const list=$("pubList");
    if(list){
      list.querySelectorAll(".item").forEach(el=>{
        const id=el.getAttribute("data-id");
        const item=state.data.publishes.find(x=>x.id===id);
        if(!item) return;

        el.querySelector(".btnPubCopy").onclick=()=>{
          const txt=[
            `ã€æ¨™é¡Œã€‘${item.title}`,
            `ã€æ—¥æœŸã€‘${item.date}`,
            "",
            "ã€ä»‹ç´¹ã€‘",
            item.intro,
            "",
            "ã€Hashtagsã€‘",
            item.hashtags,
            "",
            "ã€å·¥å…·/é€£çµã€‘",
            item.toolLinks,
            "",
            "ã€å‚™è¨»ã€‘",
            item.notes
          ].join("\n");
          copyText(txt);
        };

        el.querySelector(".btnPubLoad").onclick=()=>{
          state.data.publishDraft={title:item.title,date:item.date,intro:item.intro,hashtags:item.hashtags,toolLinks:item.toolLinks,notes:item.notes};
          saveAll(); render(); toast("å·²è¼‰å…¥åˆ°è¡¨å–®");
        };

        el.querySelector(".btnPubDel").onclick=()=>{
          if(!confirm("åˆªé™¤é€™ç­†æ‰“åŒ…ï¼Ÿ")) return;
          state.data.publishes = state.data.publishes.filter(x=>x.id!==id);
          saveAll(); render(); toast("å·²åˆªé™¤");
        };
      });
    }
  }

  // Tab: spells
  if(state.tab==="spells"){
    $("s_query").oninput=(e)=>{ state.filters.spellsQuery=e.target.value; render(); };
    $("s_filterCat").onchange=(e)=>{ state.filters.spellsCat=e.target.value; render(); };

    $("btnSpellClear").onclick=()=>{
      state._spellDraft={id:"",title:"",category:"å‰µä½œ",content:""};
      render(); toast("å·²æ¸…ç©º");
    };

    $("btnSpellCopy").onclick=()=>{
      const txt=$("s_content").value||"";
      copyText(txt);
    };

    $("btnSpellToCreate").onclick=()=>{
      state.tab="create";
      renderTabs(); render();
      toast("å·²åˆ‡åˆ°å‰µä½œå€ï¼ˆå¯æ‰‹å‹•è²¼å…¥ä½¿ç”¨ï¼‰");
    };

    $("btnSpellSave").onclick=()=>{
      const draft=state._spellDraft || {id:""};
      const obj={
        id: draft.id || uid(),
        title: $("s_title").value.trim() || "(æœªå‘½åå’’èª)",
        category: $("s_cat").value.trim() || "å…¶ä»–",
        content: $("s_content").value || "",
        createdAt: draft.id ? (draft.createdAt||nowISO()) : nowISO(),
        updatedAt: nowISO()
      };

      if(draft.id){
        state.data.spells = state.data.spells.map(x=> x.id===draft.id ? {...x, ...obj} : x);
      }else{
        state.data.spells.push(obj);
      }
      state._spellDraft = {...obj};
      saveAll(); render(); toast(draft.id ? "å·²è¦†è“‹ä¿å­˜" : "å·²ä¿å­˜å’’èª");
    };

    const list=$("spellList");
    if(list){
      list.querySelectorAll(".item").forEach(el=>{
        const id=el.getAttribute("data-id");
        const item=state.data.spells.find(x=>x.id===id);
        if(!item) return;

        el.querySelector(".btnSpellCopy").onclick=()=> copyText(item.content||"");
        el.querySelector(".btnSpellEdit").onclick=()=>{
          state._spellDraft={...item};
          render(); toast("å·²è¼‰å…¥å¯ç·¨è¼¯");
        };
        el.querySelector(".btnSpellDel").onclick=()=>{
          if(!confirm("åˆªé™¤é€™å‰‡å’’èªï¼Ÿ")) return;
          state.data.spells = state.data.spells.filter(x=>x.id!==id);
          saveAll(); render(); toast("å·²åˆªé™¤");
        };
      });
    }
  }

  // Tab: backup
  if(state.tab==="backup"){
    $("btnBackupCloudCfg").onclick=()=> $("btnCloudCfg").click();
    $("btnBackupTestCloud").onclick=async ()=>{ $("btnCloudCfg").click(); saveCloudCfg(); await cloudBackup({test:true}); };

    $("btnGen192").onclick=()=>{ downloadCanvas(drawIcon(192),"icon-192.png"); toast("å·²ä¸‹è¼‰ icon-192.png"); };
    $("btnGen512").onclick=()=>{ downloadCanvas(drawIcon(512),"icon-512.png"); toast("å·²ä¸‹è¼‰ icon-512.png"); };

    const sys=$("sysLog");
    if(sys){
      sys.textContent =
        `ServiceWorker: ${("serviceWorker" in navigator) ? "supported" : "not supported"}\n` +
        `CloudReady: ${isCloudReady()}\n` +
        `LastLocal: ${fmt(state.data.updatedAt)}\n` +
        `LastCloud: ${fmt(state.data.lastCloudAt)}\n`;
    }
  }
}

/* ---------- init ---------- */
function init(){
  loadAll();
  renderTabs();
  render();
  updatePills();

  // register service worker
  if("serviceWorker" in navigator){
    window.addEventListener("load", async ()=>{
      try{
        await navigator.serviceWorker.register("sw.js");
        // silent
      }catch(e){
        // silent
      }
    });
  }
}

// global tab click (initial)
renderTabs();
init();
</script>

</body>
  </html>
