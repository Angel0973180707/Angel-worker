<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0f3d2e" />
  <title>å¤©ä½¿ç¬‘é•·ï½œå‰µä½œå·¥ä½œå®¤ï¼ˆPWA v1.0ï¼‰</title>
  <link rel="manifest" href="manifest.json" />

  <style>
    :root{
      --bg:#0b2f24; --bg2:#0f3d2e; --card:#ffffff; --muted:#e7efe9;
      --text:#0b1b14; --sub:#51625a; --brand:#f0a04b; --danger:#c0392b; --ok:#1f7a52;
      --shadow:0 10px 30px rgba(0,0,0,.18); --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(240,160,75,.25), transparent 60%),
                  linear-gradient(180deg, var(--bg), #071e17 80%);
      color:var(--muted);
    }
    header{position:sticky; top:0; z-index:10;
      background: linear-gradient(180deg, rgba(11,47,36,.96), rgba(11,47,36,.75));
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .wrap{max-width:1120px;margin:0 auto;padding:16px;}
    .top{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .brand{display:flex; align-items:center; gap:12px;}
    .brand .logo{
      width:44px;height:44px;border-radius:14px;display:grid;place-items:center;
      background: rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);font-weight:900;color:#fff;
    }
    .brand h1{font-size:16px;margin:0; letter-spacing:.3px}
    .brand p{margin:2px 0 0; font-size:12px; color:rgba(231,239,233,.78)}
    .pill{display:inline-flex; align-items:center; gap:8px;padding:10px 12px;border-radius:999px;
      background: rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);
      color:rgba(231,239,233,.9);font-size:12px;
    }
    .pill b{color:#fff}
    nav{display:flex; gap:8px; overflow:auto; padding:12px 0 4px;}
    .tab{
      border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.06);
      color:rgba(231,239,233,.88);padding:10px 12px;border-radius:999px;
      cursor:pointer; user-select:none;white-space:nowrap;font-size:13px;transition: .15s ease;
    }
    .tab:hover{transform: translateY(-1px)}
    .tab.active{background: rgba(240,160,75,.22);border-color: rgba(240,160,75,.45);color:#fff;}
    main{padding:18px 0 34px}
    .grid{display:grid; gap:14px}
    @media (min-width:900px){ .grid.two{grid-template-columns: 1.12fr .88fr} }
    .card{
      background: rgba(255,255,255,.95);color:var(--text);
      border-radius: var(--r);box-shadow: var(--shadow);
      border:1px solid rgba(255,255,255,.18);padding:16px;
    }
    .card h2{margin:0 0 8px; font-size:16px}
    .sub{color:var(--sub); font-size:12.5px; line-height:1.55}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1}
    label{display:block; font-size:12px; color:var(--sub); margin:8px 0 6px}
    input, select, textarea{
      width:100%; border-radius: 14px; border:1px solid rgba(0,0,0,.12);
      padding:11px 12px; font-size:14px; outline:none; background: #fff;
    }
    textarea{min-height:140px; resize:vertical; line-height:1.6}
    .btnbar{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    button{border:0; cursor:pointer; padding:10px 12px; border-radius: 14px; font-weight:800; font-size:13px;}
    .btn{background: var(--brand); color:#1f1204; box-shadow: 0 10px 18px rgba(240,160,75,.35);}
    .btn.secondary{background: #ecf4ef; color:#173326; border:1px solid rgba(0,0,0,.08); box-shadow:none;}
    .btn.danger{background: var(--danger); color:#fff}
    .btn.ghost{background: transparent; color:#173326; border:1px dashed rgba(0,0,0,.25);}
    .badge{display:inline-flex; align-items:center; padding:6px 10px; border-radius:999px;
      background: rgba(31,122,82,.10); color: var(--ok); font-weight:900; font-size:12px;
    }
    .badge.gray{background: rgba(0,0,0,.06); color:#3b4c44}
    .badge.orange{background: rgba(240,160,75,.18); color:#6c3b04}
    .hr{height:1px;background:rgba(0,0,0,.08);margin:14px 0}
    .list{display:grid; gap:10px}
    .item{border:1px solid rgba(0,0,0,.08); border-radius: 16px; padding:12px; background:#fff;}
    .itemhead{display:flex; justify-content:space-between; gap:10px; align-items:flex-start}
    .itemtitle{font-weight:900; font-size:14px; margin:0 0 2px}
    .meta{font-size:12px; color:var(--sub)}
    .tools{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .mini{padding:7px 10px; border-radius: 12px; background:#ecf4ef; border:1px solid rgba(0,0,0,.08);
      font-weight:900; font-size:12px; color:#173326;
    }
    .mini.warn{background: rgba(240,160,75,.18); border-color: rgba(240,160,75,.25)}
    .mini.danger{background: rgba(192,57,43,.12); border-color: rgba(192,57,43,.18); color:#7a1d14}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:12px; background: rgba(0,0,0,.06); padding:2px 6px; border-radius: 8px; border:1px solid rgba(0,0,0,.06);
    }
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background: rgba(0,0,0,.78); color:#fff; padding:10px 12px; border-radius: 999px;
      font-size:13px; opacity:0; pointer-events:none; transition: .2s ease; z-index:999;
    }
    .toast.show{opacity:1}
    .hint{border-left:4px solid rgba(240,160,75,.75); background: rgba(240,160,75,.10);
      padding:10px 12px; border-radius: 14px; color:#1f1204; font-size:13px; line-height:1.6;
    }
    .small{font-size:12px;color:var(--sub);line-height:1.55}
    .split{display:flex; gap:10px; flex-wrap:wrap}
    .split > *{flex:1}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}
    dialog{
      width:min(900px, 94vw);
      border:0; border-radius: 18px; padding:0; box-shadow: var(--shadow);
    }
    dialog::backdrop{background: rgba(0,0,0,.45)}
    .dlgHead{padding:14px 16px;background:#0f3d2e;color:#fff;border-radius: 18px 18px 0 0}
    .dlgBody{padding:14px 16px;background:#fff;color:#0b1b14}
    .dlgBody pre{white-space:pre-wrap; word-break:break-word; margin:0; line-height:1.7}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">å¹¸</div>
        <div>
          <h1>å¤©ä½¿ç¬‘é•·ï½œå‰µä½œå·¥ä½œå®¤ï¼ˆPWA v1.0ï¼‰</h1>
          <p>å’’èªåŒ… Ã— å”ä½œæç¤º Ã— è‰ç¨¿/å®Œç¨¿ Ã— ç™¼ç‰‡æ‰“åŒ… Ã— æ›¸ç¨¿/èª²ç¨‹æ¯æœ¬</p>
        </div>
      </div>
      <div class="pill"><span>ç‹€æ…‹ï¼š</span><b id="syncState">æœ¬æ©Ÿå„²å­˜</b><span class="kbd">localStorage</span></div>
    </div>
    <nav id="nav"></nav>
  </div>
</header>

<main class="wrap"><div id="view"></div></main>

<div class="toast" id="toast">å·²è¤‡è£½</div>

<dialog id="dlg">
  <div class="dlgHead">
    <div style="font-weight:900" id="dlgTitle">å…¨æ–‡</div>
    <div style="opacity:.85;font-size:12px" id="dlgMeta"></div>
  </div>
  <div class="dlgBody">
    <div class="btnbar" style="margin-top:0">
      <button class="btn secondary" id="dlgCopy">è¤‡è£½å…¨æ–‡</button>
      <button class="btn secondary" id="dlgCopyPrompt">è¤‡è£½å”ä½œæç¤º</button>
      <button class="btn ghost" id="dlgClose">é—œé–‰</button>
    </div>
    <div class="hr"></div>
    <pre id="dlgText"></pre>
  </div>
</dialog>

<script>
/* =========================
   v1.0ï¼šåŠŸèƒ½æ“´å……ç‰ˆï¼ˆä»ä¸æ”¹ç‰ˆæœ¬åç¨±ï¼‰
   ========================= */
const APP = { version:"v1.0", storageKey:"angel_studio_v1" };
const SERIES = ["å¹¸ç¦æ•™é¤Š","å¿ƒè…¦ç§‘å­¸","å¿ƒéˆæ„Ÿæ‚Ÿ","è©©è©äººç”Ÿ","å¹¸ç¦å°è…¦è¢‹","å…¶ä»–"];
const FORMATS = ["é•·å½±ç‰‡","çŸ­å½±ç‰‡","Podcast"];
const VIEWS = [
  { id:"create", label:"å‰µä½œå½±ç‰‡" },
  { id:"mother", label:"å¹¸ç¦æ•™é¤Šï½œæ¯æœ¬åº«ï¼ˆæ›¸Ã—èª²ï¼‰" },
  { id:"drafts", label:"æ–‡æ¡ˆè‰ç¨¿å€" },
  { id:"final",  label:"å®Œç¨¿å€" },
  { id:"pack",   label:"ç™¼ç‰‡æ‰“åŒ…å€" },
  { id:"settings", label:"è¨­å®šï¼å‚™ä»½" },
];

const SPELL = {
  "å¹¸ç¦æ•™é¤Š": {
    tone: "è¼•é¬†æº«é¦¨é™ªä¼´å£å»ï½œä¸èªªæ•™ï½œç«™åœ¨å®¶é•·èº«é‚Š",
    sections: ["é–‹å ´Hook","æ‰¿è«¾","å®Œæ•´æ•…äº‹","å¿ƒè…¦ç§‘å­¸è§£æ","å¥½ç”¨å·¥å…·ï¼ˆæ–¹æ³•ï¼‰","CTA"],
    ctaKeywords: "æŠŠå¿ƒç·´ç©©ã€å¤©ä½¿ç¬‘é•·ä¸»é ã€å¿ƒç†å­¸ã€è…¦ç¥ç¶“ç§‘å­¸ã€ç†è§£å’Œæ„›ã€é™ªä¼´ã€è¦ªå­ã€ä¸€èµ·æˆé•·ã€ä¸€èµ·æ¢è¨ã€åˆ†äº«ã€è®“æ›´å¤šå­©å­å®¶åº­å—æƒ ã€è¨‚é–±ã€ä¸éŒ¯éæ›´æ–°ã€æ¯é€±æ›´æ–°",
    ctaTemplate: "å¦‚æœä½ ä¹Ÿåœ¨ç·´ç¿’æŠŠå¿ƒç«™ç©©ï¼Œ\næ­¡è¿ä¾†åˆ°å¤©ä½¿ç¬‘é•·çš„ä¸»é ã€‚\né€™è£¡æœ‰å¿ƒç†å­¸ã€è…¦ç¥ç¶“ç§‘å­¸ã€å¿ƒéˆæˆé•·èˆ‡å¹¸ç¦æ•™é¤Šç³»åˆ—å…§å®¹ï¼Œ\né™ªä½ æŠŠå¿ƒï¼Œä¸€æ¬¡ä¸€æ¬¡æ”¾å›ä¸­é–“ã€‚\nï¼ˆæ¯é€±æ›´æ–°ï¼‰"
  },
  "å¿ƒè…¦ç§‘å­¸": {
    tone: "è¦ªæ°‘å¹½é»˜å£å»ï½œç”¨ç”Ÿæ´»æ¯”å–»èªªç§‘å­¸ï½œé™å°ˆæ¥­é–€æª»",
    sections: ["é–‹å ´Hook","æ‰¿è«¾","æ­£æ–‡ï¼ˆç™½è©±åŒ–ï¼Œ1000â€“2500å­—ï¼‰","CTA"],
    ctaKeywords: "ç†è§£ã€å¿ƒç©©å®šã€å¤©ä½¿ç¬‘é•·ç­–åŠƒå¿ƒç†å­¸è…¦ç¥ç¶“ç§‘å­¸ã€å¿ƒéˆæˆé•·ã€å¹¸ç¦æ•™é¤Šã€æ¯é€±æ›´æ–°",
    ctaTemplate: "å¦‚æœä½ ä¹Ÿå–œæ­¡ç”¨ç™½è©±æŠŠè…¦ç§‘å­¸èªªæ¸…æ¥šï¼Œ\næ­¡è¿åˆ°å¤©ä½¿ç¬‘é•·ä¸»é é€›é€›ã€‚\nå¿ƒç†å­¸Ã—è…¦ç¥ç¶“ç§‘å­¸Ã—å¿ƒéˆæˆé•·Ã—å¹¸ç¦æ•™é¤Šï¼Œ\né™ªä½ æŠŠç†è§£è®Šæˆç©©å®šã€‚ï¼ˆæ¯é€±æ›´æ–°ï¼‰"
  },
  "è©©è©äººç”Ÿ": {
    tone: "æ–‡é›…å“²å­¸å£å»ï½œæ²‰ç©©ç•™ç™½ï½œæ…¢æ…¢è®€",
    sections: ["é–‹å ´Hook","è©©è©ä½œè€…ç°¡ä»‹","è©©è©å‰µä½œèƒŒæ™¯","è©©è©å…¨æ–‡ï¼å…§å®¹","å¿ƒç†å­¸èˆ‡è…¦ç¥ç¶“å»¶ä¼¸","ç”Ÿæ´»å•é¡Œé‹ç”¨ï¼ˆ1000â€“1500å­—ï¼‰","CTA"],
    ctaKeywords: "å¿ƒè‡ªåœ¨ã€ç©©å®šã€å¤©ä½¿ç¬‘é•·ç­–åŠƒå¿ƒç†å­¸è…¦ç¥ç¶“ç§‘å­¸ã€å¿ƒéˆæˆé•·ã€å¹¸ç¦æ•™é¤Šã€æ¯é€±æ›´æ–°",
    ctaTemplate: "å¦‚æœä½ ä¹Ÿå–œæ­¡ç”¨è©©è©æŠŠå¿ƒæ…¢æ…¢æ”¾é¬†ï¼Œ\næ­¡è¿åˆ°å¤©ä½¿ç¬‘é•·ä¸»é ã€‚\nå¿ƒç†å­¸Ã—è…¦ç¥ç¶“ç§‘å­¸Ã—å¿ƒéˆæˆé•·Ã—å¹¸ç¦æ•™é¤Šï¼Œ\né™ªä½ æ´»å¾—æ›´è‡ªåœ¨ã€‚ï¼ˆæ¯é€±æ›´æ–°ï¼‰"
  },
  "å¿ƒéˆæ„Ÿæ‚Ÿ": {
    tone: "å“²æ€ã€ç™¼äººæ·±çœå£å»ï½œä¸æ€¥è‘—ä¸‹çµè«–ï½œå…è¨±ç•™ç™½",
    sections: ["éˆæ„Ÿé—œéµå­—ï¼ˆå»¶ä¼¸æˆ1000â€“1500å­—çŸ­æ–‡ï¼‰","CTA"],
    ctaKeywords: "å¿ƒè‡ªåœ¨ã€ç©©å®šã€å¤©ä½¿ç¬‘é•·ç­–åŠƒå¿ƒç†å­¸è…¦ç¥ç¶“ç§‘å­¸ã€å¿ƒéˆæˆé•·ã€å¹¸ç¦æ•™é¤Šã€æ¯é€±æ›´æ–°",
    ctaTemplate: "å¦‚æœä½ ä¹Ÿåœ¨ç·´ç¿’ä¸æ€¥è‘—è§£é‡‹ã€å…ˆæŠŠå¿ƒæ”¾å›ä¸­é–“ï¼Œ\næ­¡è¿åˆ°å¤©ä½¿ç¬‘é•·ä¸»é ã€‚\nå¿ƒç†å­¸Ã—è…¦ç¥ç¶“ç§‘å­¸Ã—å¿ƒéˆæˆé•·Ã—å¹¸ç¦æ•™é¤Šï¼Œ\né™ªä½ æ›´ç©©ã€æ›´è‡ªåœ¨ã€‚ï¼ˆæ¯é€±æ›´æ–°ï¼‰"
  },
  "å¹¸ç¦å°è…¦è¢‹": {
    tone: "æ·ºé¡¯æ˜“æ‡‚ï½œè¼•é¬†æ´»æ½‘å£å»ï½œè¦ªå­å…±è®€å‹å–„",
    sections: ["ä¸»é¡Œï¼ˆå»¶ä¼¸æˆ1000â€“1500å­—çŸ­æ–‡ï¼‰","çµ¦å®¶é•·çš„å°æé†’","å…±è®€æå•ï¼å°ç·´ç¿’","CTA"],
    ctaKeywords: "æé†’å®¶é•·ã€é™ªä¼´å…±è®€ã€å¤©ä½¿ç¬‘é•·",
    ctaTemplate: "æé†’å®¶é•·ï¼šé™ªå­©å­ä¸€èµ·è®€ã€ä¸€èµ·ç·´ï¼Œ\næ¯”ä½ è¬›ä¸€ç™¾å¥æ›´æœ‰ç”¨ã€‚\nâ€” å¤©ä½¿ç¬‘é•·"
  },
  "å…¶ä»–": {
    tone: "ä»¥ä½ ç•¶ä¸‹çš„èªæ„Ÿç‚ºä¸»ï½œä¿ç•™çœŸå¯¦ç¾å ´",
    sections: ["é–‹å ´","æ­£æ–‡","æ”¶æŸ","CTAï¼ˆå¯é¸ï¼‰"],
    ctaKeywords: "å¤©ä½¿ç¬‘é•·ä¸»é ã€ç†è§£ã€é™ªä¼´",
    ctaTemplate: "æƒ³çœ‹æ›´å¤šå…§å®¹ï¼Œæ­¡è¿åˆ°å¤©ä½¿ç¬‘é•·ä¸»é ã€‚"
  }
};

function nowISO(){ return new Date().toISOString(); }
function uid(){ return Math.random().toString(16).slice(2)+"-"+Date.now().toString(16); }
function fmtDate(iso){
  const d = new Date(iso);
  const pad = n => String(n).padStart(2,"0");
  return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function toast(msg="å·²å®Œæˆ"){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 1300);
}
async function copyText(text){
  try{ await navigator.clipboard.writeText(text); toast("å·²è¤‡è£½"); }
  catch(e){
    const ta = document.createElement("textarea");
    ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); ta.remove();
    toast("å·²è¤‡è£½ï¼ˆå‚™æ´ï¼‰");
  }
}

/* ===== å„²å­˜ ===== */
function loadState(){
  try{
    const raw = localStorage.getItem(APP.storageKey);
    if(!raw) return {
      entries:[],
      bookProjects:[],
      courseProjects:[],
      bookContent:[],     // {id,bookId,chapter,title,body,sourceEntryId,createdAt,updatedAt}
      courseContent:[],   // {id,courseId,module,unitTitle,story,insight,practice,takeaway,sourceEntryId,createdAt,updatedAt}
      settings:{homepage:"", lastSeries:"å¹¸ç¦æ•™é¤Š"}
    };
    return JSON.parse(raw);
  }catch(e){
    return {
      entries:[], bookProjects:[], courseProjects:[],
      bookContent:[], courseContent:[],
      settings:{homepage:"", lastSeries:"å¹¸ç¦æ•™é¤Š"}
    };
  }
}
function saveState(s){ localStorage.setItem(APP.storageKey, JSON.stringify(s)); }
let state = loadState();

/* ===== å°è¦½ ===== */
let current = "create";
function renderNav(){
  const nav = document.getElementById("nav");
  nav.innerHTML = VIEWS.map(v => `<div class="tab ${v.id===current?'active':''}" data-id="${v.id}">${v.label}</div>`).join("");
  nav.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click",()=>{ current=t.dataset.id; render(); });
  });
}

/* ===== å”ä½œæç¤º ===== */
function baseCollabPrompt(series, dir, entry){
  const sp = SPELL[series] || SPELL["å…¶ä»–"];
  const homepage = (state.settings.homepage||"").trim();
  const homeLine = homepage ? `\nä¸»é é€£çµï¼š${homepage}` : "";
  const dirMap = {
    "æ›¸ç¨¿":"è«‹æŠŠé€™æ®µå…§å®¹æ•´ç†æˆã€Šå¹¸ç¦æ•™é¤Šã€‹å¯å…¥æ›¸çš„æ›¸ç¨¿æ®µè½ï¼ˆç´„ 1500â€“2500 å­—ï¼‰ï¼Œæ•˜äº‹è¦æœ‰ç•«é¢ã€ç¯€å¥è‡ªç„¶ã€æ´å¯Ÿæº«æŸ”ç¯¤å®šã€‚è«‹ä¿ç•™æˆ‘çš„åŸå¥èˆ‡å£æ°£ã€‚",
    "èª²ç¨‹":"è«‹æŠŠé€™æ®µå…§å®¹è½‰åŒ–æˆä¸€å€‹èª²ç¨‹å–®å…ƒï¼šåŒ…å«ã€Œä¸€å€‹æ•…äº‹ / ä¸€å€‹ç†è§£ï¼ˆç™½è©±å¿ƒè…¦è½‰è­¯ï¼‰/ ä¸€å€‹ç·´ç¿’ï¼ˆ30â€“60ç§’å¯åšï¼‰/ ä¸€å¥å¸¶èµ°çš„è©±ã€ã€‚",
    "å·¥å…·":"è«‹å¾é€™æ®µå…§å®¹æ‰¾å‡ºã€æœ€éœ€è¦è¢«æ‰¶ä½çš„ç¬é–“ã€ï¼Œè¨­è¨ˆä¸€å€‹ 30â€“60 ç§’å…§å®Œæˆçš„å°å·¥å…·ï¼ˆæ­¥é©Ÿæ¸…æ¥šã€å¯ç•¶å ´ä½¿ç”¨ï¼‰ã€‚",
    "ç™¼ç‰‡":"è«‹æŠŠé€™æ®µå…§å®¹æ•´ç†æˆç™¼ç‰‡ç”¨çš„å¤§ç¶±ï¼šHook/æ‰¿è«¾/æ•…äº‹/ç†è§£/å·¥å…·æŒ‡è·¯/CTAã€‚ä¸è¦é€å­—å£èªªç¨¿ï¼Œåªè¦çµæ§‹èˆ‡è¦é»ã€‚"
  };
  return `è«‹ä¾ã€Œ${series}ã€ç³»åˆ—çš„æ–‡æ¡ˆå’’èªåŒ…å”åŠ©æˆ‘ã€‚
èªæ„Ÿï¼š${sp.tone}
å¿…é ˆä¿ç•™ç”Ÿæ´»ç¾å ´èˆ‡æˆ‘çš„çœŸå¯¦èªæ°£ï¼ˆä¸èªªæ•™ï¼‰ã€‚${homeLine}

ã€æˆ‘å¸Œæœ›ä½ å¹«æˆ‘åšçš„äº‹ã€‘
${dirMap[dir]||dirMap["æ›¸ç¨¿"]}

ã€ç³»åˆ—å’’èªçµæ§‹ã€‘
- ${sp.sections.join("\n- ")}

ã€CTA é—œéµå­—æ± ã€‘
${sp.ctaKeywords}

ã€ä¸»é¡Œã€‘
${entry.topic}

ã€åŸæ–‡ï¼ç´ æã€‘
${entry.body}

ã€è£œå……ã€‘
${entry.notes || "ï¼ˆç„¡ï¼‰"}`.trim();
}

function updateCollabPrompt(){
  const series = document.getElementById("series")?.value || state.settings.lastSeries || "å¹¸ç¦æ•™é¤Š";
  const entry = {
    topic:(document.getElementById("topic")?.value||"").trim(),
    body:(document.getElementById("body")?.value||"").trim(),
    notes:(document.getElementById("notes")?.value||"").trim(),
  };
  const dir = document.getElementById("collabDir")?.value || "æ›¸ç¨¿";
  const box = document.getElementById("collabPrompt");
  if(!box) return;
  box.value = baseCollabPrompt(series, dir, entry);
}

/* ===== Entries ===== */
function upsertEntry(payload){
  payload.updatedAt = nowISO();
  if(!payload.id){
    payload.id = uid();
    payload.createdAt = nowISO();
    state.entries.unshift(payload);
  }else{
    const idx = state.entries.findIndex(x=>x.id===payload.id);
    if(idx>=0) state.entries[idx] = {...state.entries[idx], ...payload};
    else { payload.createdAt = nowISO(); state.entries.unshift(payload); }
  }
  saveState(state);
}
function getEntryForm(){
  const series = document.getElementById("series").value;
  const format = document.getElementById("format").value;
  const topic = (document.getElementById("topic").value||"").trim();
  const body = (document.getElementById("body").value||"").trim();
  const notes = (document.getElementById("notes").value||"").trim();
  const collabDir = document.getElementById("collabDir").value;
  const id = (document.getElementById("entryId").value||"").trim();
  if(!topic) return alert("è«‹å…ˆå¡«ã€Œä¸»é¡Œã€"), null;
  if(!body) return alert("è«‹å…ˆå¡«ã€Œå…¨æ–‡ï¼æ•…äº‹ï¼æ­£æ–‡ã€"), null;
  return { id:id||"", series, format, topic, body, notes, collabDir };
}

function EntryCard(e){
  const isFinal = e.status==="final";
  const b = isFinal ? "badge" : "badge gray";
  const tag = isFinal ? "å®Œç¨¿" : "è‰ç¨¿";
  const dir = e.collabDir ? `<span class="badge orange">${escapeHtml(e.collabDir)}</span>` : "";
  const snippet = (e.body||"").slice(0,120).replace(/\n/g," ");
  return `
    <div class="item">
      <div class="itemhead">
        <div>
          <div class="itemtitle">${escapeHtml(e.topic)}</div>
          <div class="meta">${escapeHtml(e.series)}ï½œ${escapeHtml(e.format)}ï½œ${fmtDate(e.updatedAt||e.createdAt)}</div>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end">
          <span class="${b}">${tag}</span>${dir}
        </div>
      </div>
      <div class="small" style="margin-top:8px">${escapeHtml(snippet)}${(e.body||"").length>120?"â€¦":""}</div>
      <div class="tools">
        <button class="mini" data-action="open" data-id="${e.id}">é–‹å•Ÿå…¨æ–‡</button>
        <button class="mini" data-action="edit" data-id="${e.id}">ç·¨è¼¯</button>
        <button class="mini warn" data-action="toggle" data-id="${e.id}">${isFinal?"è½‰è‰ç¨¿":"è½‰å®Œç¨¿"}</button>
        <button class="mini danger" data-action="del" data-id="${e.id}">åˆªé™¤</button>
      </div>
    </div>`;
}

/* ===== Spell Card ===== */
function buildSpellCard(series){
  const sp = SPELL[series] || SPELL["å…¶ä»–"];
  const secs = sp.sections.map(s=>`<li>${escapeHtml(s)}</li>`).join("");
  return `
    <div class="card">
      <h2>ğŸª„ æ–‡æ¡ˆå’’èªåŒ…ï½œ${escapeHtml(series)}</h2>
      <div class="sub">${escapeHtml(sp.tone)}</div>
      <div class="hr"></div>
      <div class="split">
        <div>
          <div class="small"><b>çµæ§‹æé†’ï¼ˆä¾ç³»åˆ—ä¸åŒï¼‰</b></div>
          <ul class="small" style="margin:8px 0 0; padding-left:18px; line-height:1.7">${secs}</ul>
        </div>
        <div>
          <div class="small"><b>CTA é—œéµå­—æ± </b></div>
          <div class="small" style="margin-top:8px">${escapeHtml(sp.ctaKeywords)}</div>
          <div class="hr"></div>
          <div class="hint"><b>å°æé†’ï¼š</b>å…ˆå¯«çœŸå¯¦ï¼Œå†ç”¨å’’èªåŒ…æŠŠè·¯ç…§äº®ã€‚</div>
        </div>
      </div>
    </div>
  `;
}

/* ===== Views ===== */
function CreateView(){
  const last = state.settings.lastSeries || "å¹¸ç¦æ•™é¤Š";
  return `
  <div class="grid two">
    <div class="grid" style="gap:14px">
      <div class="card">
        <h2>ğŸ“ å‰µä½œå½±ç‰‡ï½œåŸæ–‡è¼¸å…¥</h2>
        <div class="sub">å…ˆå¯«çœŸå¯¦ï¼Œä¸ç”¨ä¸€æ¬¡å¯«å¥½ã€‚å¡ä½æ™‚ç”¨ã€Œå’’èªåŒ…ã€èˆ‡ã€Œå”ä½œæç¤ºã€æ‰¶ä½ èµ°å®Œã€‚</div>
        <input type="hidden" id="entryId" value="" />

        <div class="row">
          <div>
            <label>ç³»åˆ—åç¨±</label>
            <select id="series">
              ${SERIES.map(s=>`<option ${s===last?'selected':''}>${s}</option>`).join("")}
            </select>
          </div>
          <div>
            <label>ç‰‡å‹</label>
            <select id="format">${FORMATS.map(f=>`<option>${f}</option>`).join("")}</select>
          </div>
        </div>

        <label>ä¸»é¡Œ</label>
        <input id="topic" placeholder="ä¾‹ï¼šç„¡æ¬²å‰‡å‰›ï¼šå­©å­å­¸æœƒã€ç­‰ä¸€ä¸‹ã€ï¼Œé¸æ“‡åŠ›å°±é–‹å§‹é•·å‡ºä¾†" />

        <label>æ•…äº‹å…¨æ–‡ï¼è©©è©å…¨æ–‡ï¼æ­£æ–‡å…¨æ–‡</label>
        <textarea id="body" placeholder="æŠŠä½ èµ°éçš„ã€ç”Ÿå‘½ç¾å ´ã€è²¼é€²ä¾†å°±å¥½ã€‚"></textarea>

        <label>è£œå……ï¼ˆå¯é¸ï¼‰</label>
        <textarea id="notes" placeholder="ä¾‹å¦‚ï¼šè¦ä¿ç•™çš„åŸå¥ï¼ä½ æƒ³æ”¾é€²å“ªä¸€ç« å“ªä¸€èª²ï¼ä½ å¸Œæœ›åŠ å¼·çš„è§’åº¦â€¦"></textarea>

        <div class="hr"></div>

        <label>å”ä½œæ–¹å‘ï¼ˆä½ è¦æˆ‘å¹«ä½ èµ°åˆ°å“ªï¼‰</label>
        <select id="collabDir">
          <option>æ›¸ç¨¿</option><option>èª²ç¨‹</option><option>å·¥å…·</option><option>ç™¼ç‰‡</option>
        </select>

        <label>ä¸€éµå”ä½œæç¤ºï¼ˆè¤‡è£½è²¼çµ¦æˆ‘ï¼‰</label>
        <textarea id="collabPrompt" class="mono" style="min-height:190px"></textarea>

        <div class="btnbar">
          <button class="btn secondary" id="btnCopyPrompt">è¤‡è£½å”ä½œæç¤º</button>
          <button class="btn" id="btnSaveDraft">å…ˆå­˜è‰ç¨¿</button>
          <button class="btn" id="btnSaveFinal">å­˜ç‚ºå®Œç¨¿</button>
          <button class="btn ghost" id="btnReset">æ¸…ç©ºè¼¸å…¥</button>
        </div>

        <div class="hr"></div>

        <h2 style="margin-top:0">ğŸ§¡ ä¸»é ï¼ˆå¯é¸ï¼‰</h2>
        <div class="sub">å¡«äº†å¾Œå”ä½œæç¤ºèˆ‡æ‰“åŒ…å€æœƒè‡ªå‹•å¸¶å…¥ã€‚</div>
        <label>ä¸»é é€£çµ</label>
        <input id="homepage" placeholder="https://..." value="${escapeHtml(state.settings.homepage||"")}" />
        <div class="btnbar"><button class="btn secondary" id="btnSaveHome">å„²å­˜ä¸»é </button></div>
      </div>

      <div class="card">
        <h2>ğŸ“Œ å¿«é€Ÿå›é¡§</h2>
        <div class="sub">è‰ç¨¿ï¼š${state.entries.filter(e=>e.status==="draft").length}ã€€ï½œã€€å®Œç¨¿ï¼š${state.entries.filter(e=>e.status==="final").length}</div>
        <div class="hr"></div>
        <div class="list">
          ${state.entries.slice(0,3).map(EntryCard).join("") || `<div class="sub">é‚„æ²’æœ‰å…§å®¹ã€‚å…ˆå¯«ä¸€æ®µçœŸå¯¦æ•…äº‹å§ã€‚</div>`}
        </div>
      </div>
    </div>

    <div class="grid" style="gap:14px">
      ${buildSpellCard(last)}
      <div class="card">
        <h2>ğŸª¶ å”ä½œæé†’</h2>
        <div class="sub">ä½ è² è²¬ã€ŒçœŸå¯¦ã€ï¼Œæˆ‘è² è²¬ã€Œçµæ§‹èˆ‡è½‰åŒ–ã€ã€‚ä¸ç”¨ä¸€æ¬¡å®Œæˆï¼Œåªè¦å…ˆç•™ä¸‹ç”Ÿå‘½ç¾å ´ã€‚</div>
        <div class="hr"></div>
        <div class="hint"><b>å°æŠ€å·§ï¼š</b>ä½ æŠŠæ•…äº‹è²¼é€²ä¾†å¾Œï¼Œåªè¦åˆ‡æ›ã€Œæ›¸ç¨¿ï¼èª²ç¨‹ï¼å·¥å…·ï¼ç™¼ç‰‡ã€ï¼Œå”ä½œæç¤ºå°±æœƒè‡ªå‹•æ›æˆä¸åŒä»»å‹™ã€‚</div>
      </div>
    </div>
  </div>`;
}

function FilterBar(idPrefix, status){
  return `
    <div class="row">
      <div>
        <label>ç³»åˆ—ç¯©é¸</label>
        <select id="${idPrefix}Series"><option value="">å…¨éƒ¨</option>${SERIES.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("")}</select>
      </div>
      <div>
        <label>ä¸»é¡Œé—œéµå­—</label>
        <input id="${idPrefix}Kw" placeholder="è¼¸å…¥é—œéµå­—â€¦" />
      </div>
    </div>
    <div class="btnbar">
      <button class="btn secondary" data-action="applyFilter" data-status="${status}" data-prefix="${idPrefix}">å¥—ç”¨ç¯©é¸</button>
      <button class="btn ghost" data-action="clearFilter" data-status="${status}" data-prefix="${idPrefix}">æ¸…é™¤</button>
    </div>
  `;
}

function ListView(status){
  const title = status==="draft" ? "ğŸŒ± æ–‡æ¡ˆè‰ç¨¿å€" : "ğŸŒ³ å®Œç¨¿å€";
  const list = state.entries.filter(e=>e.status===status);
  const prefix = status==="draft" ? "d" : "f";
  return `
    <div class="card">
      <h2>${title}</h2>
      <div class="sub">ä¾ç³»åˆ—åˆ†é¡ï¼‹ä¸»é¡Œæª¢ç´¢ï½œå¯é–‹å•Ÿå…¨æ–‡ã€è¤‡è£½å…¨æ–‡ã€è¤‡è£½å”ä½œæç¤º</div>
      <div class="hr"></div>
      ${FilterBar(prefix, status)}
      <div class="hr"></div>
      <div class="list" id="${prefix}List">
        ${list.map(EntryCard).join("") || `<div class="sub">ç›®å‰æ²’æœ‰å…§å®¹ã€‚</div>`}
      </div>
    </div>
  `;
}

/* ===== æ‰“åŒ… ===== */
function generateDescription(e, kind="video"){
  const homepage = (state.settings.homepage||"").trim();
  const home = homepage ? `\n\nğŸ‘‰ ä¸»é ï¼š${homepage}` : "";
  const tags = ["#å¹¸ç¦æ•™é¤Š","#å¿ƒç†å­¸","#è…¦ç¥ç¶“ç§‘å­¸","#å¿ƒéˆæˆé•·","#è¦ªå­"].join(" ");
  const base = `ã€${e.topic}ã€‘\n\nï¼ˆåœ¨é€™è£¡æ”¾ä½ çš„å½±ç‰‡æ‘˜è¦ï¼é‡é»ï¼‰\n`;
  if(kind==="podcast"){
    return `${base}\nã€Podcast ç‰ˆæœ¬ã€‘\nç”¨æ›´æ…¢çš„ç¯€å¥ï¼ŒæŠŠç†è§£æ”¾é€²å¿ƒè£¡ã€‚\n\n${tags}${home}`.trim();
  }
  return `${base}\n${tags}${home}`.trim();
}

function getSeriesCTA(series){
  const sp = SPELL[series] || SPELL["å…¶ä»–"];
  const homepage = (state.settings.homepage||"").trim();
  let cta = sp.ctaTemplate || "";
  if(homepage) cta += `\n\nä¸»é ï¼š${homepage}`;
  return cta.trim();
}

function PackView(){
  const finals = state.entries.filter(e=>e.status==="final");
  const has = finals.length>0;
  return `
    <div class="grid two">
      <div class="card">
        <h2>ğŸ“¦ ç™¼ç‰‡æ‰“åŒ…å€</h2>
        <div class="sub">å®Œç¨¿ â†’ å·¥å…·é€£çµï¼ä»‹ç´¹æ–‡ï¼CTA ä¸€éµå¥—ç”¨ï¼æ’ç¨‹</div>
        <div class="hr"></div>

        <label>é¸æ“‡ä¸€ç¯‡å®Œç¨¿</label>
        <select id="packPick" ${has?"":"disabled"}>
          ${has ? finals.map(e=>`<option value="${e.id}">${escapeHtml(e.series)}ï½œ${escapeHtml(e.format)}ï½œ${escapeHtml(e.topic)}</option>`).join("")
                : `<option>ç›®å‰æ²’æœ‰å®Œç¨¿</option>`}
        </select>

        <div class="row">
          <div><label>å·¥å…·é€£çµï¼ˆå¯é¸ï¼‰</label><input id="toolLink" placeholder="ä¾‹å¦‚ï¼šPWA å·¥å…·é€£çµ / Google è¡¨å–®â€¦" /></div>
          <div><label>é è¨ˆç™¼ç‰‡æ—¥æœŸï¼ˆå¯é¸ï¼‰</label><input id="scheduleDate" type="date" /></div>
        </div>

        <label>å½±ç‰‡ä»‹ç´¹</label>
        <textarea id="packDesc" placeholder="æŒ‰ã€ç”Ÿæˆä»‹ç´¹æ–‡ã€è‡ªå‹•ç”¢å‡ºåˆç¨¿ã€‚"></textarea>

        <label>CTAï¼ˆä¾ç³»åˆ—ä¸åŒï¼Œä¸€éµå¥—ç”¨ï¼‰</label>
        <textarea id="packCTA" placeholder="æŒ‰ã€å¥—ç”¨ç³»åˆ— CTAã€è‡ªå‹•å¡«å…¥ã€‚"></textarea>

        <div class="btnbar">
          <button class="btn" id="btnGenDesc" ${has?"":"disabled"}>ç”Ÿæˆä»‹ç´¹æ–‡</button>
          <button class="btn secondary" id="btnGenPodDesc" ${has?"":"disabled"}>ç”Ÿæˆ Podcast ä»‹ç´¹</button>
          <button class="btn secondary" id="btnApplyCTA" ${has?"":"disabled"}>å¥—ç”¨ç³»åˆ— CTA</button>
          <button class="btn secondary" id="btnCopyPackAll" ${has?"":"disabled"}>è¤‡è£½ï¼ˆä»‹ç´¹ï¼‹CTAï¼‰</button>
        </div>

        <div class="hr"></div>
        <div class="small">
          <b>å…¶ä»–ä½ å¯å†åŠ ï¼š</b><br/>
          1) é¦–åœ–é¢¨æ ¼æç¤ºï¼ˆ16:9 æ°´å½© / å¯«å¯¦é›»å½±æ„Ÿï¼‰<br/>
          2) Shorts æ‹†æ¢æ¸…å–®ï¼ˆ3â€“5 æ¢ï¼‰<br/>
          3) ç½®é ‚ç•™è¨€ï¼ˆ1 å¥ï¼‰<br/>
          4) ç‰‡å°¾å¼•æµï¼ˆä¸»é  / å·¥å…· / ç›¸é—œé•·ç‰‡ï¼‰
        </div>
      </div>

      <div class="card">
        <h2>ğŸª„ æ‰“åŒ…å”ä½œæç¤º</h2>
        <div class="sub">æƒ³æŠŠä»‹ç´¹æ–‡/ç½®é ‚ç•™è¨€/Shorts æ‹†æ¢ä¹Ÿäº¤çµ¦æˆ‘ï¼Œç›´æ¥è¤‡è£½ï¼š</div>
        <div class="hr"></div>
        <textarea class="mono" id="packPrompt" style="min-height:260px">è«‹ä¾æˆ‘é¸å®šçš„å®Œç¨¿å…§å®¹ï¼Œå¹«æˆ‘ç”¢å‡ºï¼š
1) å½±ç‰‡ä»‹ç´¹
2) ç½®é ‚ç•™è¨€ï¼ˆ1 å¥ï¼‰
3) Shorts æ‹†æ¢ææ¡ˆ 3 å‰‡ï¼ˆæ¨™é¡Œï¼‹ä¸€å¥ hookï¼‰
å£å»è«‹ç¶­æŒè©²ç³»åˆ—çš„æ–‡æ¡ˆå’’èªåŒ…èªæ„Ÿï¼Œæº«æŸ”ä¸èªªæ•™ã€‚</textarea>
        <div class="btnbar">
          <button class="btn secondary" id="btnCopyPackPrompt">è¤‡è£½æ‰“åŒ…å”ä½œæç¤º</button>
        </div>
      </div>
    </div>
  `;
}

/* ===== æ¯æœ¬åº«ï¼šæ›¸ç¨¿å…§å®¹åº« / èª²ç¨‹å…§å®¹åº« ===== */
function MotherView(){
  const books = state.bookProjects;
  const courses = state.courseProjects;

  return `
    <div class="grid" style="gap:14px">
      <div class="card">
        <h2>ğŸ“– æ›¸ç±å°ˆæ¡ˆï¼ˆæ¯æœ¬ï¼‰</h2>
        <div class="sub">æ›¸ç¨¿ä¸æ˜¯å£èªªç¨¿ï¼šç”¨ã€Œç« ç¯€/æ®µè½ã€å †å‡ºä¸€æœ¬æ›¸ã€‚</div>
        <div class="hr"></div>

        <div class="row">
          <div><label>æ›¸åï¼ˆå¯æš«å®šï¼‰</label><input id="bookTitle" placeholder="ä¾‹ï¼šã€Šä¸æ‰“ä¸ç½µä¸æ°£å¹¸ç¦æ•™é¤Šã€‹" /></div>
          <div><label>æ›¸å¯«ç‹€æ…‹</label>
            <select id="bookStatus"><option>é†é‡€ä¸­</option><option>æ›¸å¯«ä¸­</option><option>åˆç¨¿å®Œæˆ</option><option>ä¿®è¨‚ä¸­</option></select>
          </div>
        </div>
        <label>æ ¸å¿ƒä¸€å¥è©±ï¼ˆå¯é¸ï¼‰</label><input id="bookCore" placeholder="ä¾‹ï¼šæŠŠå¿ƒç«™ç©©ï¼Œå­©å­å°±æœ‰è·¯èµ°ã€‚" />
        <label>ç›®æ¨™è®€è€…ï¼ˆå¯é¸ï¼‰</label><input id="bookAudience" placeholder="ä¾‹ï¼šè‚²å…’å®¶é•·ï¼è€å¸«ï¼æƒ³æ´»å¾—è‡ªåœ¨çš„äºº" />
        <div class="btnbar"><button class="btn" id="btnAddBook">æ–°å¢æ›¸ç±å°ˆæ¡ˆ</button></div>

        <div class="hr"></div>
        <div class="list">
          ${books.map(b=>`
            <div class="item">
              <div class="itemhead">
                <div>
                  <div class="itemtitle">${escapeHtml(b.title)}</div>
                  <div class="meta">${escapeHtml(b.status)}ï½œ${fmtDate(b.updatedAt||b.createdAt)}</div>
                </div>
                <div class="tools">
                  <button class="mini" data-action="pickBook" data-id="${b.id}">é¸ç”¨</button>
                  <button class="mini danger" data-action="delBook" data-id="${b.id}">åˆªé™¤</button>
                </div>
              </div>
              <div class="small" style="margin-top:8px"><b>æ ¸å¿ƒï¼š</b>${escapeHtml(b.core||"ï¼ˆæœªå¡«ï¼‰")}</div>
              <div class="small"><b>è®€è€…ï¼š</b>${escapeHtml(b.audience||"ï¼ˆæœªå¡«ï¼‰")}</div>
            </div>`).join("") || `<div class="sub">é‚„æ²’æœ‰æ›¸ç±å°ˆæ¡ˆã€‚</div>`}
        </div>
      </div>

      <div class="grid two">
        <div class="card">
          <h2>ğŸ§± æ›¸ç¨¿å…§å®¹åº«ï¼ˆç« ç¯€/æ®µè½ï¼‰</h2>
          <div class="sub">å¯ç›´æ¥å¾ã€Œå®Œç¨¿ã€åŒ¯å…¥æˆæ›¸ç¨¿æ®µè½ï¼Œè®“ä½ çš„æ•…äº‹æ›´ç”Ÿå‹•ã€‚</div>
          <div class="hr"></div>

          <label>é¸æ“‡æ›¸ç±ï¼ˆå…ˆåœ¨ä¸Šé¢æŒ‰ã€Œé¸ç”¨ã€ï¼‰</label>
          <input id="pickedBook" placeholder="å°šæœªé¸ç”¨æ›¸ç±" readonly />

          <div class="row">
            <div><label>ç« ç¯€ï¼ˆè‡ªè¡Œè¼¸å…¥ï¼‰</label><input id="bookChapter" placeholder="ä¾‹ï¼šç¬¬äºŒç« ï½œç„¡æ¬²å‰‡å‰›" /></div>
            <div><label>æ®µè½æ¨™é¡Œ</label><input id="bookParaTitle" placeholder="ä¾‹ï¼šè¶…å¸‚è£¡è«‡åƒ¹ç¢¼" /></div>
          </div>

          <label>æ®µè½å…§å®¹</label>
          <textarea id="bookParaBody" placeholder="è²¼ä¸Šä½ çš„æ•…äº‹ï¼æ®µè½â€¦"></textarea>

          <div class="row">
            <div>
              <label>å¾å®Œç¨¿åŒ¯å…¥ï¼ˆå¯é¸ï¼‰</label>
              <select id="importFinalToBook">
                <option value="">ä¸åŒ¯å…¥</option>
                ${state.entries.filter(e=>e.status==="final").map(e=>`<option value="${e.id}">${escapeHtml(e.series)}ï½œ${escapeHtml(e.topic)}</option>`).join("")}
              </select>
            </div>
            <div style="display:flex;align-items:flex-end">
              <button class="btn secondary" id="btnFillBookFromFinal">å¸¶å…¥å®Œç¨¿å…§å®¹</button>
            </div>
          </div>

          <div class="btnbar">
            <button class="btn" id="btnAddBookPara">æ–°å¢æ®µè½</button>
            <button class="btn secondary" id="btnExportBookText">åŒ¯å‡ºæ­¤æ›¸ï¼ˆç´”æ–‡å­—ï¼‰</button>
          </div>

          <div class="hr"></div>
          <div class="list" id="bookContentList"></div>
        </div>

        <div class="card">
          <h2>ğŸ“ èª²ç¨‹å°ˆæ¡ˆï¼ˆæ¯æœ¬ï¼‰</h2>
          <div class="sub">èª²ç¨‹æ˜¯å­¸ç¿’è·¯å¾‘ï¼šé™ªäººåšåˆ°ã€‚</div>
          <div class="hr"></div>

          <div class="row">
            <div><label>èª²ç¨‹åç¨±</label><input id="courseTitle" placeholder="ä¾‹ï¼šæŠŠã€ç­‰ä¸€ä¸‹ã€ç·´å‡ºä¾†ï¼šå­©å­çš„é¸æ“‡åŠ›" /></div>
            <div><label>èª²ç¨‹å‹æ…‹</label>
              <select id="courseType"><option>å®¶é•·èª²</option><option>æ•™å¸«å°ˆæ¥­èª²</option><option>æˆäººå…§åœ¨æˆé•·</option></select>
            </div>
          </div>
          <label>ä¸€å¥è©±æ‰¿è«¾ï¼ˆå¯é¸ï¼‰</label><input id="coursePromise" placeholder="ä¾‹ï¼šé™ªä½ åœ¨é—œéµæ™‚åˆ»èƒ½å¤šåœä¸€ä¸‹ã€å°‘ç”¨åŠ›ä¸€é»ã€‚" />
          <div class="row">
            <div><label>é©åˆå°è±¡ï¼ˆå¯é¸ï¼‰</label><input id="courseAudience" placeholder="ä¾‹ï¼šè‚²å…’å®¶é•·ï¼ç¬¬ä¸€ç·šè€å¸«" /></div>
            <div><label>èª²ç¨‹ç‹€æ…‹</label>
              <select id="courseStatus"><option>é†é‡€ä¸­</option><option>è¨­è¨ˆä¸­</option><option>è©¦æ•™ä¸­</option><option>ç©©å®šä¸Šç·š</option></select>
            </div>
          </div>
          <div class="btnbar"><button class="btn" id="btnAddCourse">æ–°å¢èª²ç¨‹å°ˆæ¡ˆ</button></div>

          <div class="hr"></div>
          <div class="list">
            ${courses.map(c=>`
              <div class="item">
                <div class="itemhead">
                  <div>
                    <div class="itemtitle">${escapeHtml(c.title)}</div>
                    <div class="meta">${escapeHtml(c.type)}ï½œ${escapeHtml(c.status)}ï½œ${fmtDate(c.updatedAt||c.createdAt)}</div>
                  </div>
                  <div class="tools">
                    <button class="mini" data-action="pickCourse" data-id="${c.id}">é¸ç”¨</button>
                    <button class="mini danger" data-action="delCourse" data-id="${c.id}">åˆªé™¤</button>
                  </div>
                </div>
                <div class="small" style="margin-top:8px"><b>æ‰¿è«¾ï¼š</b>${escapeHtml(c.promise||"ï¼ˆæœªå¡«ï¼‰")}</div>
                <div class="small"><b>å°è±¡ï¼š</b>${escapeHtml(c.audience||"ï¼ˆæœªå¡«ï¼‰")}</div>
              </div>`).join("") || `<div class="sub">é‚„æ²’æœ‰èª²ç¨‹å°ˆæ¡ˆã€‚</div>`}
          </div>

          <div class="hr"></div>
          <h2 style="margin-top:0">ğŸ§© èª²ç¨‹å…§å®¹åº«ï¼ˆæ¨¡çµ„/å–®å…ƒï¼‰</h2>
          <div class="sub">å–®å…ƒæ¨¡æ¿ï¼šæ•…äº‹/ç†è§£/ç·´ç¿’/å¸¶èµ°å¥ã€‚å¯å¾å®Œç¨¿åŒ¯å…¥ã€‚</div>

          <label>é¸æ“‡èª²ç¨‹ï¼ˆå…ˆåœ¨ä¸Šé¢æŒ‰ã€Œé¸ç”¨ã€ï¼‰</label>
          <input id="pickedCourse" placeholder="å°šæœªé¸ç”¨èª²ç¨‹" readonly />

          <div class="row">
            <div><label>æ¨¡çµ„</label><input id="courseModule" placeholder="ä¾‹ï¼šæ¨¡çµ„1ï½œå¤§äººå…ˆç©©" /></div>
            <div><label>å–®å…ƒæ¨™é¡Œ</label><input id="courseUnitTitle" placeholder="ä¾‹ï¼šè¶…å¸‚è£¡çš„ã€ç­‰ä¸€ä¸‹ã€" /></div>
          </div>

          <div class="row">
            <div>
              <label>å¾å®Œç¨¿åŒ¯å…¥ï¼ˆå¯é¸ï¼‰</label>
              <select id="importFinalToCourse">
                <option value="">ä¸åŒ¯å…¥</option>
                ${state.entries.filter(e=>e.status==="final").map(e=>`<option value="${e.id}">${escapeHtml(e.series)}ï½œ${escapeHtml(e.topic)}</option>`).join("")}
              </select>
            </div>
            <div style="display:flex;align-items:flex-end">
              <button class="btn secondary" id="btnFillCourseFromFinal">å¸¶å…¥å®Œç¨¿ï¼ˆå¡«æ•…äº‹ï¼‰</button>
            </div>
          </div>

          <label>æ•…äº‹ï¼ˆç¾å ´ï¼‰</label>
          <textarea id="unitStory" placeholder="è²¼æ•…äº‹åŸæ–‡ï¼ˆä½ çš„ç”Ÿå‘½ç¾å ´ï¼‰"></textarea>
          <label>ç†è§£ï¼ˆç™½è©±å¿ƒè…¦è½‰è­¯ï¼‰</label>
          <textarea id="unitInsight" placeholder="æŠŠã€ç™¼ç”Ÿäº†ä»€éº¼ã€ç¿»è­¯æˆã€å¤§è…¦åœ¨åšä»€éº¼ã€"></textarea>
          <label>ç·´ç¿’ï¼ˆ30â€“60ç§’å¯åšï¼‰</label>
          <textarea id="unitPractice" placeholder="ä¾‹ï¼šæ‰‹æ‘¸èƒ¸å£ï¼‹4å¸6åÃ—3ï¼Œç´…â†’é»ƒâ†’ç¶ "></textarea>
          <label>å¸¶èµ°ä¸€å¥è©±</label>
          <input id="unitTakeaway" placeholder="ä¾‹ï¼šå¿ä¸€ä¸‹ä¸æ˜¯å£“æŠ‘ï¼Œæ˜¯è®“é¸æ“‡åŠ›é•·å‡ºä¾†ã€‚" />

          <div class="btnbar">
            <button class="btn" id="btnAddCourseUnit">æ–°å¢å–®å…ƒ</button>
            <button class="btn secondary" id="btnExportCourseText">åŒ¯å‡ºæ­¤èª²ï¼ˆç´”æ–‡å­—ï¼‰</button>
          </div>

          <div class="hr"></div>
          <div class="list" id="courseContentList"></div>
        </div>
      </div>
    </div>
  `;
}

/* ===== Settings ===== */
function SettingsView(){
  return `
    <div class="grid two">
      <div class="card">
        <h2>âš™ï¸ è¨­å®š</h2>
        <div class="sub">è³‡æ–™å­˜åœ¨æœ¬æ©Ÿï¼ˆlocalStorageï¼‰ã€‚å»ºè­°å®šæœŸåŒ¯å‡ºå‚™ä»½ã€‚</div>
        <div class="hr"></div>
        <label>ä¸»é é€£çµï¼ˆå¯é¸ï¼‰</label>
        <input id="homepage2" placeholder="https://..." value="${escapeHtml(state.settings.homepage||"")}" />
        <div class="btnbar"><button class="btn secondary" id="btnSaveHome2">å„²å­˜</button></div>

        <div class="hr"></div>
        <div class="row">
          <div><label>åŒ¯å‡ºå‚™ä»½ï¼ˆJSONï¼‰</label><button class="btn" id="btnExport">åŒ¯å‡º</button></div>
          <div><label>åŒ¯å…¥å‚™ä»½ï¼ˆJSONï¼‰</label><input type="file" id="fileImport" accept="application/json" /></div>
        </div>

        <div class="hr"></div>
        <button class="btn danger" id="btnWipe">æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
        <div class="small" style="margin-top:8px">âš ï¸ æ¸…ç©ºå‰è«‹å…ˆåŒ¯å‡ºå‚™ä»½ã€‚</div>
      </div>

      <div class="card">
        <h2>ğŸ“Œ å·²æ“´å……åŠŸèƒ½æ¸…å–®</h2>
        <div class="small">
          - è‰ç¨¿/å®Œç¨¿ï¼šé–‹å•Ÿå…¨æ–‡ï¼‹è¤‡è£½å…¨æ–‡ï¼‹è¤‡è£½å”ä½œæç¤º<br/>
          - ç™¼ç‰‡æ‰“åŒ…ï¼šç³»åˆ— CTA ä¸€éµå¥—ç”¨ï¼‹Podcast ä»‹ç´¹ä¸€éµç”Ÿæˆ<br/>
          - æ¯æœ¬åº«ï¼šæ›¸ç¨¿ï¼ˆç« /æ®µè½ï¼‰ï¼‹èª²ç¨‹ï¼ˆæ¨¡çµ„/å–®å…ƒï¼‰ï¼‹å¯ç”±å®Œç¨¿åŒ¯å…¥<br/>
          - ä»ç¶­æŒï¼šå’’èªåŒ…ã€å”ä½œæç¤ºã€æª¢ç´¢ã€å‚™ä»½<br/><br/>
          <b>ä¸‹ä¸€æ­¥ï¼š</b>æŠŠã€Œæ®µè½/å–®å…ƒã€åšæˆå¯ç·¨è¼¯/å¯åˆªé™¤/å¯ç§»å‹•æ’åºã€‚
        </div>
      </div>
    </div>
  `;
}

/* ===== Render ===== */
function render(){
  renderNav();
  const view = document.getElementById("view");
  if(current==="create") view.innerHTML = CreateView();
  if(current==="drafts") view.innerHTML = ListView("draft");
  if(current==="final") view.innerHTML = ListView("final");
  if(current==="pack") view.innerHTML = PackView();
  if(current==="mother") view.innerHTML = MotherView();
  if(current==="settings") view.innerHTML = SettingsView();
  bindEvents();
  if(document.getElementById("collabPrompt")) updateCollabPrompt();
  refreshMotherLists();
}
render();

/* ===== Dialog å…¨æ–‡ ===== */
let dlgEntryId = null;
function openDialogForEntry(id){
  const e = state.entries.find(x=>x.id===id);
  if(!e) return;
  dlgEntryId = id;
  document.getElementById("dlgTitle").textContent = e.topic;
  document.getElementById("dlgMeta").textContent = `${e.series}ï½œ${e.format}ï½œ${fmtDate(e.updatedAt||e.createdAt)}`;
  document.getElementById("dlgText").textContent = e.body || "";
  document.getElementById("dlg").showModal();
}
function closeDlg(){ document.getElementById("dlg").close(); dlgEntryId=null; }

/* ===== Filter ===== */
function applyFilter(status, prefix){
  const series = (document.getElementById(prefix+"Series")?.value||"").trim();
  const kw = (document.getElementById(prefix+"Kw")?.value||"").trim().toLowerCase();
  let items = state.entries.filter(e=>e.status===status);
  if(series) items = items.filter(e=>e.series===series);
  if(kw) items = items.filter(e=>
    (e.topic||"").toLowerCase().includes(kw) ||
    (e.body||"").toLowerCase().includes(kw)
  );
  document.getElementById(prefix+"List").innerHTML = items.map(EntryCard).join("") || `<div class="sub">æ²’æœ‰ç¬¦åˆçš„å…§å®¹ã€‚</div>`;
  bindEvents();
}
function clearFilter(status, prefix){
  const s = document.getElementById(prefix+"Series");
  const k = document.getElementById(prefix+"Kw");
  if(s) s.value = "";
  if(k) k.value = "";
  applyFilter(status, prefix);
}

/* ===== æ¯æœ¬ï¼šé¸ç”¨ç‹€æ…‹ ===== */
state.settings.pickedBookId ||= "";
state.settings.pickedCourseId ||= "";
function pickedBook(){ return state.settings.pickedBookId || ""; }
function pickedCourse(){ return state.settings.pickedCourseId || ""; }

function refreshMotherLists(){
  // æ›¸ç¨¿å…§å®¹åˆ—è¡¨
  const el = document.getElementById("bookContentList");
  const pickedB = pickedBook();
  const pickedBName = state.bookProjects.find(b=>b.id===pickedB)?.title || "";
  const pickedBookInput = document.getElementById("pickedBook");
  if(pickedBookInput) pickedBookInput.value = pickedBName || "å°šæœªé¸ç”¨æ›¸ç±";

  if(el){
    const list = state.bookContent.filter(x=>x.bookId===pickedB);
    el.innerHTML = list.map(p=>`
      <div class="item">
        <div class="itemhead">
          <div>
            <div class="itemtitle">${escapeHtml(p.chapter||"ï¼ˆæœªå¡«ç« ç¯€ï¼‰")}ï½œ${escapeHtml(p.title||"ï¼ˆæœªå¡«æ¨™é¡Œï¼‰")}</div>
            <div class="meta">${fmtDate(p.updatedAt||p.createdAt)}${p.sourceEntryId?`ï½œä¾†æºå®Œç¨¿`:""}</div>
          </div>
          <div class="tools">
            <button class="mini" data-action="copyBookPara" data-id="${p.id}">è¤‡è£½</button>
            <button class="mini danger" data-action="delBookPara" data-id="${p.id}">åˆªé™¤</button>
          </div>
        </div>
        <div class="small" style="margin-top:8px">${escapeHtml((p.body||"").slice(0,120).replace(/\n/g," "))}${(p.body||"").length>120?"â€¦":""}</div>
      </div>
    `).join("") || `<div class="sub">å…ˆã€Œé¸ç”¨æ›¸ç±ã€â†’ å†æ–°å¢æ®µè½ã€‚</div>`;
  }

  // èª²ç¨‹å…§å®¹åˆ—è¡¨
  const el2 = document.getElementById("courseContentList");
  const pickedC = pickedCourse();
  const pickedCName = state.courseProjects.find(c=>c.id===pickedC)?.title || "";
  const pickedCourseInput = document.getElementById("pickedCourse");
  if(pickedCourseInput) pickedCourseInput.value = pickedCName || "å°šæœªé¸ç”¨èª²ç¨‹";

  if(el2){
    const list = state.courseContent.filter(x=>x.courseId===pickedC);
    el2.innerHTML = list.map(u=>`
      <div class="item">
        <div class="itemhead">
          <div>
            <div class="itemtitle">${escapeHtml(u.module||"ï¼ˆæœªå¡«æ¨¡çµ„ï¼‰")}ï½œ${escapeHtml(u.unitTitle||"ï¼ˆæœªå¡«å–®å…ƒï¼‰")}</div>
            <div class="meta">${fmtDate(u.updatedAt||u.createdAt)}${u.sourceEntryId?`ï½œä¾†æºå®Œç¨¿`:""}</div>
          </div>
          <div class="tools">
            <button class="mini" data-action="copyCourseUnit" data-id="${u.id}">è¤‡è£½</button>
            <button class="mini danger" data-action="delCourseUnit" data-id="${u.id}">åˆªé™¤</button>
          </div>
        </div>
        <div class="small" style="margin-top:8px"><b>å¸¶èµ°å¥ï¼š</b>${escapeHtml(u.takeaway||"ï¼ˆæœªå¡«ï¼‰")}</div>
      </div>
    `).join("") || `<div class="sub">å…ˆã€Œé¸ç”¨èª²ç¨‹ã€â†’ å†æ–°å¢å–®å…ƒã€‚</div>`;
  }

  bindEvents();
}

/* ===== åŒ¯å‡ºæ›¸/èª²ç´”æ–‡å­— ===== */
function exportBookText(bookId){
  const book = state.bookProjects.find(b=>b.id===bookId);
  if(!book) return "";
  const paras = state.bookContent.filter(p=>p.bookId===bookId);
  let out = `ã€æ›¸åã€‘${book.title}\nã€ç‹€æ…‹ã€‘${book.status}\nã€æ ¸å¿ƒã€‘${book.core||""}\nã€è®€è€…ã€‘${book.audience||""}\n\n`;
  // ä¾ç« ç¯€åˆ†çµ„ï¼ˆç°¡å–®æ’åºï¼šç« ç¯€å­—ä¸²ï¼‰
  const groups = {};
  paras.forEach(p=>{
    const ch = p.chapter || "ï¼ˆæœªåˆ†ç« ï¼‰";
    groups[ch] ||= [];
    groups[ch].push(p);
  });
  Object.keys(groups).sort().forEach(ch=>{
    out += `\n=== ${ch} ===\n`;
    groups[ch].forEach(p=>{
      out += `\n# ${p.title||"ï¼ˆæœªå‘½åæ®µè½ï¼‰"}\n${p.body||""}\n`;
    });
  });
  return out.trim();
}

function exportCourseText(courseId){
  const c = state.courseProjects.find(x=>x.id===courseId);
  if(!c) return "";
  const units = state.courseContent.filter(u=>u.courseId===courseId);
  let out = `ã€èª²ç¨‹ã€‘${c.title}\nã€å‹æ…‹ã€‘${c.type}\nã€ç‹€æ…‹ã€‘${c.status}\nã€æ‰¿è«¾ã€‘${c.promise||""}\nã€å°è±¡ã€‘${c.audience||""}\n\n`;
  const groups = {};
  units.forEach(u=>{
    const m = u.module || "ï¼ˆæœªåˆ†æ¨¡çµ„ï¼‰";
    groups[m] ||= [];
    groups[m].push(u);
  });
  Object.keys(groups).sort().forEach(m=>{
    out += `\n=== ${m} ===\n`;
    groups[m].forEach(u=>{
      out += `\n# ${u.unitTitle||"ï¼ˆæœªå‘½åå–®å…ƒï¼‰"}\n\nã€æ•…äº‹ã€‘\n${u.story||""}\n\nã€ç†è§£ã€‘\n${u.insight||""}\n\nã€ç·´ç¿’ã€‘\n${u.practice||""}\n\nã€å¸¶èµ°ã€‘\n${u.takeaway||""}\n`;
    });
  });
  return out.trim();
}

/* ===== Events ===== */
function bindEvents(){
  const seriesSel = document.getElementById("series");
  if(seriesSel){
    seriesSel.addEventListener("change", ()=>{
      state.settings.lastSeries = seriesSel.value;
      saveState(state);
      render(); // å³å´å’’èªåŒ…åŒæ­¥
    });
  }

  ["topic","body","notes","collabDir"].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener("input", updateCollabPrompt);
    if(id==="collabDir" && el) el.addEventListener("change", updateCollabPrompt);
  });

  const btnCopyPrompt = document.getElementById("btnCopyPrompt");
  if(btnCopyPrompt) btnCopyPrompt.addEventListener("click", ()=>copyText(document.getElementById("collabPrompt").value));

  const btnSaveDraft = document.getElementById("btnSaveDraft");
  if(btnSaveDraft){
    btnSaveDraft.addEventListener("click", ()=>{
      const payload = getEntryForm(); if(!payload) return;
      payload.status = "draft";
      upsertEntry(payload);
      toast("å·²å­˜è‰ç¨¿");
      render();
    });
  }
  const btnSaveFinal = document.getElementById("btnSaveFinal");
  if(btnSaveFinal){
    btnSaveFinal.addEventListener("click", ()=>{
      const payload = getEntryForm(); if(!payload) return;
      payload.status = "final";
      upsertEntry(payload);
      toast("å·²å­˜å®Œç¨¿");
      render();
    });
  }
  const btnReset = document.getElementById("btnReset");
  if(btnReset){
    btnReset.addEventListener("click", ()=>{
      ["entryId","topic","body","notes"].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.value = "";
      });
      toast("å·²æ¸…ç©ºï¼ˆä¸å½±éŸ¿å·²å­˜å…§å®¹ï¼‰");
      updateCollabPrompt();
    });
  }

  const btnSaveHome = document.getElementById("btnSaveHome");
  if(btnSaveHome){
    btnSaveHome.addEventListener("click", ()=>{
      state.settings.homepage = (document.getElementById("homepage").value||"").trim();
      saveState(state); toast("å·²å„²å­˜"); updateCollabPrompt();
    });
  }
  const btnSaveHome2 = document.getElementById("btnSaveHome2");
  if(btnSaveHome2){
    btnSaveHome2.addEventListener("click", ()=>{
      state.settings.homepage = (document.getElementById("homepage2").value||"").trim();
      saveState(state); toast("å·²å„²å­˜"); render();
    });
  }

  /* åˆ—è¡¨å¡ç‰‡ */
  document.querySelectorAll("[data-action='open']").forEach(btn=>{
    btn.addEventListener("click", ()=>openDialogForEntry(btn.dataset.id));
  });
  document.querySelectorAll("[data-action='edit']").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.dataset.id;
      const e = state.entries.find(x=>x.id===id);
      if(!e) return;
      current="create"; render();
      setTimeout(()=>{
        document.getElementById("entryId").value = e.id;
        document.getElementById("format").value = e.format;
        document.getElementById("series").value = e.series;
        document.getElementById("topic").value = e.topic;
        document.getElementById("body").value = e.body;
        document.getElementById("notes").value = e.notes || "";
        document.getElementById("collabDir").value = e.collabDir || "æ›¸ç¨¿";
        updateCollabPrompt();
        toast("å·²è¼‰å…¥åˆ°å‰µä½œé ");
      },0);
    });
  });
  document.querySelectorAll("[data-action='toggle']").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.dataset.id;
      const e = state.entries.find(x=>x.id===id);
      if(!e) return;
      e.status = (e.status==="draft") ? "final" : "draft";
      e.updatedAt = nowISO();
      saveState(state);
      toast("å·²æ›´æ–°ç‹€æ…‹");
      render();
    });
  });
  document.querySelectorAll("[data-action='del']").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.dataset.id;
      if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿï¼ˆç„¡æ³•å¾©åŸï¼‰")) return;
      state.entries = state.entries.filter(x=>x.id!==id);
      saveState(state);
      toast("å·²åˆªé™¤");
      render();
    });
  });

  /* ç¯©é¸ */
  document.querySelectorAll("[data-action='applyFilter']").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const status = btn.dataset.status;
      const prefix = btn.dataset.prefix;
      applyFilter(status, prefix);
    });
  });
  document.querySelectorAll("[data-action='clearFilter']").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const status = btn.dataset.status;
      const prefix = btn.dataset.prefix;
      clearFilter(status, prefix);
    });
  });

  /* Dialog */
  const dlg = document.getElementById("dlg");
  if(dlg){
    const closeBtn = document.getElementById("dlgClose");
    if(closeBtn) closeBtn.onclick = closeDlg;
    const copyBtn = document.getElementById("dlgCopy");
    if(copyBtn) copyBtn.onclick = ()=>{
      const e = state.entries.find(x=>x.id===dlgEntryId);
      copyText(e?.body||"");
    };
    const copyPromptBtn = document.getElementById("dlgCopyPrompt");
    if(copyPromptBtn) copyPromptBtn.onclick = ()=>{
      const e = state.entries.find(x=>x.id===dlgEntryId);
      if(!e) return;
      const prompt = baseCollabPrompt(e.series, e.collabDir||"æ›¸ç¨¿", {topic:e.topic, body:e.body, notes:e.notes||""});
      copyText(prompt);
    };
  }

  /* æ‰“åŒ… */
  const btnGenDesc = document.getElementById("btnGenDesc");
  if(btnGenDesc){
    btnGenDesc.addEventListener("click", ()=>{
      const id = document.getElementById("packPick").value;
      const e = state.entries.find(x=>x.id===id);
      if(!e) return;
      document.getElementById("packDesc").value = generateDescription(e, "video");
      toast("å·²ç”Ÿæˆä»‹ç´¹æ–‡");
    });
  }
  const btnGenPodDesc = document.getElementById("btnGenPodDesc");
  if(btnGenPodDesc){
    btnGenPodDesc.addEventListener("click", ()=>{
      const id = document.getElementById("packPick").value;
      const e = state.entries.find(x=>x.id===id);
      if(!e) return;
      document.getElementById("packDesc").value = generateDescription(e, "podcast");
      toast("å·²ç”Ÿæˆ Podcast ä»‹ç´¹");
    });
  }
  const btnApplyCTA = document.getElementById("btnApplyCTA");
  if(btnApplyCTA){
    btnApplyCTA.addEventListener("click", ()=>{
      const id = document.getElementById("packPick").value;
      const e = state.entries.find(x=>x.id===id);
      if(!e) return;
      document.getElementById("packCTA").value = getSeriesCTA(e.series);
      toast("å·²å¥—ç”¨ç³»åˆ— CTA");
    });
  }
  const btnCopyPackAll = document.getElementById("btnCopyPackAll");
  if(btnCopyPackAll){
    btnCopyPackAll.addEventListener("click", ()=>{
      const tool = (document.getElementById("toolLink").value||"").trim();
      const dt = (document.getElementById("scheduleDate").value||"").trim();
      const desc = (document.getElementById("packDesc").value||"").trim();
      const cta = (document.getElementById("packCTA").value||"").trim();
      const extra = [];
      if(tool) extra.push(`å·¥å…·é€£çµï¼š${tool}`);
      if(dt) extra.push(`é è¨ˆç™¼ç‰‡ï¼š${dt}`);
      const head = extra.length?`ã€æ‰“åŒ…è³‡è¨Šã€‘\n${extra.join("\n")}\n\n`:"";
      copyText(`${head}${desc}\n\n${cta}`.trim());
    });
  }

  const btnCopyPackPrompt = document.getElementById("btnCopyPackPrompt");
  if(btnCopyPackPrompt) btnCopyPackPrompt.addEventListener("click", ()=>copyText(document.getElementById("packPrompt").value));

  /* æ¯æœ¬ï¼šæ–°å¢/åˆªé™¤/é¸ç”¨ */
  const btnAddBook = document.getElementById("btnAddBook");
  if(btnAddBook){
    btnAddBook.addEventListener("click", ()=>{
      const title = (document.getElementById("bookTitle").value||"").trim();
      if(!title) return alert("è«‹å…ˆè¼¸å…¥æ›¸åï¼ˆå¯æš«å®šï¼‰");
      state.bookProjects.unshift({
        id: uid(), title,
        core:(document.getElementById("bookCore").value||"").trim(),
        audience:(document.getElementById("bookAudience").value||"").trim(),
        status:(document.getElementById("bookStatus").value||"é†é‡€ä¸­"),
        createdAt:nowISO(), updatedAt:nowISO()
      });
      saveState(state); toast("å·²æ–°å¢æ›¸ç±å°ˆæ¡ˆ"); render();
    });
  }
  document.querySelectorAll("[data-action='delBook']").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.dataset.id;
      if(!confirm("åˆªé™¤æ›¸ç±å°ˆæ¡ˆï¼Ÿ")) return;
      state.bookProjects = state.bookProjects.filter(b=>b.id!==id);
      if(state.settings.pickedBookId===id) state.settings.pickedBookId="";
      saveState(state); toast("å·²åˆªé™¤"); render();
    });
  });
  document.querySelectorAll("[data-action='pickBook']").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      state.settings.pickedBookId = btn.dataset.id;
      saveState(state);
      toast("å·²é¸ç”¨æ›¸ç±");
      refreshMotherLists();
    });
  });

  const btnAddCourse = document.getElementById("btnAddCourse");
  if(btnAddCourse){
    btnAddCourse.addEventListener("click", ()=>{
      const title = (document.getElementById("courseTitle").value||"").trim();
      if(!title) return alert("è«‹å…ˆè¼¸å…¥èª²ç¨‹åç¨±");
      state.courseProjects.unshift({
        id: uid(), title,
        promise:(document.getElementById("coursePromise").value||"").trim(),
        audience:(document.getElementById("courseAudience").value||"").trim(),
        type:(document.getElementById("courseType").value||"å®¶é•·èª²"),
        status:(document.getElementById("courseStatus").value||"é†é‡€ä¸­"),
        createdAt:nowISO(), updatedAt:nowISO()
      });
      saveState(state); toast("å·²æ–°å¢èª²ç¨‹å°ˆæ¡ˆ"); render();
    });
  }
  document.querySelectorAll("[data-action='delCourse']").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.dataset.id;
      if(!confirm("åˆªé™¤èª²ç¨‹å°ˆæ¡ˆï¼Ÿ")) return;
      state.courseProjects = state.courseProjects.filter(c=>c.id!==id);
      if(state.settings.pickedCourseId===id) state.settings.pickedCourseId="";
      saveState(state); toast("å·²åˆªé™¤"); render();
    });
  });
  document.querySelectorAll("[data-action='pickCourse']").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      state.settings.pickedCourseId = btn.dataset.id;
      saveState(state);
      toast("å·²é¸ç”¨èª²ç¨‹");
      refreshMotherLists();
    });
  });

  /* æ›¸ç¨¿æ®µè½ï¼šå¾å®Œç¨¿å¸¶å…¥ / æ–°å¢ / åŒ¯å‡º / åˆªé™¤ / è¤‡è£½ */
  const btnFillBookFromFinal = document.getElementById("btnFillBookFromFinal");
  if(btnFillBookFromFinal){
    btnFillBookFromFinal.addEventListener("click", ()=>{
      const id = document.getElementById("importFinalToBook").value;
      if(!id) return;
      const e = state.entries.find(x=>x.id===id);
      if(!e) return;
      document.getElementById("bookParaTitle").value = e.topic;
      document.getElementById("bookParaBody").value = e.body;
      toast("å·²å¸¶å…¥å®Œç¨¿");
    });
  }
  const btnAddBookPara = document.getElementById("btnAddBookPara");
  if(btnAddBookPara){
    btnAddBookPara.addEventListener("click", ()=>{
      const bookId = pickedBook();
      if(!bookId) return alert("è«‹å…ˆåœ¨ä¸Šæ–¹æ›¸ç±å°ˆæ¡ˆæŒ‰ã€é¸ç”¨ã€");
      const chapter = (document.getElementById("bookChapter").value||"").trim();
      const title = (document.getElementById("bookParaTitle").value||"").trim();
      const body = (document.getElementById("bookParaBody").value||"").trim();
      if(!body) return alert("è«‹å…ˆå¡«æ®µè½å…§å®¹");
      const sourceEntryId = (document.getElementById("importFinalToBook").value||"").trim() || "";
      state.bookContent.unshift({
        id: uid(), bookId, chapter, title, body, sourceEntryId,
        createdAt:nowISO(), updatedAt:nowISO()
      });
      saveState(state); toast("å·²æ–°å¢æ®µè½"); refreshMotherLists();
      document.getElementById("bookParaBody").value = "";
    });
  }
  document.querySelectorAll("[data-action='delBookPara']").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.dataset.id;
      if(!confirm("åˆªé™¤æ®µè½ï¼Ÿ")) return;
      state.bookContent = state.bookContent.filter(x=>x.id!==id);
      saveState(state); toast("å·²åˆªé™¤æ®µè½"); refreshMotherLists();
    });
  });
  document.querySelectorAll("[data-action='copyBookPara']").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const p = state.bookContent.find(x=>x.id===btn.dataset.id);
      if(!p) return;
      copyText(`${p.chapter||""}\n${p.title||""}\n\n${p.body||""}`.trim());
    });
  });
  const btnExportBookText = document.getElementById("btnExportBookText");
  if(btnExportBookText){
    btnExportBookText.addEventListener("click", ()=>{
      const bookId = pickedBook();
      if(!bookId) return alert("è«‹å…ˆé¸ç”¨ä¸€æœ¬æ›¸");
      const text = exportBookText(bookId);
      copyText(text);
      toast("å·²è¤‡è£½æ›¸ç¨¿ç´”æ–‡å­—");
    });
  }

  /* èª²ç¨‹å–®å…ƒï¼šå¾å®Œç¨¿å¸¶å…¥ / æ–°å¢ / åŒ¯å‡º / åˆªé™¤ / è¤‡è£½ */
  const btnFillCourseFromFinal = document.getElementById("btnFillCourseFromFinal");
  if(btnFillCourseFromFinal){
    btnFillCourseFromFinal.addEventListener("click", ()=>{
      const id = document.getElementById("importFinalToCourse").value;
      if(!id) return;
      const e = state.entries.find(x=>x.id===id);
      if(!e) return;
      document.getElementById("courseUnitTitle").value = e.topic;
      document.getElementById("unitStory").value = e.body;
      toast("å·²å¸¶å…¥å®Œç¨¿ï¼ˆæ•…äº‹ï¼‰");
    });
  }
  const btnAddCourseUnit = document.getElementById("btnAddCourseUnit");
  if(btnAddCourseUnit){
    btnAddCourseUnit.addEventListener("click", ()=>{
      const courseId = pickedCourse();
      if(!courseId) return alert("è«‹å…ˆåœ¨èª²ç¨‹å°ˆæ¡ˆæŒ‰ã€é¸ç”¨ã€");
      const module = (document.getElementById("courseModule").value||"").trim();
      const unitTitle = (document.getElementById("courseUnitTitle").value||"").trim();
      const story = (document.getElementById("unitStory").value||"").trim();
      const insight = (document.getElementById("unitInsight").value||"").trim();
      const practice = (document.getElementById("unitPractice").value||"").trim();
      const takeaway = (document.getElementById("unitTakeaway").value||"").trim();
      if(!unitTitle) return alert("è«‹å…ˆå¡«å–®å…ƒæ¨™é¡Œ");
      if(!story) return alert("è«‹å…ˆå¡«æ•…äº‹ï¼ˆæˆ–å¾å®Œç¨¿å¸¶å…¥ï¼‰");
      const sourceEntryId = (document.getElementById("importFinalToCourse").value||"").trim() || "";
      state.courseContent.unshift({
        id: uid(), courseId, module, unitTitle, story, insight, practice, takeaway, sourceEntryId,
        createdAt:nowISO(), updatedAt:nowISO()
      });
      saveState(state); toast("å·²æ–°å¢å–®å…ƒ"); refreshMotherLists();
      document.getElementById("unitStory").value = "";
      document.getElementById("unitInsight").value = "";
      document.getElementById("unitPractice").value = "";
      document.getElementById("unitTakeaway").value = "";
    });
  }
  document.querySelectorAll("[data-action='delCourseUnit']").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.dataset.id;
      if(!confirm("åˆªé™¤å–®å…ƒï¼Ÿ")) return;
      state.courseContent = state.courseContent.filter(x=>x.id!==id);
      saveState(state); toast("å·²åˆªé™¤å–®å…ƒ"); refreshMotherLists();
    });
  });
  document.querySelectorAll("[data-action='copyCourseUnit']").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const u = state.courseContent.find(x=>x.id===btn.dataset.id);
      if(!u) return;
      copyText(`ã€${u.module||""}ï½œ${u.unitTitle||""}ã€‘\n\nã€æ•…äº‹ã€‘\n${u.story||""}\n\nã€ç†è§£ã€‘\n${u.insight||""}\n\nã€ç·´ç¿’ã€‘\n${u.practice||""}\n\nã€å¸¶èµ°ã€‘\n${u.takeaway||""}`.trim());
    });
  });
  const btnExportCourseText = document.getElementById("btnExportCourseText");
  if(btnExportCourseText){
    btnExportCourseText.addEventListener("click", ()=>{
      const courseId = pickedCourse();
      if(!courseId) return alert("è«‹å…ˆé¸ç”¨ä¸€é–€èª²");
      const text = exportCourseText(courseId);
      copyText(text);
      toast("å·²è¤‡è£½èª²ç¨‹ç´”æ–‡å­—");
    });
  }

  /* è¨­å®šï¼šåŒ¯å‡º/åŒ¯å…¥/æ¸…ç©º */
  const btnExport = document.getElementById("btnExport");
  if(btnExport){
    btnExport.addEventListener("click", ()=>{
      const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `angel-studio-backup-${APP.version}.json`;
      a.click();
      toast("å·²åŒ¯å‡ºå‚™ä»½");
    });
  }
  const fileImport = document.getElementById("fileImport");
  if(fileImport){
    fileImport.addEventListener("change", async ()=>{
      const f = fileImport.files && fileImport.files[0];
      if(!f) return;
      const txt = await f.text();
      try{
        const obj = JSON.parse(txt);
        if(!obj || typeof obj!=="object") throw new Error("bad");
        state = obj;
        // é˜²å‘†ï¼šç¼ºæ¬„ä½è£œä¸Š
        state.bookContent ||= [];
        state.courseContent ||= [];
        state.settings ||= {homepage:"", lastSeries:"å¹¸ç¦æ•™é¤Š"};
        saveState(state);
        toast("å·²åŒ¯å…¥");
        render();
      }catch(e){
        alert("åŒ¯å…¥å¤±æ•—ï¼šè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼ã€‚");
      }
    });
  }
  const btnWipe = document.getElementById("btnWipe");
  if(btnWipe){
    btnWipe.addEventListener("click", ()=>{
      if(!confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼Ÿï¼ˆç„¡æ³•å¾©åŸï¼Œè«‹å…ˆåŒ¯å‡ºå‚™ä»½ï¼‰")) return;
      localStorage.removeItem(APP.storageKey);
      state = loadState();
      toast("å·²æ¸…ç©º");
      render();
    });
  }

  /* ç¯©é¸ */
  document.querySelectorAll("[data-action='applyFilter']").forEach(btn=>{
    btn.addEventListener("click", ()=>applyFilter(btn.dataset.status, btn.dataset.prefix));
  });
  document.querySelectorAll("[data-action='clearFilter']").forEach(btn=>{
    btn.addEventListener("click", ()=>clearFilter(btn.dataset.status, btn.dataset.prefix));
  });
}

/* ===== æ›¸/èª²åŒ¯å‡ºæ–‡å­— ===== */
function exportBookText(bookId){
  const book = state.bookProjects.find(b=>b.id===bookId);
  if(!book) return "";
  const paras = state.bookContent.filter(p=>p.bookId===bookId);
  let out = `ã€æ›¸åã€‘${book.title}\nã€ç‹€æ…‹ã€‘${book.status}\nã€æ ¸å¿ƒã€‘${book.core||""}\nã€è®€è€…ã€‘${book.audience||""}\n\n`;
  const groups = {};
  paras.forEach(p=>{
    const ch = p.chapter || "ï¼ˆæœªåˆ†ç« ï¼‰";
    groups[ch] ||= [];
    groups[ch].push(p);
  });
  Object.keys(groups).sort().forEach(ch=>{
    out += `\n=== ${ch} ===\n`;
    groups[ch].forEach(p=>{
      out += `\n# ${p.title||"ï¼ˆæœªå‘½åæ®µè½ï¼‰"}\n${p.body||""}\n`;
    });
  });
  return out.trim();
}
function exportCourseText(courseId){
  const c = state.courseProjects.find(x=>x.id===courseId);
  if(!c) return "";
  const units = state.courseContent.filter(u=>u.courseId===courseId);
  let out = `ã€èª²ç¨‹ã€‘${c.title}\nã€å‹æ…‹ã€‘${c.type}\nã€ç‹€æ…‹ã€‘${c.status}\nã€æ‰¿è«¾ã€‘${c.promise||""}\nã€å°è±¡ã€‘${c.audience||""}\n\n`;
  const groups = {};
  units.forEach(u=>{
    const m = u.module || "ï¼ˆæœªåˆ†æ¨¡çµ„ï¼‰";
    groups[m] ||= [];
    groups[m].push(u);
  });
  Object.keys(groups).sort().forEach(m=>{
    out += `\n=== ${m} ===\n`;
    groups[m].forEach(u=>{
      out += `\n# ${u.unitTitle||"ï¼ˆæœªå‘½åå–®å…ƒï¼‰"}\n\nã€æ•…äº‹ã€‘\n${u.story||""}\n\nã€ç†è§£ã€‘\n${u.insight||""}\n\nã€ç·´ç¿’ã€‘\n${u.practice||""}\n\nã€å¸¶èµ°ã€‘\n${u.takeaway||""}\n`;
    });
  });
  return out.trim();
}

/* ===== Service Workerï¼ˆå…ˆä¿ç•™ï¼Œç­‰ä½ è¦é›¢ç·šå†è£œ sw.jsï¼‰ ===== */
if("serviceWorker" in navigator){
  window.addEventListener("load", async ()=>{
    try{
      await navigator.serviceWorker.register("sw.js");
      document.getElementById("syncState").textContent = "å¯é›¢ç·šä½¿ç”¨";
    }catch(e){
      document.getElementById("syncState").textContent = "æœªå•Ÿç”¨é›¢ç·š";
    }
  });
}
</script>
</body>
  </html>
