<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <meta name="theme-color" content="#0f3d2e" />
  <title>å¤©ä½¿ç¬‘é•·ï½œå‰µä½œå·¥ä½œå®¤ï¼ˆPWA v1.0ï¼‰</title>
  <link rel="manifest" href="manifest.json" />

  <style>
    :root{
      --bg:#0b2f24; --bg2:#0f3d2e; --card:#ffffff; --muted:#e7efe9;
      --text:#0b1b14; --sub:#51625a; --brand:#f0a04b; --danger:#c0392b; --ok:#1f7a52;
      --shadow:0 10px 30px rgba(0,0,0,.18); --r:18px;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family: ui-sans-serif, system-ui, -apple-system, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", sans-serif;
      background: radial-gradient(1200px 600px at 20% -10%, rgba(240,160,75,.25), transparent 60%),
                  linear-gradient(180deg, var(--bg), #071e17 80%);
      color:var(--muted);
    }
    header{position:sticky; top:0; z-index:10;
      background: linear-gradient(180deg, rgba(11,47,36,.96), rgba(11,47,36,.75));
      backdrop-filter: blur(8px);
      border-bottom: 1px solid rgba(255,255,255,.08);
    }
    .wrap{max-width:1120px;margin:0 auto;padding:16px;}
    .top{display:flex; gap:12px; align-items:center; justify-content:space-between; flex-wrap:wrap;}
    .brand{display:flex; align-items:center; gap:12px;}
    .brand .logo{
      width:44px;height:44px;border-radius:14px;display:grid;place-items:center;
      background: rgba(255,255,255,.08);border:1px solid rgba(255,255,255,.12);
      box-shadow: var(--shadow);font-weight:900;color:#fff;
    }
    .brand h1{font-size:16px;margin:0; letter-spacing:.3px}
    .brand p{margin:2px 0 0; font-size:12px; color:rgba(231,239,233,.78)}
    .pill{display:inline-flex; align-items:center; gap:8px;padding:10px 12px;border-radius:999px;
      background: rgba(255,255,255,.06);border:1px solid rgba(255,255,255,.10);
      color:rgba(231,239,233,.9);font-size:12px;
    }
    .pill b{color:#fff}
    nav{display:flex; gap:8px; overflow:auto; padding:12px 0 4px;}
    .tab{
      border:1px solid rgba(255,255,255,.12);background: rgba(255,255,255,.06);
      color:rgba(231,239,233,.88);padding:10px 12px;border-radius:999px;
      cursor:pointer; user-select:none;white-space:nowrap;font-size:13px;transition: .15s ease;
    }
    .tab:hover{transform: translateY(-1px)}
    .tab.active{background: rgba(240,160,75,.22);border-color: rgba(240,160,75,.45);color:#fff;}
    main{padding:18px 0 34px}
    .grid{display:grid; gap:14px}
    @media (min-width:900px){ .grid.two{grid-template-columns: 1.12fr .88fr} }
    .card{
      background: rgba(255,255,255,.95);color:var(--text);
      border-radius: var(--r);box-shadow: var(--shadow);
      border:1px solid rgba(255,255,255,.18);padding:16px;
    }
    .card h2{margin:0 0 8px; font-size:16px}
    .sub{color:var(--sub); font-size:12.5px; line-height:1.55}
    .row{display:flex; gap:10px; flex-wrap:wrap}
    .row > *{flex:1}
    label{display:block; font-size:12px; color:var(--sub); margin:8px 0 6px}
    input, select, textarea{
      width:100%; border-radius: 14px; border:1px solid rgba(0,0,0,.12);
      padding:11px 12px; font-size:14px; outline:none; background: #fff;
    }
    textarea{min-height:140px; resize:vertical; line-height:1.6}
    .btnbar{display:flex; gap:10px; flex-wrap:wrap; margin-top:10px}
    button{border:0; cursor:pointer; padding:10px 12px; border-radius: 14px; font-weight:800; font-size:13px;}
    .btn{background: var(--brand); color:#1f1204; box-shadow: 0 10px 18px rgba(240,160,75,.35);}
    .btn.secondary{background: #ecf4ef; color:#173326; border:1px solid rgba(0,0,0,.08); box-shadow:none;}
    .btn.danger{background: var(--danger); color:#fff}
    .btn.ghost{background: transparent; color:#173326; border:1px dashed rgba(0,0,0,.25);}
    .badge{display:inline-flex; align-items:center; padding:6px 10px; border-radius:999px;
      background: rgba(31,122,82,.10); color: var(--ok); font-weight:900; font-size:12px;
    }
    .badge.gray{background: rgba(0,0,0,.06); color:#3b4c44}
    .badge.orange{background: rgba(240,160,75,.18); color:#6c3b04}
    .hr{height:1px;background:rgba(0,0,0,.08);margin:14px 0}
    .list{display:grid; gap:10px}
    .item{border:1px solid rgba(0,0,0,.08); border-radius: 16px; padding:12px; background:#fff;}
    .itemhead{display:flex; justify-content:space-between; gap:10px; align-items:flex-start}
    .itemtitle{font-weight:900; font-size:14px; margin:0 0 2px}
    .meta{font-size:12px; color:var(--sub)}
    .tools{display:flex; gap:8px; flex-wrap:wrap; margin-top:10px}
    .mini{padding:7px 10px; border-radius: 12px; background:#ecf4ef; border:1px solid rgba(0,0,0,.08);
      font-weight:900; font-size:12px; color:#173326;
    }
    .mini.warn{background: rgba(240,160,75,.18); border-color: rgba(240,160,75,.25)}
    .mini.danger{background: rgba(192,57,43,.12); border-color: rgba(192,57,43,.18); color:#7a1d14}
    .kbd{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;
      font-size:12px; background: rgba(0,0,0,.06); padding:2px 6px; border-radius: 8px; border:1px solid rgba(0,0,0,.06);
    }
    .toast{
      position:fixed; left:50%; bottom:18px; transform:translateX(-50%);
      background: rgba(0,0,0,.78); color:#fff; padding:10px 12px; border-radius: 999px;
      font-size:13px; opacity:0; pointer-events:none; transition: .2s ease; z-index:999;
    }
    .toast.show{opacity:1}
    .hint{border-left:4px solid rgba(240,160,75,.75); background: rgba(240,160,75,.10);
      padding:10px 12px; border-radius: 14px; color:#1f1204; font-size:13px; line-height:1.6;
    }
    .small{font-size:12px;color:var(--sub);line-height:1.55}
    .split{display:flex; gap:10px; flex-wrap:wrap}
    .split > *{flex:1}
    .mono{font-family: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono","Courier New", monospace;}
    dialog{
      width:min(900px, 94vw);
      border:0; border-radius: 18px; padding:0; box-shadow: var(--shadow);
    }
    dialog::backdrop{background: rgba(0,0,0,.45)}
    .dlgHead{padding:14px 16px;background:#0f3d2e;color:#fff;border-radius: 18px 18px 0 0}
    .dlgBody{padding:14px 16px;background:#fff;color:#0b1b14}
    .dlgBody pre{white-space:pre-wrap; word-break:break-word; margin:0; line-height:1.7}
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo">å¹¸</div>
        <div>
          <h1>å¤©ä½¿ç¬‘é•·ï½œå‰µä½œå·¥ä½œå®¤ï¼ˆPWA v1.0ï¼‰</h1>
          <p>ç´ æåº«ï¼ˆç”Ÿå‘½æ•…äº‹ï¼‰Ã— å’’èªåŒ… Ã— å”ä½œæç¤º Ã— è‰ç¨¿/å®Œç¨¿ Ã— ç™¼ç‰‡æ‰“åŒ…</p>
        </div>
      </div>
      <div class="pill"><span>ç‹€æ…‹ï¼š</span><b id="syncState">æœ¬æ©Ÿå„²å­˜</b><span class="kbd">localStorage</span></div>
    </div>
    <nav id="nav"></nav>
  </div>
</header>

<main class="wrap"><div id="view"></div></main>

<div class="toast" id="toast">å·²è¤‡è£½</div>

<dialog id="dlg">
  <div class="dlgHead">
    <div style="font-weight:900" id="dlgTitle">å…¨æ–‡</div>
    <div style="opacity:.85;font-size:12px" id="dlgMeta"></div>
  </div>
  <div class="dlgBody">
    <div class="btnbar" style="margin-top:0">
      <button class="btn secondary" id="dlgCopy">è¤‡è£½å…¨æ–‡</button>
      <button class="btn secondary" id="dlgCopyPrompt">è¤‡è£½å”ä½œæç¤º</button>
      <button class="btn ghost" id="dlgClose">é—œé–‰</button>
    </div>
    <div class="hr"></div>
    <pre id="dlgText"></pre>
  </div>
</dialog>

<script>
/* =========================
   v1.0ï¼šåŠŸèƒ½æ“´å……ï¼ˆæ–°å¢ï¼šç´ æåº«ï¼‰
   ========================= */
const APP = { version:"v1.0", storageKey:"angel_studio_v1" };
const SERIES = ["å¹¸ç¦æ•™é¤Š","å¿ƒè…¦ç§‘å­¸","å¿ƒéˆæ„Ÿæ‚Ÿ","è©©è©äººç”Ÿ","å¹¸ç¦å°è…¦è¢‹","å…¶ä»–"];
const FORMATS = ["é•·å½±ç‰‡","çŸ­å½±ç‰‡","Podcast"];
const VIEWS = [
  { id:"sources", label:"ç´ æåº«ï¼ˆç”Ÿå‘½æ•…äº‹ï¼‰" }, // NEW
  { id:"create", label:"å‰µä½œå½±ç‰‡" },
  { id:"drafts", label:"æ–‡æ¡ˆè‰ç¨¿å€" },
  { id:"final",  label:"å®Œç¨¿å€" },
  { id:"pack",   label:"ç™¼ç‰‡æ‰“åŒ…å€" },
  { id:"settings", label:"è¨­å®šï¼å‚™ä»½" },
];

const SPELL = {
  "å¹¸ç¦æ•™é¤Š": {
    tone: "è¼•é¬†æº«é¦¨é™ªä¼´å£å»ï½œä¸èªªæ•™ï½œç«™åœ¨å®¶é•·èº«é‚Š",
    sections: ["é–‹å ´Hook","æ‰¿è«¾","å®Œæ•´æ•…äº‹","å¿ƒè…¦ç§‘å­¸è§£æ","å¥½ç”¨å·¥å…·ï¼ˆæ–¹æ³•ï¼‰","CTA"],
    ctaKeywords: "æŠŠå¿ƒç·´ç©©ã€å¤©ä½¿ç¬‘é•·ä¸»é ã€å¿ƒç†å­¸ã€è…¦ç¥ç¶“ç§‘å­¸ã€ç†è§£å’Œæ„›ã€é™ªä¼´ã€è¦ªå­ã€ä¸€èµ·æˆé•·ã€ä¸€èµ·æ¢è¨ã€åˆ†äº«ã€è®“æ›´å¤šå­©å­å®¶åº­å—æƒ ã€è¨‚é–±ã€ä¸éŒ¯éæ›´æ–°ã€æ¯é€±æ›´æ–°",
    ctaTemplate: "å¦‚æœä½ ä¹Ÿåœ¨ç·´ç¿’æŠŠå¿ƒç«™ç©©ï¼Œ\næ­¡è¿ä¾†åˆ°å¤©ä½¿ç¬‘é•·çš„ä¸»é ã€‚\né€™è£¡æœ‰å¿ƒç†å­¸ã€è…¦ç¥ç¶“ç§‘å­¸ã€å¿ƒéˆæˆé•·èˆ‡å¹¸ç¦æ•™é¤Šç³»åˆ—å…§å®¹ï¼Œ\né™ªä½ æŠŠå¿ƒï¼Œä¸€æ¬¡ä¸€æ¬¡æ”¾å›ä¸­é–“ã€‚\nï¼ˆæ¯é€±æ›´æ–°ï¼‰"
  },
  "å¿ƒè…¦ç§‘å­¸": {
    tone: "è¦ªæ°‘å¹½é»˜å£å»ï½œç”¨ç”Ÿæ´»æ¯”å–»èªªç§‘å­¸ï½œé™å°ˆæ¥­é–€æª»",
    sections: ["é–‹å ´Hook","æ‰¿è«¾","æ­£æ–‡ï¼ˆç™½è©±åŒ–ï¼Œ1000â€“2500å­—ï¼‰","CTA"],
    ctaKeywords: "ç†è§£ã€å¿ƒç©©å®šã€å¤©ä½¿ç¬‘é•·ç­–åŠƒå¿ƒç†å­¸è…¦ç¥ç¶“ç§‘å­¸ã€å¿ƒéˆæˆé•·ã€å¹¸ç¦æ•™é¤Šã€æ¯é€±æ›´æ–°",
    ctaTemplate: "å¦‚æœä½ ä¹Ÿå–œæ­¡ç”¨ç™½è©±æŠŠè…¦ç§‘å­¸èªªæ¸…æ¥šï¼Œ\næ­¡è¿åˆ°å¤©ä½¿ç¬‘é•·ä¸»é é€›é€›ã€‚\nå¿ƒç†å­¸Ã—è…¦ç¥ç¶“ç§‘å­¸Ã—å¿ƒéˆæˆé•·Ã—å¹¸ç¦æ•™é¤Šï¼Œ\né™ªä½ æŠŠç†è§£è®Šæˆç©©å®šã€‚ï¼ˆæ¯é€±æ›´æ–°ï¼‰"
  },
  "è©©è©äººç”Ÿ": {
    tone: "æ–‡é›…å“²å­¸å£å»ï½œæ²‰ç©©ç•™ç™½ï½œæ…¢æ…¢è®€",
    sections: ["é–‹å ´Hook","è©©è©ä½œè€…ç°¡ä»‹","è©©è©å‰µä½œèƒŒæ™¯","è©©è©å…¨æ–‡ï¼å…§å®¹","å¿ƒç†å­¸èˆ‡è…¦ç¥ç¶“å»¶ä¼¸","ç”Ÿæ´»å•é¡Œé‹ç”¨ï¼ˆ1000â€“1500å­—ï¼‰","CTA"],
    ctaKeywords: "å¿ƒè‡ªåœ¨ã€ç©©å®šã€å¤©ä½¿ç¬‘é•·ç­–åŠƒå¿ƒç†å­¸è…¦ç¥ç¶“ç§‘å­¸ã€å¿ƒéˆæˆé•·ã€å¹¸ç¦æ•™é¤Šã€æ¯é€±æ›´æ–°",
    ctaTemplate: "å¦‚æœä½ ä¹Ÿå–œæ­¡ç”¨è©©è©æŠŠå¿ƒæ…¢æ…¢æ”¾é¬†ï¼Œ\næ­¡è¿åˆ°å¤©ä½¿ç¬‘é•·ä¸»é ã€‚\nå¿ƒç†å­¸Ã—è…¦ç¥ç¶“ç§‘å­¸Ã—å¿ƒéˆæˆé•·Ã—å¹¸ç¦æ•™é¤Šï¼Œ\né™ªä½ æ´»å¾—æ›´è‡ªåœ¨ã€‚ï¼ˆæ¯é€±æ›´æ–°ï¼‰"
  },
  "å¿ƒéˆæ„Ÿæ‚Ÿ": {
    tone: "å“²æ€ã€ç™¼äººæ·±çœå£å»ï½œä¸æ€¥è‘—ä¸‹çµè«–ï½œå…è¨±ç•™ç™½",
    sections: ["éˆæ„Ÿé—œéµå­—ï¼ˆå»¶ä¼¸æˆ1000â€“1500å­—çŸ­æ–‡ï¼‰","CTA"],
    ctaKeywords: "å¿ƒè‡ªåœ¨ã€ç©©å®šã€å¤©ä½¿ç¬‘é•·ç­–åŠƒå¿ƒç†å­¸è…¦ç¥ç¶“ç§‘å­¸ã€å¿ƒéˆæˆé•·ã€å¹¸ç¦æ•™é¤Šã€æ¯é€±æ›´æ–°",
    ctaTemplate: "å¦‚æœä½ ä¹Ÿåœ¨ç·´ç¿’ä¸æ€¥è‘—è§£é‡‹ã€å…ˆæŠŠå¿ƒæ”¾å›ä¸­é–“ï¼Œ\næ­¡è¿åˆ°å¤©ä½¿ç¬‘é•·ä¸»é ã€‚\nå¿ƒç†å­¸Ã—è…¦ç¥ç¶“ç§‘å­¸Ã—å¿ƒéˆæˆé•·Ã—å¹¸ç¦æ•™é¤Šï¼Œ\né™ªä½ æ›´ç©©ã€æ›´è‡ªåœ¨ã€‚ï¼ˆæ¯é€±æ›´æ–°ï¼‰"
  },
  "å¹¸ç¦å°è…¦è¢‹": {
    tone: "æ·ºé¡¯æ˜“æ‡‚ï½œè¼•é¬†æ´»æ½‘å£å»ï½œè¦ªå­å…±è®€å‹å–„",
    sections: ["ä¸»é¡Œï¼ˆå»¶ä¼¸æˆ1000â€“1500å­—çŸ­æ–‡ï¼‰","çµ¦å®¶é•·çš„å°æé†’","å…±è®€æå•ï¼å°ç·´ç¿’","CTA"],
    ctaKeywords: "æé†’å®¶é•·ã€é™ªä¼´å…±è®€ã€å¤©ä½¿ç¬‘é•·",
    ctaTemplate: "æé†’å®¶é•·ï¼šé™ªå­©å­ä¸€èµ·è®€ã€ä¸€èµ·ç·´ï¼Œ\næ¯”ä½ è¬›ä¸€ç™¾å¥æ›´æœ‰ç”¨ã€‚\nâ€” å¤©ä½¿ç¬‘é•·"
  },
  "å…¶ä»–": {
    tone: "ä»¥ä½ ç•¶ä¸‹çš„èªæ„Ÿç‚ºä¸»ï½œä¿ç•™çœŸå¯¦ç¾å ´",
    sections: ["é–‹å ´","æ­£æ–‡","æ”¶æŸ","CTAï¼ˆå¯é¸ï¼‰"],
    ctaKeywords: "å¤©ä½¿ç¬‘é•·ä¸»é ã€ç†è§£ã€é™ªä¼´",
    ctaTemplate: "æƒ³çœ‹æ›´å¤šå…§å®¹ï¼Œæ­¡è¿åˆ°å¤©ä½¿ç¬‘é•·ä¸»é ã€‚"
  }
};

function nowISO(){ return new Date().toISOString(); }
function uid(){ return Math.random().toString(16).slice(2)+"-"+Date.now().toString(16); }
function fmtDate(iso){
  const d = new Date(iso);
  const pad = n => String(n).padStart(2,"0");
  return `${d.getFullYear()}/${pad(d.getMonth()+1)}/${pad(d.getDate())} ${pad(d.getHours())}:${pad(d.getMinutes())}`;
}
function escapeHtml(s){ return String(s||"").replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function toast(msg="å·²å®Œæˆ"){
  const t = document.getElementById("toast");
  t.textContent = msg;
  t.classList.add("show");
  setTimeout(()=>t.classList.remove("show"), 1300);
}
async function copyText(text){
  try{ await navigator.clipboard.writeText(text); toast("å·²è¤‡è£½"); }
  catch(e){
    const ta = document.createElement("textarea");
    ta.value = text; document.body.appendChild(ta); ta.select(); document.execCommand("copy"); ta.remove();
    toast("å·²è¤‡è£½ï¼ˆå‚™æ´ï¼‰");
  }
}

/* ===== å„²å­˜ ===== */
function loadState(){
  try{
    const raw = localStorage.getItem(APP.storageKey);
    if(!raw) return {
      sources:[],           // NEW
      entries:[],
      settings:{homepage:"", lastSeries:"å¹¸ç¦æ•™é¤Š"}
    };
    const s = JSON.parse(raw);
    s.sources ||= [];
    s.entries ||= [];
    s.settings ||= {homepage:"", lastSeries:"å¹¸ç¦æ•™é¤Š"};
    return s;
  }catch(e){
    return { sources:[], entries:[], settings:{homepage:"", lastSeries:"å¹¸ç¦æ•™é¤Š"} };
  }
}
function saveState(s){ localStorage.setItem(APP.storageKey, JSON.stringify(s)); }
let state = loadState();

/* ===== å°è¦½ ===== */
let current = "sources";
function renderNav(){
  const nav = document.getElementById("nav");
  nav.innerHTML = VIEWS.map(v => `<div class="tab ${v.id===current?'active':''}" data-id="${v.id}">${v.label}</div>`).join("");
  nav.querySelectorAll(".tab").forEach(t=>{
    t.addEventListener("click",()=>{ current=t.dataset.id; render(); });
  });
}

/* =========================
   ç´ æåº«ï¼ˆç”Ÿå‘½æ•…äº‹ï¼‰- NEW
   ========================= */
function buildSourceText(src){
  // è®“ç´ æé€²åˆ°ã€Œå‰µä½œã€æ™‚ï¼Œå‘ˆç¾ç‚ºä¸€ä»½ä¹¾æ·¨çš„â€œåŸæ–‡ç´ æâ€
  const parts = [];
  parts.push(`ã€æ•…äº‹æ¨™é¡Œã€‘\n${src.title||""}`.trim());
  if(src.scene) parts.push(`ã€ç”Ÿå‘½å ´æ™¯ã€‘\n${src.scene}`);
  if(src.dialogue) parts.push(`ã€ç¾å ´å°è©±ï¼åŸå¥ã€‘\n${src.dialogue}`);
  if(src.feelings) parts.push(`ã€æˆ‘çš„æ„Ÿå—ï¼å…§åœ¨è§€å¯Ÿã€‘\n${src.feelings}`);
  if(src.insight) parts.push(`ã€æˆ‘çš„æ´å¯Ÿã€‘\n${src.insight}`);
  if(src.keepLines) parts.push(`ã€æƒ³ä¿ç•™çš„åŸå¥ï¼èªæ„Ÿã€‘\n${src.keepLines}`);
  if(src.lesson) parts.push(`ã€æˆ‘æƒ³é™ªå­©å­ï¼å¤§äººå­¸åˆ°ä»€éº¼ã€‘\n${src.lesson}`);
  if(src.notes) parts.push(`ã€è£œå……ã€‘\n${src.notes}`);
  return parts.join("\n\n").trim();
}

function sourcePrompt(src){
  const homepage = (state.settings.homepage||"").trim();
  const homeLine = homepage ? `\nä¸»é é€£çµï¼š${homepage}\n` : "\n";
  return `æˆ‘æ­£åœ¨å»ºç«‹ã€Œç´ æåº«ï¼ˆç”Ÿå‘½æ•…äº‹ï¼‰ã€ã€‚
è«‹ä½ å¹«æˆ‘æŠŠä¸‹é¢é€™æ®µç´ æï¼Œåšæˆã€Œå¯è½‰å…¥å£èªªç¨¿ï¼æ›¸ç¨¿ï¼èª²ç¨‹ã€çš„ä¹¾æ·¨éª¨æ¶ï¼Œä½†å…ˆä¸è¦å¯«æˆå£èªªç¨¿æˆå“ã€‚

ã€ä½ çš„ä»»å‹™ã€‘
1) å¹«æˆ‘æŠ“å‡ºï¼šé€™å€‹æ•…äº‹æœ€é—œéµçš„ã€ä¸€å€‹ç¬é–“ã€
2) å¹«æˆ‘æç…‰ï¼šä¸€å¥æ ¸å¿ƒæ´å¯Ÿï¼ˆæº«æŸ”ä¸èªªæ•™ï¼‰
3) å¹«æˆ‘åˆ—å‡ºï¼šä¸‰å€‹å¯å»¶ä¼¸æ–¹å‘
   - å£èªªç¨¿æ–¹å‘ï¼ˆé™ªä¼´å¼ï¼‰
   - æ›¸ç¨¿æ–¹å‘ï¼ˆå¯åè¦†é–±è®€ã€ç•™ç™½ã€æ®µè½ï¼‰
   - èª²ç¨‹æ–¹å‘ï¼ˆè¦ç·´çš„èƒ½åŠ› + 30â€“60ç§’ç·´ç¿’ï¼‰
4) å¹«æˆ‘ä¿ç•™æˆ‘åŸå¥çš„èªæ„Ÿï¼ˆå°¤å…¶æ˜¯æˆ‘èªªéçš„è©±ï¼‰

${homeLine}
ã€ç´ ææ¨™é¡Œã€‘
${src.title||""}

ã€ç´ æå…¨æ–‡ã€‘
${buildSourceText(src)}`.trim();
}

/* ===== å”ä½œæç¤ºï¼ˆå£èªªç¨¿/ç³»åˆ—ï¼‰ ===== */
function baseCollabPrompt(series, dir, entry){
  const sp = SPELL[series] || SPELL["å…¶ä»–"];
  const homepage = (state.settings.homepage||"").trim();
  const homeLine = homepage ? `\nä¸»é é€£çµï¼š${homepage}` : "";
  const dirMap = {
    "æ›¸ç¨¿":"è«‹æŠŠé€™æ®µå…§å®¹æ•´ç†æˆã€Šå¹¸ç¦æ•™é¤Šã€‹å¯å…¥æ›¸çš„æ›¸ç¨¿æ®µè½ï¼ˆç´„ 1500â€“2500 å­—ï¼‰ï¼Œæ•˜äº‹è¦æœ‰ç•«é¢ã€ç¯€å¥è‡ªç„¶ã€æ´å¯Ÿæº«æŸ”ç¯¤å®šã€‚è«‹ä¿ç•™æˆ‘çš„åŸå¥èˆ‡å£æ°£ã€‚",
    "èª²ç¨‹":"è«‹æŠŠé€™æ®µå…§å®¹è½‰åŒ–æˆä¸€å€‹èª²ç¨‹å–®å…ƒï¼šåŒ…å«ã€Œä¸€å€‹æ•…äº‹ / ä¸€å€‹ç†è§£ï¼ˆç™½è©±å¿ƒè…¦è½‰è­¯ï¼‰/ ä¸€å€‹ç·´ç¿’ï¼ˆ30â€“60ç§’å¯åšï¼‰/ ä¸€å¥å¸¶èµ°çš„è©±ã€ã€‚",
    "å·¥å…·":"è«‹å¾é€™æ®µå…§å®¹æ‰¾å‡ºã€æœ€éœ€è¦è¢«æ‰¶ä½çš„ç¬é–“ã€ï¼Œè¨­è¨ˆä¸€å€‹ 30â€“60 ç§’å…§å®Œæˆçš„å°å·¥å…·ï¼ˆæ­¥é©Ÿæ¸…æ¥šã€å¯ç•¶å ´ä½¿ç”¨ï¼‰ã€‚",
    "ç™¼ç‰‡":"è«‹æŠŠé€™æ®µå…§å®¹æ•´ç†æˆç™¼ç‰‡ç”¨çš„å¤§ç¶±ï¼šHook/æ‰¿è«¾/æ•…äº‹/ç†è§£/å·¥å…·æŒ‡è·¯/CTAã€‚ä¸è¦é€å­—å£èªªç¨¿ï¼Œåªè¦çµæ§‹èˆ‡è¦é»ã€‚"
  };
  return `è«‹ä¾ã€Œ${series}ã€ç³»åˆ—çš„æ–‡æ¡ˆå’’èªåŒ…å”åŠ©æˆ‘ã€‚
èªæ„Ÿï¼š${sp.tone}
å¿…é ˆä¿ç•™ç”Ÿæ´»ç¾å ´èˆ‡æˆ‘çš„çœŸå¯¦èªæ°£ï¼ˆä¸èªªæ•™ï¼‰ã€‚${homeLine}

ã€æˆ‘å¸Œæœ›ä½ å¹«æˆ‘åšçš„äº‹ã€‘
${dirMap[dir]||dirMap["æ›¸ç¨¿"]}

ã€ç³»åˆ—å’’èªçµæ§‹ã€‘
- ${sp.sections.join("\n- ")}

ã€CTA é—œéµå­—æ± ã€‘
${sp.ctaKeywords}

ã€ä¸»é¡Œã€‘
${entry.topic}

ã€åŸæ–‡ï¼ç´ æã€‘
${entry.body}

ã€è£œå……ã€‘
${entry.notes || "ï¼ˆç„¡ï¼‰"}`.trim();
}

function updateCollabPrompt(){
  const series = document.getElementById("series")?.value || state.settings.lastSeries || "å¹¸ç¦æ•™é¤Š";
  const entry = {
    topic:(document.getElementById("topic")?.value||"").trim(),
    body:(document.getElementById("body")?.value||"").trim(),
    notes:(document.getElementById("notes")?.value||"").trim(),
  };
  const dir = document.getElementById("collabDir")?.value || "æ›¸ç¨¿";
  const box = document.getElementById("collabPrompt");
  if(!box) return;
  box.value = baseCollabPrompt(series, dir, entry);
}

/* ===== Entries ===== */
function upsertEntry(payload){
  payload.updatedAt = nowISO();
  if(!payload.id){
    payload.id = uid();
    payload.createdAt = nowISO();
    state.entries.unshift(payload);
  }else{
    const idx = state.entries.findIndex(x=>x.id===payload.id);
    if(idx>=0) state.entries[idx] = {...state.entries[idx], ...payload};
    else { payload.createdAt = nowISO(); state.entries.unshift(payload); }
  }
  saveState(state);
}

function getEntryForm(){
  const series = document.getElementById("series").value;
  const format = document.getElementById("format").value;
  const topic = (document.getElementById("topic").value||"").trim();
  const body = (document.getElementById("body").value||"").trim();
  const notes = (document.getElementById("notes").value||"").trim();
  const collabDir = document.getElementById("collabDir").value;
  const id = (document.getElementById("entryId").value||"").trim();
  if(!topic) return alert("è«‹å…ˆå¡«ã€Œä¸»é¡Œã€"), null;
  if(!body) return alert("è«‹å…ˆå¡«ã€Œå…¨æ–‡ï¼æ•…äº‹ï¼æ­£æ–‡ã€"), null;
  return { id:id||"", series, format, topic, body, notes, collabDir };
}

/* ===== Components ===== */
function EntryCard(e){
  const isFinal = e.status==="final";
  const b = isFinal ? "badge" : "badge gray";
  const tag = isFinal ? "å®Œç¨¿" : "è‰ç¨¿";
  const dir = e.collabDir ? `<span class="badge orange">${escapeHtml(e.collabDir)}</span>` : "";
  const snippet = (e.body||"").slice(0,120).replace(/\n/g," ");
  return `
    <div class="item">
      <div class="itemhead">
        <div>
          <div class="itemtitle">${escapeHtml(e.topic)}</div>
          <div class="meta">${escapeHtml(e.series)}ï½œ${escapeHtml(e.format)}ï½œ${fmtDate(e.updatedAt||e.createdAt)}</div>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end">
          <span class="${b}">${tag}</span>${dir}
        </div>
      </div>
      <div class="small" style="margin-top:8px">${escapeHtml(snippet)}${(e.body||"").length>120?"â€¦":""}</div>
      <div class="tools">
        <button class="mini" data-action="openEntry" data-id="${e.id}">é–‹å•Ÿå…¨æ–‡</button>
        <button class="mini" data-action="editEntry" data-id="${e.id}">ç·¨è¼¯</button>
        <button class="mini warn" data-action="toggleEntry" data-id="${e.id}">${isFinal?"è½‰è‰ç¨¿":"è½‰å®Œç¨¿"}</button>
        <button class="mini danger" data-action="delEntry" data-id="${e.id}">åˆªé™¤</button>
      </div>
    </div>`;
}

function SourceCard(s){
  const snippet = buildSourceText(s).slice(0,120).replace(/\n/g," ");
  return `
    <div class="item">
      <div class="itemhead">
        <div>
          <div class="itemtitle">${escapeHtml(s.title||"ï¼ˆæœªå‘½åç´ æï¼‰")}</div>
          <div class="meta">ç´ æï½œ${fmtDate(s.updatedAt||s.createdAt)}</div>
        </div>
        <div style="display:flex; gap:8px; flex-wrap:wrap; justify-content:flex-end">
          <span class="badge orange">ç”Ÿå‘½æ•…äº‹</span>
        </div>
      </div>
      <div class="small" style="margin-top:8px">${escapeHtml(snippet)}${buildSourceText(s).length>120?"â€¦":""}</div>
      <div class="tools">
        <button class="mini" data-action="openSource" data-id="${s.id}">é–‹å•Ÿå…¨æ–‡</button>
        <button class="mini" data-action="editSource" data-id="${s.id}">ç·¨è¼¯</button>
        <button class="mini warn" data-action="toCreate" data-id="${s.id}">è½‰å…¥å‰µä½œ</button>
        <button class="mini" data-action="copySourcePrompt" data-id="${s.id}">è¤‡è£½ç´ æå”ä½œæç¤º</button>
        <button class="mini danger" data-action="delSource" data-id="${s.id}">åˆªé™¤</button>
      </div>
    </div>`;
}

function buildSpellCard(series){
  const sp = SPELL[series] || SPELL["å…¶ä»–"];
  const secs = sp.sections.map(s=>`<li>${escapeHtml(s)}</li>`).join("");
  return `
    <div class="card">
      <h2>ğŸª„ æ–‡æ¡ˆå’’èªåŒ…ï½œ${escapeHtml(series)}</h2>
      <div class="sub">${escapeHtml(sp.tone)}</div>
      <div class="hr"></div>
      <div class="split">
        <div>
          <div class="small"><b>çµæ§‹æé†’ï¼ˆä¾ç³»åˆ—ä¸åŒï¼‰</b></div>
          <ul class="small" style="margin:8px 0 0; padding-left:18px; line-height:1.7">${secs}</ul>
        </div>
        <div>
          <div class="small"><b>CTA é—œéµå­—æ± </b></div>
          <div class="small" style="margin-top:8px">${escapeHtml(sp.ctaKeywords)}</div>
          <div class="hr"></div>
          <div class="hint"><b>å°æé†’ï¼š</b>å…ˆå¯«çœŸå¯¦ï¼Œå†ç”¨å’’èªåŒ…æŠŠè·¯ç…§äº®ã€‚</div>
        </div>
      </div>
    </div>
  `;
}

/* =========================
   Views
   ========================= */
function SourcesView(){
  return `
  <div class="grid two">
    <div class="card">
      <h2>ğŸ“š ç´ æåº«ï¼ˆç”Ÿå‘½æ•…äº‹ï¼‰</h2>
      <div class="sub">ç´ æä¸æ˜¯ç¨¿ä»¶ã€‚å®ƒæ˜¯ã€Œæºé ­ã€ï¼šå…ˆå­˜çœŸå¯¦ï¼Œå†æ±ºå®šè¦è½‰å…¥å£èªªç¨¿ï¼æ›¸ç¨¿ï¼èª²ç¨‹ã€‚</div>
      <div class="hr"></div>

      <input type="hidden" id="sourceId" value="" />

      <label>ç´ ææ¨™é¡Œï¼ˆå»ºè­°ç”¨ä¸€å¥è©±å‘½åï¼‰</label>
      <input id="srcTitle" placeholder="ä¾‹ï¼šè¶…å¸‚è£¡è«‡é›¶ç”¨éŒ¢åƒ¹ç¢¼ï¼šå­©å­çš„ã€ç­‰ä¸€ä¸‹ã€æ€éº¼é•·å‡ºä¾†" />

      <label>ç”Ÿå‘½å ´æ™¯ï¼ˆäº‹æƒ…æ€éº¼ç™¼ç”Ÿçš„ï¼‰</label>
      <textarea id="srcScene" placeholder="ä¾‹ï¼šæ”¾å­¸å¾Œå»è¶…å¸‚â€¦æˆ‘å’Œå“¥å“¥è«‡é›¶ç”¨éŒ¢â€¦"></textarea>

      <label>ç¾å ´å°è©±ï¼åŸå¥ï¼ˆä¿ç•™ä½ åŸè©±ï¼Œå¾ˆçè²´ï¼‰</label>
      <textarea id="srcDialogue" placeholder="ä¾‹ï¼šã€æœ‰éŒ¢ç…©æƒ±ï¼Œæ²’éŒ¢ä¹Ÿç…©æƒ±â€¦ã€"></textarea>

      <label>æˆ‘çš„æ„Ÿå—ï¼å…§åœ¨è§€å¯Ÿï¼ˆä½ æ€éº¼çœ‹è¦‹è‡ªå·±/å­©å­ï¼‰</label>
      <textarea id="srcFeelings" placeholder="ä¾‹ï¼šæˆ‘çœ‹è¦‹ä»–é–‹å§‹æœ‰ç…©æƒ±â€¦å¦¹å¦¹æ·¡å®šâ€¦"></textarea>

      <label>æˆ‘çš„æ´å¯Ÿï¼ˆä¸å¿…æ•™ï¼Œåªè¦çœ‹è¦‹ï¼‰</label>
      <textarea id="srcInsight" placeholder="ä¾‹ï¼šæ…¾æœ›éœ€è¦å­¸æœƒå’Œå¹³å…±è™•â€¦æ”¶å…¥å¤šå°‘æ‰å¤ ç”¨â€¦"></textarea>

      <label>æƒ³ä¿ç•™çš„åŸå¥ï¼èªæ„Ÿï¼ˆå¿…ç•™ï¼‰</label>
      <textarea id="srcKeepLines" placeholder="ä¾‹ï¼šã€éŒ¢æ¯”äººå‰å¤§ï¼ã€ã€ç„¡æ¬²å‰‡å‰›ï¼ã€"></textarea>

      <label>æˆ‘æƒ³é™ªå­©å­ï¼å¤§äººå­¸åˆ°ä»€éº¼ï¼ˆå¯ç©ºï¼‰</label>
      <textarea id="srcLesson" placeholder="ä¾‹ï¼šæŠŠã€ç­‰ä¸€ä¸‹ã€ç·´å‡ºä¾†ï¼›å­¸æœƒæ¬²æœ›èˆ‡é‡‘éŒ¢çš„å¹³è¡¡â€¦"></textarea>

      <label>è£œå……ï¼ˆå¯ç©ºï¼‰</label>
      <textarea id="srcNotes" placeholder="ä¾‹ï¼šè¦å»¶ä¼¸æˆé›¶ç”¨éŒ¢ç·´åŠŸæˆ¿å·¥å…·ï¼è¦æ”¾é€²æ›¸çš„å“ªä¸€ç« â€¦"></textarea>

      <div class="btnbar">
        <button class="btn" id="btnSaveSource">å­˜ç´ æ</button>
        <button class="btn secondary" id="btnSaveSourceNew">å­˜ç´ æä¸¦æ¸…ç©º</button>
        <button class="btn secondary" id="btnCopySourceText">è¤‡è£½ç´ æå…¨æ–‡</button>
        <button class="btn ghost" id="btnResetSource">æ¸…ç©ºæ¬„ä½</button>
      </div>

      <div class="hr"></div>
      <div class="hint">
        <b>ç”¨æ³•ï¼š</b>å…ˆæŠŠç”Ÿå‘½ç¾å ´ä¸Ÿé€²ä¾† â†’ å†æŒ‰å¡ç‰‡ä¸Šçš„ã€Œè½‰å…¥å‰µä½œã€ï¼Œ
        ç³»çµ±æœƒè‡ªå‹•æŠŠç´ ææ•´ç†æˆä¸€ä»½ä¹¾æ·¨åŸæ–‡ï¼Œè®“ä½ ç”¨å’’èªåŒ…å»ç”¢å‡ºä¸åŒç³»åˆ—çš„å£èªªç¨¿ã€‚
      </div>
    </div>

    <div class="grid" style="gap:14px">
      <div class="card">
        <h2>ğŸ” ç´ ææª¢ç´¢</h2>
        <div class="sub">ç”¨æ¨™é¡Œé—œéµå­—å¿«é€Ÿæ‰¾ä½ çš„æ•…äº‹ã€‚</div>
        <div class="row">
          <div>
            <label>é—œéµå­—</label>
            <input id="srcKw" placeholder="è¼¸å…¥é—œéµå­—â€¦" />
          </div>
          <div style="display:flex;align-items:flex-end">
            <button class="btn secondary" id="btnFilterSource">å¥—ç”¨</button>
          </div>
        </div>
        <div class="btnbar">
          <button class="btn ghost" id="btnClearFilterSource">æ¸…é™¤</button>
        </div>
        <div class="hr"></div>
        <div class="list" id="sourceList">
          ${state.sources.map(SourceCard).join("") || `<div class="sub">é‚„æ²’æœ‰ç´ æã€‚å…ˆæŠŠä½ çš„æ•…äº‹å­˜é€²ä¾†ã€‚</div>`}
        </div>
      </div>

      <div class="card">
        <h2>ğŸ§¡ ä¸»é ï¼ˆå¯é¸ï¼‰</h2>
        <div class="sub">å¡«äº†å¾Œã€Œç´ æå”ä½œæç¤ºã€èˆ‡ã€Œå£èªªç¨¿å”ä½œæç¤ºã€æœƒè‡ªå‹•å¸¶å…¥ã€‚</div>
        <label>ä¸»é é€£çµ</label>
        <input id="homepage0" placeholder="https://..." value="${escapeHtml(state.settings.homepage||"")}" />
        <div class="btnbar"><button class="btn secondary" id="btnSaveHome0">å„²å­˜ä¸»é </button></div>
      </div>
    </div>
  </div>`;
}

function CreateView(){
  const last = state.settings.lastSeries || "å¹¸ç¦æ•™é¤Š";
  return `
  <div class="grid two">
    <div class="grid" style="gap:14px">
      <div class="card">
        <h2>ğŸ“ å‰µä½œå½±ç‰‡ï½œåŸæ–‡è¼¸å…¥</h2>
        <div class="sub">é€™è£¡æ”¾ã€Œå¯ç”Ÿæˆç¨¿ä»¶çš„åŸæ–‡ã€ã€‚é€šå¸¸ä¾†è‡ªç´ æåº«ä¸€éµè½‰å…¥ã€‚</div>
        <input type="hidden" id="entryId" value="" />
        <input type="hidden" id="fromSourceId" value="" />

        <div class="row">
          <div>
            <label>ç³»åˆ—åç¨±</label>
            <select id="series">
              ${SERIES.map(s=>`<option ${s===last?'selected':''}>${s}</option>`).join("")}
            </select>
          </div>
          <div>
            <label>ç‰‡å‹</label>
            <select id="format">${FORMATS.map(f=>`<option>${f}</option>`).join("")}</select>
          </div>
        </div>

        <label>ä¸»é¡Œ</label>
        <input id="topic" placeholder="ä¾‹ï¼šç„¡æ¬²å‰‡å‰›ï¼šå­©å­å­¸æœƒã€ç­‰ä¸€ä¸‹ã€ï¼Œé¸æ“‡åŠ›å°±é–‹å§‹é•·å‡ºä¾†" />

        <label>å…¨æ–‡ï¼æ•…äº‹ï¼æ­£æ–‡ï¼ˆå¾ç´ æè½‰å…¥çš„åŸæ–‡ï¼‰</label>
        <textarea id="body" placeholder="æŠŠä½ èµ°éçš„ã€ç”Ÿå‘½ç¾å ´ã€è²¼é€²ä¾†å°±å¥½ã€‚"></textarea>

        <label>è£œå……ï¼ˆå¯é¸ï¼‰</label>
        <textarea id="notes" placeholder="ä¾‹å¦‚ï¼šè¦ä¿ç•™çš„åŸå¥ï¼ä½ å¸Œæœ›åŠ å¼·çš„è§’åº¦â€¦"></textarea>

        <div class="hr"></div>

        <label>å”ä½œæ–¹å‘ï¼ˆä½ è¦æˆ‘å¹«ä½ èµ°åˆ°å“ªï¼‰</label>
        <select id="collabDir">
          <option>æ›¸ç¨¿</option><option>èª²ç¨‹</option><option>å·¥å…·</option><option>ç™¼ç‰‡</option>
        </select>

        <label>ä¸€éµå”ä½œæç¤ºï¼ˆè¤‡è£½è²¼çµ¦æˆ‘ï¼‰</label>
        <textarea id="collabPrompt" class="mono" style="min-height:190px"></textarea>

        <div class="btnbar">
          <button class="btn secondary" id="btnCopyPrompt">è¤‡è£½å”ä½œæç¤º</button>
          <button class="btn" id="btnSaveDraft">å…ˆå­˜è‰ç¨¿</button>
          <button class="btn" id="btnSaveFinal">å­˜ç‚ºå®Œç¨¿</button>
          <button class="btn ghost" id="btnReset">æ¸…ç©ºè¼¸å…¥</button>
        </div>

        <div class="hr"></div>
        <div class="small">
          <b>å°æé†’ï¼š</b>ä½ è‹¥æ˜¯å¾ç´ æåº«è½‰å…¥ï¼Œé€™è£¡æœƒä¿ç•™ã€Œç´ æä¾†æºã€ï¼Œä»¥å¾Œåšæ›¸/èª²ç¨‹æ™‚èƒ½è¿½æº¯ã€‚
        </div>
      </div>

      <div class="card">
        <h2>ğŸ“Œ å¿«é€Ÿå›é¡§</h2>
        <div class="sub">ç´ æï¼š${state.sources.length}ã€€ï½œã€€è‰ç¨¿ï¼š${state.entries.filter(e=>e.status==="draft").length}ã€€ï½œã€€å®Œç¨¿ï¼š${state.entries.filter(e=>e.status==="final").length}</div>
        <div class="hr"></div>
        <div class="list">
          ${state.entries.slice(0,3).map(EntryCard).join("") || `<div class="sub">é‚„æ²’æœ‰ç¨¿ä»¶å…§å®¹ã€‚ä½ å¯ä»¥å…ˆå¾ç´ æåº«è½‰å…¥ã€‚</div>`}
        </div>
      </div>
    </div>

    <div class="grid" style="gap:14px">
      ${buildSpellCard(last)}
      <div class="card">
        <h2>ğŸª¶ å”ä½œæé†’</h2>
        <div class="sub">ä½ è² è²¬ã€ŒçœŸå¯¦ã€ï¼Œæˆ‘è² è²¬ã€Œçµæ§‹èˆ‡è½‰åŒ–ã€ã€‚ä¸ç”¨ä¸€æ¬¡å®Œæˆï¼Œåªè¦å…ˆç•™ä¸‹ç”Ÿå‘½ç¾å ´ã€‚</div>
        <div class="hr"></div>
        <div class="hint"><b>æ›´é †çš„æµç¨‹ï¼š</b>å…ˆå­˜ç´ æ â†’ å†è½‰å…¥å‰µä½œ â†’ å†ç”¨ç³»åˆ—å’’èªåŒ…å‡ºç¨¿ã€‚</div>
      </div>
    </div>
  </div>`;
}

function FilterBar(idPrefix, status){
  return `
    <div class="row">
      <div>
        <label>ç³»åˆ—ç¯©é¸</label>
        <select id="${idPrefix}Series"><option value="">å…¨éƒ¨</option>${SERIES.map(s=>`<option value="${escapeHtml(s)}">${escapeHtml(s)}</option>`).join("")}</select>
      </div>
      <div>
        <label>ä¸»é¡Œé—œéµå­—</label>
        <input id="${idPrefix}Kw" placeholder="è¼¸å…¥é—œéµå­—â€¦" />
      </div>
    </div>
    <div class="btnbar">
      <button class="btn secondary" data-action="applyFilter" data-status="${status}" data-prefix="${idPrefix}">å¥—ç”¨ç¯©é¸</button>
      <button class="btn ghost" data-action="clearFilter" data-status="${status}" data-prefix="${idPrefix}">æ¸…é™¤</button>
    </div>
  `;
}

function ListView(status){
  const title = status==="draft" ? "ğŸŒ± æ–‡æ¡ˆè‰ç¨¿å€" : "ğŸŒ³ å®Œç¨¿å€";
  const list = state.entries.filter(e=>e.status===status);
  const prefix = status==="draft" ? "d" : "f";
  return `
    <div class="card">
      <h2>${title}</h2>
      <div class="sub">ä¾ç³»åˆ—åˆ†é¡ï¼‹ä¸»é¡Œæª¢ç´¢ï½œå¯é–‹å•Ÿå…¨æ–‡ã€è¤‡è£½å…¨æ–‡ã€è¤‡è£½å”ä½œæç¤º</div>
      <div class="hr"></div>
      ${FilterBar(prefix, status)}
      <div class="hr"></div>
      <div class="list" id="${prefix}List">
        ${list.map(EntryCard).join("") || `<div class="sub">ç›®å‰æ²’æœ‰å…§å®¹ã€‚</div>`}
      </div>
    </div>
  `;
}

/* ===== æ‰“åŒ… ===== */
function generateDescription(e, kind="video"){
  const homepage = (state.settings.homepage||"").trim();
  const home = homepage ? `\n\nğŸ‘‰ ä¸»é ï¼š${homepage}` : "";
  const tags = ["#å¹¸ç¦æ•™é¤Š","#å¿ƒç†å­¸","#è…¦ç¥ç¶“ç§‘å­¸","#å¿ƒéˆæˆé•·","#è¦ªå­"].join(" ");
  const base = `ã€${e.topic}ã€‘\n\nï¼ˆåœ¨é€™è£¡æ”¾ä½ çš„å½±ç‰‡æ‘˜è¦ï¼é‡é»ï¼‰\n`;
  if(kind==="podcast"){
    return `${base}\nã€Podcast ç‰ˆæœ¬ã€‘\nç”¨æ›´æ…¢çš„ç¯€å¥ï¼ŒæŠŠç†è§£æ”¾é€²å¿ƒè£¡ã€‚\n\n${tags}${home}`.trim();
  }
  return `${base}\n${tags}${home}`.trim();
}
function getSeriesCTA(series){
  const sp = SPELL[series] || SPELL["å…¶ä»–"];
  const homepage = (state.settings.homepage||"").trim();
  let cta = sp.ctaTemplate || "";
  if(homepage) cta += `\n\nä¸»é ï¼š${homepage}`;
  return cta.trim();
}
function PackView(){
  const finals = state.entries.filter(e=>e.status==="final");
  const has = finals.length>0;
  return `
    <div class="grid two">
      <div class="card">
        <h2>ğŸ“¦ ç™¼ç‰‡æ‰“åŒ…å€</h2>
        <div class="sub">å®Œç¨¿ â†’ å·¥å…·é€£çµï¼ä»‹ç´¹æ–‡ï¼CTA ä¸€éµå¥—ç”¨ï¼æ’ç¨‹</div>
        <div class="hr"></div>

        <label>é¸æ“‡ä¸€ç¯‡å®Œç¨¿</label>
        <select id="packPick" ${has?"":"disabled"}>
          ${has ? finals.map(e=>`<option value="${e.id}">${escapeHtml(e.series)}ï½œ${escapeHtml(e.format)}ï½œ${escapeHtml(e.topic)}</option>`).join("")
                : `<option>ç›®å‰æ²’æœ‰å®Œç¨¿</option>`}
        </select>

        <div class="row">
          <div><label>å·¥å…·é€£çµï¼ˆå¯é¸ï¼‰</label><input id="toolLink" placeholder="ä¾‹å¦‚ï¼šPWA å·¥å…·é€£çµ / Google è¡¨å–®â€¦" /></div>
          <div><label>é è¨ˆç™¼ç‰‡æ—¥æœŸï¼ˆå¯é¸ï¼‰</label><input id="scheduleDate" type="date" /></div>
        </div>

        <label>å½±ç‰‡ä»‹ç´¹</label>
        <textarea id="packDesc" placeholder="æŒ‰ã€ç”Ÿæˆä»‹ç´¹æ–‡ã€è‡ªå‹•ç”¢å‡ºåˆç¨¿ã€‚"></textarea>

        <label>CTAï¼ˆä¾ç³»åˆ—ä¸åŒï¼Œä¸€éµå¥—ç”¨ï¼‰</label>
        <textarea id="packCTA" placeholder="æŒ‰ã€å¥—ç”¨ç³»åˆ— CTAã€è‡ªå‹•å¡«å…¥ã€‚"></textarea>

        <div class="btnbar">
          <button class="btn" id="btnGenDesc" ${has?"":"disabled"}>ç”Ÿæˆä»‹ç´¹æ–‡</button>
          <button class="btn secondary" id="btnGenPodDesc" ${has?"":"disabled"}>ç”Ÿæˆ Podcast ä»‹ç´¹</button>
          <button class="btn secondary" id="btnApplyCTA" ${has?"":"disabled"}>å¥—ç”¨ç³»åˆ— CTA</button>
          <button class="btn secondary" id="btnCopyPackAll" ${has?"":"disabled"}>è¤‡è£½ï¼ˆä»‹ç´¹ï¼‹CTAï¼‰</button>
        </div>

        <div class="hr"></div>
        <div class="small">
          <b>å…¶ä»–ä½ å¯å†åŠ ï¼š</b><br/>
          1) é¦–åœ–é¢¨æ ¼æç¤ºï¼ˆ16:9 æ°´å½© / å¯«å¯¦é›»å½±æ„Ÿï¼‰<br/>
          2) Shorts æ‹†æ¢æ¸…å–®ï¼ˆ3â€“5 æ¢ï¼‰<br/>
          3) ç½®é ‚ç•™è¨€ï¼ˆ1 å¥ï¼‰<br/>
          4) ç‰‡å°¾å¼•æµï¼ˆä¸»é  / å·¥å…· / ç›¸é—œé•·ç‰‡ï¼‰
        </div>
      </div>

      <div class="card">
        <h2>ğŸª„ æ‰“åŒ…å”ä½œæç¤º</h2>
        <div class="sub">æƒ³æŠŠä»‹ç´¹æ–‡/ç½®é ‚ç•™è¨€/Shorts æ‹†æ¢ä¹Ÿäº¤çµ¦æˆ‘ï¼Œç›´æ¥è¤‡è£½ï¼š</div>
        <div class="hr"></div>
        <textarea class="mono" id="packPrompt" style="min-height:260px">è«‹ä¾æˆ‘é¸å®šçš„å®Œç¨¿å…§å®¹ï¼Œå¹«æˆ‘ç”¢å‡ºï¼š
1) å½±ç‰‡ä»‹ç´¹
2) ç½®é ‚ç•™è¨€ï¼ˆ1 å¥ï¼‰
3) Shorts æ‹†æ¢ææ¡ˆ 3 å‰‡ï¼ˆæ¨™é¡Œï¼‹ä¸€å¥ hookï¼‰
å£å»è«‹ç¶­æŒè©²ç³»åˆ—çš„æ–‡æ¡ˆå’’èªåŒ…èªæ„Ÿï¼Œæº«æŸ”ä¸èªªæ•™ã€‚</textarea>
        <div class="btnbar">
          <button class="btn secondary" id="btnCopyPackPrompt">è¤‡è£½æ‰“åŒ…å”ä½œæç¤º</button>
        </div>
      </div>
    </div>
  `;
}

/* ===== Settings ===== */
function SettingsView(){
  return `
    <div class="grid two">
      <div class="card">
        <h2>âš™ï¸ è¨­å®š</h2>
        <div class="sub">è³‡æ–™å­˜åœ¨æœ¬æ©Ÿï¼ˆlocalStorageï¼‰ã€‚å»ºè­°å®šæœŸåŒ¯å‡ºå‚™ä»½ã€‚</div>
        <div class="hr"></div>
        <label>ä¸»é é€£çµï¼ˆå¯é¸ï¼‰</label>
        <input id="homepage2" placeholder="https://..." value="${escapeHtml(state.settings.homepage||"")}" />
        <div class="btnbar"><button class="btn secondary" id="btnSaveHome2">å„²å­˜</button></div>

        <div class="hr"></div>
        <div class="row">
          <div><label>åŒ¯å‡ºå‚™ä»½ï¼ˆJSONï¼‰</label><button class="btn" id="btnExport">åŒ¯å‡º</button></div>
          <div><label>åŒ¯å…¥å‚™ä»½ï¼ˆJSONï¼‰</label><input type="file" id="fileImport" accept="application/json" /></div>
        </div>

        <div class="hr"></div>
        <button class="btn danger" id="btnWipe">æ¸…ç©ºæ‰€æœ‰è³‡æ–™</button>
        <div class="small" style="margin-top:8px">âš ï¸ æ¸…ç©ºå‰è«‹å…ˆåŒ¯å‡ºå‚™ä»½ã€‚</div>
      </div>

      <div class="card">
        <h2>ğŸ“Œ ç›®å‰æµç¨‹ï¼ˆä½ æœƒæ›´ä¸æ··äº‚ï¼‰</h2>
        <div class="small">
          1) <b>ç´ æåº«</b>ï¼šå…ˆå­˜ç”Ÿå‘½ç¾å ´ï¼ˆæºé ­ï¼‰<br/>
          2) è½‰å…¥ <b>å‰µä½œå½±ç‰‡</b>ï¼šé¸ç³»åˆ—â†’ç”¨å’’èªåŒ…å‡ºç¨¿<br/>
          3) å­˜æˆ <b>è‰ç¨¿/å®Œç¨¿</b><br/>
          4) é€² <b>æ‰“åŒ…å€</b>ï¼šç”¢ä»‹ç´¹/CTA<br/><br/>
          <b>ä¸‹ä¸€è¼ªæˆ‘æœƒæ¥ä¸Šï¼š</b>ç´ æ â†’ æ›¸ç¨¿æ®µè½ï¼èª²ç¨‹å–®å…ƒï¼ˆçœŸæ­£åˆ†ç”¢ç·šï¼‰
        </div>
      </div>
    </div>
  `;
}

/* ===== Render ===== */
function render(){
  renderNav();
  const view = document.getElementById("view");
  if(current==="sources") view.innerHTML = SourcesView();
  if(current==="create") view.innerHTML = CreateView();
  if(current==="drafts") view.innerHTML = ListView("draft");
  if(current==="final") view.innerHTML = ListView("final");
  if(current==="pack") view.innerHTML = PackView();
  if(current==="settings") view.innerHTML = SettingsView();
  bindEvents();
  if(document.getElementById("collabPrompt")) updateCollabPrompt();
}
render();

/* ===== Dialog å…¨æ–‡ï¼ˆå…±ç”¨ï¼šentry/sourceï¼‰ ===== */
let dlgMode = null; // "entry" | "source"
let dlgId = null;
function openDialog(mode, id){
  dlgMode = mode; dlgId = id;
  let title = "", meta = "", text = "", prompt = "";

  if(mode==="entry"){
    const e = state.entries.find(x=>x.id===id);
    if(!e) return;
    title = e.topic;
    meta = `${e.series}ï½œ${e.format}ï½œ${fmtDate(e.updatedAt||e.createdAt)}`;
    text = e.body || "";
    prompt = baseCollabPrompt(e.series, e.collabDir||"æ›¸ç¨¿", {topic:e.topic, body:e.body, notes:e.notes||""});
  }else{
    const s = state.sources.find(x=>x.id===id);
    if(!s) return;
    title = s.title || "ï¼ˆæœªå‘½åç´ æï¼‰";
    meta = `ç´ æï½œ${fmtDate(s.updatedAt||s.createdAt)}`;
    text = buildSourceText(s);
    prompt = sourcePrompt(s);
  }

  document.getElementById("dlgTitle").textContent = title;
  document.getElementById("dlgMeta").textContent = meta;
  document.getElementById("dlgText").textContent = text;
  document.getElementById("dlgCopyPrompt").dataset.prompt = prompt;
  document.getElementById("dlg").showModal();
}
function closeDlg(){ document.getElementById("dlg").close(); dlgMode=null; dlgId=null; }

/* ===== Filter ===== */
function applyFilter(status, prefix){
  const series = (document.getElementById(prefix+"Series")?.value||"").trim();
  const kw = (document.getElementById(prefix+"Kw")?.value||"").trim().toLowerCase();
  let items = state.entries.filter(e=>e.status===status);
  if(series) items = items.filter(e=>e.series===series);
  if(kw) items = items.filter(e=>
    (e.topic||"").toLowerCase().includes(kw) ||
    (e.body||"").toLowerCase().includes(kw)
  );
  document.getElementById(prefix+"List").innerHTML = items.map(EntryCard).join("") || `<div class="sub">æ²’æœ‰ç¬¦åˆçš„å…§å®¹ã€‚</div>`;
  bindEvents();
}
function clearFilter(status, prefix){
  const s = document.getElementById(prefix+"Series");
  const k = document.getElementById(prefix+"Kw");
  if(s) s.value = "";
  if(k) k.value = "";
  applyFilter(status, prefix);
}

/* =========================
   Events
   ========================= */
function bindEvents(){
  // dialog
  const closeBtn = document.getElementById("dlgClose");
  if(closeBtn) closeBtn.onclick = closeDlg;

  const copyBtn = document.getElementById("dlgCopy");
  if(copyBtn) copyBtn.onclick = ()=>copyText(document.getElementById("dlgText").textContent||"");

  const copyPromptBtn = document.getElementById("dlgCopyPrompt");
  if(copyPromptBtn) copyPromptBtn.onclick = ()=>copyText(copyPromptBtn.dataset.prompt||"");

  // sources page
  const btnSaveHome0 = document.getElementById("btnSaveHome0");
  if(btnSaveHome0){
    btnSaveHome0.addEventListener("click", ()=>{
      state.settings.homepage = (document.getElementById("homepage0").value||"").trim();
      saveState(state); toast("å·²å„²å­˜");
    });
  }

  const btnSaveSource = document.getElementById("btnSaveSource");
  if(btnSaveSource){
    btnSaveSource.addEventListener("click", ()=>{
      const id = (document.getElementById("sourceId").value||"").trim();
      const src = {
        id: id || uid(),
        title:(document.getElementById("srcTitle").value||"").trim(),
        scene:(document.getElementById("srcScene").value||"").trim(),
        dialogue:(document.getElementById("srcDialogue").value||"").trim(),
        feelings:(document.getElementById("srcFeelings").value||"").trim(),
        insight:(document.getElementById("srcInsight").value||"").trim(),
        keepLines:(document.getElementById("srcKeepLines").value||"").trim(),
        lesson:(document.getElementById("srcLesson").value||"").trim(),
        notes:(document.getElementById("srcNotes").value||"").trim(),
        updatedAt: nowISO(),
      };
      if(!src.title && !src.scene && !src.dialogue) return alert("è‡³å°‘å¡«ã€Œæ¨™é¡Œ/å ´æ™¯/å°è©±ã€å…¶ä¸­ä¸€é …ï¼Œæ‰åƒä¸€ç­†ç´ æã€‚");
      const idx = state.sources.findIndex(x=>x.id===src.id);
      if(idx>=0){
        state.sources[idx] = {...state.sources[idx], ...src};
      }else{
        src.createdAt = nowISO();
        state.sources.unshift(src);
      }
      saveState(state);
      toast("å·²å­˜ç´ æ");
      render();
    });
  }

  const btnSaveSourceNew = document.getElementById("btnSaveSourceNew");
  if(btnSaveSourceNew){
    btnSaveSourceNew.addEventListener("click", ()=>{
      document.getElementById("btnSaveSource").click();
      setTimeout(()=>{
        const sid = document.getElementById("sourceId");
        if(sid) sid.value = "";
        ["srcTitle","srcScene","srcDialogue","srcFeelings","srcInsight","srcKeepLines","srcLesson","srcNotes"].forEach(id=>{
          const el = document.getElementById(id); if(el) el.value="";
        });
        toast("å·²å­˜ä¸¦æ¸…ç©º");
      },0);
    });
  }

  const btnCopySourceText = document.getElementById("btnCopySourceText");
  if(btnCopySourceText){
    btnCopySourceText.addEventListener("click", ()=>{
      const src = {
        title:(document.getElementById("srcTitle").value||"").trim(),
        scene:(document.getElementById("srcScene").value||"").trim(),
        dialogue:(document.getElementById("srcDialogue").value||"").trim(),
        feelings:(document.getElementById("srcFeelings").value||"").trim(),
        insight:(document.getElementById("srcInsight").value||"").trim(),
        keepLines:(document.getElementById("srcKeepLines").value||"").trim(),
        lesson:(document.getElementById("srcLesson").value||"").trim(),
        notes:(document.getElementById("srcNotes").value||"").trim(),
      };
      copyText(buildSourceText(src));
    });
  }

  const btnResetSource = document.getElementById("btnResetSource");
  if(btnResetSource){
    btnResetSource.addEventListener("click", ()=>{
      const sid = document.getElementById("sourceId");
      if(sid) sid.value = "";
      ["srcTitle","srcScene","srcDialogue","srcFeelings","srcInsight","srcKeepLines","srcLesson","srcNotes"].forEach(id=>{
        const el = document.getElementById(id); if(el) el.value="";
      });
      toast("å·²æ¸…ç©º");
    });
  }

  const btnFilterSource = document.getElementById("btnFilterSource");
  if(btnFilterSource){
    btnFilterSource.addEventListener("click", ()=>{
      const kw = (document.getElementById("srcKw").value||"").trim().toLowerCase();
      let items = state.sources.slice();
      if(kw){
        items = items.filter(s=>{
          const text = (s.title||"")+" "+buildSourceText(s);
          return text.toLowerCase().includes(kw);
        });
      }
      const list = document.getElementById("sourceList");
      list.innerHTML = items.map(SourceCard).join("") || `<div class="sub">æ²’æœ‰ç¬¦åˆçš„ç´ æã€‚</div>`;
      bindEvents();
    });
  }
  const btnClearFilterSource = document.getElementById("btnClearFilterSource");
  if(btnClearFilterSource){
    btnClearFilterSource.addEventListener("click", ()=>{
      const kw = document.getElementById("srcKw"); if(kw) kw.value="";
      render();
      toast("å·²æ¸…é™¤ç¯©é¸");
    });
  }

  // source card actions
  document.querySelectorAll("[data-action='openSource']").forEach(btn=>{
    btn.addEventListener("click", ()=>openDialog("source", btn.dataset.id));
  });
  document.querySelectorAll("[data-action='editSource']").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const s = state.sources.find(x=>x.id===btn.dataset.id);
      if(!s) return;
      current = "sources"; render();
      setTimeout(()=>{
        document.getElementById("sourceId").value = s.id;
        document.getElementById("srcTitle").value = s.title||"";
        document.getElementById("srcScene").value = s.scene||"";
        document.getElementById("srcDialogue").value = s.dialogue||"";
        document.getElementById("srcFeelings").value = s.feelings||"";
        document.getElementById("srcInsight").value = s.insight||"";
        document.getElementById("srcKeepLines").value = s.keepLines||"";
        document.getElementById("srcLesson").value = s.lesson||"";
        document.getElementById("srcNotes").value = s.notes||"";
        toast("å·²è¼‰å…¥ç´ æ");
      },0);
    });
  });
  document.querySelectorAll("[data-action='delSource']").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.dataset.id;
      if(!confirm("åˆªé™¤ç´ æï¼Ÿï¼ˆç„¡æ³•å¾©åŸï¼‰")) return;
      state.sources = state.sources.filter(x=>x.id!==id);
      saveState(state);
      toast("å·²åˆªé™¤ç´ æ");
      render();
    });
  });
  document.querySelectorAll("[data-action='copySourcePrompt']").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const s = state.sources.find(x=>x.id===btn.dataset.id);
      if(!s) return;
      copyText(sourcePrompt(s));
    });
  });
  document.querySelectorAll("[data-action='toCreate']").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const s = state.sources.find(x=>x.id===btn.dataset.id);
      if(!s) return;

      // è½‰å…¥å‰µä½œï¼šæŠŠç´ ææ•´ç†æˆåŸæ–‡ï¼Œä¸¦å¸¶å…¥ä¸»é¡Œ
      state.settings.lastSeries ||= "å¹¸ç¦æ•™é¤Š";
      saveState(state);

      current = "create";
      render();

      setTimeout(()=>{
        document.getElementById("entryId").value = "";
        document.getElementById("fromSourceId").value = s.id;
        document.getElementById("topic").value = s.title || "ï¼ˆè«‹è£œä¸»é¡Œï¼‰";
        document.getElementById("body").value = buildSourceText(s);
        document.getElementById("notes").value = (s.keepLines ? `æƒ³ä¿ç•™åŸå¥ï¼š\n${s.keepLines}\n\n` : "") +
                                                 (s.lesson ? `æƒ³é™ªå­©å­/å¤§äººå­¸åˆ°ï¼š\n${s.lesson}` : "");
        document.getElementById("series").value = state.settings.lastSeries || "å¹¸ç¦æ•™é¤Š";
        document.getElementById("format").value = "é•·å½±ç‰‡";
        document.getElementById("collabDir").value = "ç™¼ç‰‡";
        updateCollabPrompt();
        toast("å·²è½‰å…¥å‰µä½œ");
      },0);
    });
  });

  // create view series changes
  const seriesSel = document.getElementById("series");
  if(seriesSel){
    seriesSel.addEventListener("change", ()=>{
      state.settings.lastSeries = seriesSel.value;
      saveState(state);
      render(); // å³å´å’’èªåŒ…åŒæ­¥
    });
  }
  ["topic","body","notes","collabDir"].forEach(id=>{
    const el = document.getElementById(id);
    if(el) el.addEventListener("input", updateCollabPrompt);
    if(id==="collabDir" && el) el.addEventListener("change", updateCollabPrompt);
  });

  const btnCopyPrompt = document.getElementById("btnCopyPrompt");
  if(btnCopyPrompt) btnCopyPrompt.addEventListener("click", ()=>copyText(document.getElementById("collabPrompt").value));

  const btnSaveDraft = document.getElementById("btnSaveDraft");
  if(btnSaveDraft){
    btnSaveDraft.addEventListener("click", ()=>{
      const payload = getEntryForm(); if(!payload) return;
      payload.status = "draft";
      // attach source link if exists
      const srcId = (document.getElementById("fromSourceId")?.value||"").trim();
      if(srcId) payload.sourceId = srcId;
      upsertEntry(payload);
      toast("å·²å­˜è‰ç¨¿");
      render();
    });
  }
  const btnSaveFinal = document.getElementById("btnSaveFinal");
  if(btnSaveFinal){
    btnSaveFinal.addEventListener("click", ()=>{
      const payload = getEntryForm(); if(!payload) return;
      payload.status = "final";
      const srcId = (document.getElementById("fromSourceId")?.value||"").trim();
      if(srcId) payload.sourceId = srcId;
      upsertEntry(payload);
      toast("å·²å­˜å®Œç¨¿");
      render();
    });
  }
  const btnReset = document.getElementById("btnReset");
  if(btnReset){
    btnReset.addEventListener("click", ()=>{
      ["entryId","fromSourceId","topic","body","notes"].forEach(id=>{
        const el = document.getElementById(id);
        if(el) el.value = "";
      });
      toast("å·²æ¸…ç©ºï¼ˆä¸å½±éŸ¿å·²å­˜å…§å®¹ï¼‰");
      updateCollabPrompt();
    });
  }

  // list cards (entries)
  document.querySelectorAll("[data-action='openEntry']").forEach(btn=>{
    btn.addEventListener("click", ()=>openDialog("entry", btn.dataset.id));
  });
  document.querySelectorAll("[data-action='editEntry']").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.dataset.id;
      const e = state.entries.find(x=>x.id===id);
      if(!e) return;
      current="create"; render();
      setTimeout(()=>{
        document.getElementById("entryId").value = e.id;
        document.getElementById("fromSourceId").value = e.sourceId||"";
        document.getElementById("format").value = e.format;
        document.getElementById("series").value = e.series;
        document.getElementById("topic").value = e.topic;
        document.getElementById("body").value = e.body;
        document.getElementById("notes").value = e.notes || "";
        document.getElementById("collabDir").value = e.collabDir || "æ›¸ç¨¿";
        updateCollabPrompt();
        toast("å·²è¼‰å…¥åˆ°å‰µä½œé ");
      },0);
    });
  });
  document.querySelectorAll("[data-action='toggleEntry']").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.dataset.id;
      const e = state.entries.find(x=>x.id===id);
      if(!e) return;
      e.status = (e.status==="draft") ? "final" : "draft";
      e.updatedAt = nowISO();
      saveState(state);
      toast("å·²æ›´æ–°ç‹€æ…‹");
      render();
    });
  });
  document.querySelectorAll("[data-action='delEntry']").forEach(btn=>{
    btn.addEventListener("click", ()=>{
      const id = btn.dataset.id;
      if(!confirm("ç¢ºå®šåˆªé™¤ï¼Ÿï¼ˆç„¡æ³•å¾©åŸï¼‰")) return;
      state.entries = state.entries.filter(x=>x.id!==id);
      saveState(state);
      toast("å·²åˆªé™¤");
      render();
    });
  });

  // filters
  document.querySelectorAll("[data-action='applyFilter']").forEach(btn=>{
    btn.addEventListener("click", ()=>applyFilter(btn.dataset.status, btn.dataset.prefix));
  });
  document.querySelectorAll("[data-action='clearFilter']").forEach(btn=>{
    btn.addEventListener("click", ()=>clearFilter(btn.dataset.status, btn.dataset.prefix));
  });

  // pack
  const btnGenDesc = document.getElementById("btnGenDesc");
  if(btnGenDesc){
    btnGenDesc.addEventListener("click", ()=>{
      const id = document.getElementById("packPick").value;
      const e = state.entries.find(x=>x.id===id);
      if(!e) return;
      document.getElementById("packDesc").value = generateDescription(e, "video");
      toast("å·²ç”Ÿæˆä»‹ç´¹æ–‡");
    });
  }
  const btnGenPodDesc = document.getElementById("btnGenPodDesc");
  if(btnGenPodDesc){
    btnGenPodDesc.addEventListener("click", ()=>{
      const id = document.getElementById("packPick").value;
      const e = state.entries.find(x=>x.id===id);
      if(!e) return;
      document.getElementById("packDesc").value = generateDescription(e, "podcast");
      toast("å·²ç”Ÿæˆ Podcast ä»‹ç´¹");
    });
  }
  const btnApplyCTA = document.getElementById("btnApplyCTA");
  if(btnApplyCTA){
    btnApplyCTA.addEventListener("click", ()=>{
      const id = document.getElementById("packPick").value;
      const e = state.entries.find(x=>x.id===id);
      if(!e) return;
      document.getElementById("packCTA").value = getSeriesCTA(e.series);
      toast("å·²å¥—ç”¨ç³»åˆ— CTA");
    });
  }
  const btnCopyPackAll = document.getElementById("btnCopyPackAll");
  if(btnCopyPackAll){
    btnCopyPackAll.addEventListener("click", ()=>{
      const tool = (document.getElementById("toolLink").value||"").trim();
      const dt = (document.getElementById("scheduleDate").value||"").trim();
      const desc = (document.getElementById("packDesc").value||"").trim();
      const cta = (document.getElementById("packCTA").value||"").trim();
      const extra = [];
      if(tool) extra.push(`å·¥å…·é€£çµï¼š${tool}`);
      if(dt) extra.push(`é è¨ˆç™¼ç‰‡ï¼š${dt}`);
      const head = extra.length?`ã€æ‰“åŒ…è³‡è¨Šã€‘\n${extra.join("\n")}\n\n`:"";
      copyText(`${head}${desc}\n\n${cta}`.trim());
    });
  }
  const btnCopyPackPrompt = document.getElementById("btnCopyPackPrompt");
  if(btnCopyPackPrompt) btnCopyPackPrompt.addEventListener("click", ()=>copyText(document.getElementById("packPrompt").value));

  // settings
  const btnSaveHome2 = document.getElementById("btnSaveHome2");
  if(btnSaveHome2){
    btnSaveHome2.addEventListener("click", ()=>{
      state.settings.homepage = (document.getElementById("homepage2").value||"").trim();
      saveState(state); toast("å·²å„²å­˜"); render();
    });
  }
  const btnExport = document.getElementById("btnExport");
  if(btnExport){
    btnExport.addEventListener("click", ()=>{
      const blob = new Blob([JSON.stringify(state,null,2)], {type:"application/json"});
      const a = document.createElement("a");
      a.href = URL.createObjectURL(blob);
      a.download = `angel-studio-backup-${APP.version}.json`;
      a.click();
      toast("å·²åŒ¯å‡ºå‚™ä»½");
    });
  }
  const fileImport = document.getElementById("fileImport");
  if(fileImport){
    fileImport.addEventListener("change", async ()=>{
      const f = fileImport.files && fileImport.files[0];
      if(!f) return;
      const txt = await f.text();
      try{
        const obj = JSON.parse(txt);
        if(!obj || typeof obj!=="object") throw new Error("bad");
        state = obj;
        state.sources ||= [];
        state.entries ||= [];
        state.settings ||= {homepage:"", lastSeries:"å¹¸ç¦æ•™é¤Š"};
        saveState(state);
        toast("å·²åŒ¯å…¥");
        render();
      }catch(e){
        alert("åŒ¯å…¥å¤±æ•—ï¼šè«‹ç¢ºèªæª”æ¡ˆæ ¼å¼ã€‚");
      }
    });
  }
  const btnWipe = document.getElementById("btnWipe");
  if(btnWipe){
    btnWipe.addEventListener("click", ()=>{
      if(!confirm("ç¢ºå®šæ¸…ç©ºæ‰€æœ‰è³‡æ–™ï¼Ÿï¼ˆç„¡æ³•å¾©åŸï¼Œè«‹å…ˆåŒ¯å‡ºå‚™ä»½ï¼‰")) return;
      localStorage.removeItem(APP.storageKey);
      state = loadState();
      toast("å·²æ¸…ç©º");
      render();
    });
  }
}

/* ===== Service Workerï¼ˆå…ˆä¿ç•™ï¼Œç­‰ä½ è¦é›¢ç·šå†è£œ sw.jsï¼‰ ===== */
if("serviceWorker" in navigator){
  window.addEventListener("load", async ()=>{
    try{
      await navigator.serviceWorker.register("sw.js");
      document.getElementById("syncState").textContent = "å¯é›¢ç·šä½¿ç”¨";
    }catch(e){
      document.getElementById("syncState").textContent = "æœªå•Ÿç”¨é›¢ç·š";
    }
  });
}
</script>
</body>
</html>
