<!doctype html>
<html lang="zh-Hant">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <title>天使笑長｜創作工作室（全功能版）</title>
  <meta name="theme-color" content="#0b3d2e" />
  <style>
    :root{
      --bg:#083326;
      --bg2:#0b3d2e;
      --card:#0f4a37;
      --card2:#11513d;
      --text:#eaf6f0;
      --muted:#bfe3d5;
      --line:rgba(255,255,255,.12);
      --btn:#f0a04b;
      --btn2:#ffd6a1;
      --danger:#ff6b6b;
      --ok:#7CFFB2;
      --shadow:0 10px 30px rgba(0,0,0,.25);
      --radius:18px;
      --radius2:22px;
      --mono: ui-monospace, SFMono-Regular, Menlo, Monaco, Consolas, "Liberation Mono", "Courier New", monospace;
      --sans: system-ui, -apple-system, "Segoe UI", Roboto, "Noto Sans TC", "PingFang TC", "Microsoft JhengHei", "Helvetica Neue", Arial, sans-serif;
    }
    *{box-sizing:border-box}
    body{
      margin:0;
      font-family:var(--sans);
      color:var(--text);
      background: radial-gradient(1200px 700px at 20% 0%, rgba(240,160,75,.18), transparent 60%),
                  radial-gradient(800px 600px at 90% 10%, rgba(255,214,161,.12), transparent 55%),
                  linear-gradient(180deg, var(--bg), #06261c 80%);
      min-height:100vh;
    }
    a{color:var(--btn2)}
    header{
      position:sticky; top:0; z-index:50;
      backdrop-filter: blur(10px);
      background: rgba(6,38,28,.65);
      border-bottom:1px solid var(--line);
    }
    .wrap{max-width:1100px; margin:0 auto; padding:14px 14px;}
    .top{
      display:flex; gap:12px; align-items:center; justify-content:space-between;
      flex-wrap:wrap;
    }
    .brand{
      display:flex; align-items:flex-start; gap:10px;
    }
    .logo{
      width:44px;height:44px;border-radius:14px;
      background: linear-gradient(135deg, rgba(240,160,75,.95), rgba(255,214,161,.75));
      box-shadow: var(--shadow);
      flex:0 0 auto;
    }
    .brand h1{
      font-size:16px; margin:0; letter-spacing:.5px;
    }
    .brand .sub{font-size:12px;color:var(--muted); margin-top:2px}
    .pills{
      display:flex; gap:8px; flex-wrap:wrap; align-items:center; justify-content:flex-end;
    }
    .pill{
      font-size:12px; padding:6px 10px; border-radius:999px;
      border:1px solid var(--line);
      color:var(--muted);
      background: rgba(255,255,255,.04);
    }
    nav{
      display:flex; gap:8px; flex-wrap:wrap;
      padding:0 14px 12px;
      max-width:1100px; margin:0 auto;
    }
    .tab{
      appearance:none; border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color:var(--muted);
      padding:10px 12px;
      border-radius:999px;
      cursor:pointer;
      font-size:13px;
      transition:.15s ease;
    }
    .tab:hover{transform: translateY(-1px); background: rgba(255,255,255,.06);}
    .tab.active{
      background: rgba(240,160,75,.14);
      border-color: rgba(240,160,75,.55);
      color: var(--text);
    }

    main{max-width:1100px; margin:0 auto; padding:18px 14px 60px;}
    .grid{
      display:grid;
      grid-template-columns: 1.2fr .8fr;
      gap:14px;
    }
    @media (max-width: 920px){
      .grid{grid-template-columns: 1fr;}
    }
    .card{
      border:1px solid var(--line);
      background: linear-gradient(180deg, rgba(15,74,55,.92), rgba(9,54,40,.92));
      border-radius: var(--radius2);
      box-shadow: var(--shadow);
      overflow:hidden;
    }
    .card .hd{
      padding:14px 14px 10px;
      display:flex; gap:10px; align-items:flex-start; justify-content:space-between;
      border-bottom:1px solid var(--line);
    }
    .card .hd h2{
      font-size:14px; margin:0;
    }
    .card .hd .hint{
      font-size:12px;color:var(--muted);
      margin-top:4px;
      line-height:1.4;
    }
    .card .bd{padding:14px;}
    .row{display:flex; gap:10px; flex-wrap:wrap; align-items:center;}
    .row2{display:flex; gap:10px; flex-wrap:wrap; align-items:flex-start;}
    .sp{justify-content:space-between}
    .field{display:flex; flex-direction:column; gap:6px; margin-bottom:12px; flex:1;}
    label{font-size:12px; color:var(--muted);}
    input, select, textarea{
      width:100%;
      background: rgba(255,255,255,.05);
      border:1px solid var(--line);
      color: var(--text);
      border-radius: 14px;
      padding:10px 12px;
      outline:none;
      font-size:14px;
    }
    textarea{min-height:160px; resize:vertical; line-height:1.55;}
    .btns{display:flex; gap:10px; flex-wrap:wrap;}
    button.btn{
      appearance:none;
      border:1px solid rgba(240,160,75,.55);
      background: rgba(240,160,75,.14);
      color: var(--text);
      padding:10px 12px;
      border-radius: 999px;
      cursor:pointer;
      font-size:13px;
      transition:.15s ease;
    }
    button.btn:hover{transform:translateY(-1px); background: rgba(240,160,75,.18);}
    button.btn.ghost{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      color: var(--muted);
    }
    button.btn.danger{
      border-color: rgba(255,107,107,.55);
      background: rgba(255,107,107,.12);
    }
    button.btn.ok{
      border-color: rgba(124,255,178,.45);
      background: rgba(124,255,178,.10);
    }
    .list{
      display:flex; flex-direction:column; gap:10px;
    }
    .item{
      border:1px solid var(--line);
      background: rgba(255,255,255,.04);
      border-radius: 16px;
      padding:12px;
    }
    .item .t{
      font-size:13px; margin:0 0 6px;
      display:flex; gap:8px; align-items:center; justify-content:space-between;
    }
    .item .meta{
      font-size:12px; color: var(--muted); line-height:1.4;
      margin-bottom:8px;
      white-space:pre-wrap;
    }
    .item .actions{display:flex; gap:8px; flex-wrap:wrap;}
    .small{font-size:12px;color:var(--muted); line-height:1.5}
    .mono{font-family:var(--mono); font-size:12px; white-space:pre-wrap}
    .toast{
      position: fixed;
      left: 50%;
      bottom: 18px;
      transform: translateX(-50%);
      background: rgba(0,0,0,.65);
      border:1px solid rgba(255,255,255,.12);
      color:#fff;
      padding:10px 14px;
      border-radius: 999px;
      box-shadow: var(--shadow);
      opacity:0;
      pointer-events:none;
      transition:.18s ease;
      font-size:13px;
      z-index: 999;
    }
    .toast.show{opacity:1; transform: translateX(-50%) translateY(-2px);}
    details{
      border:1px solid var(--line);
      border-radius:16px;
      padding:10px 12px;
      background: rgba(255,255,255,.03);
    }
    summary{cursor:pointer; font-size:13px; color:var(--text);}
    .kbd{
      font-family:var(--mono);
      background: rgba(255,255,255,.06);
      border:1px solid var(--line);
      padding:2px 6px;
      border-radius:8px;
      font-size:12px;
      color:var(--muted);
    }
    .mutedline{
      border-top:1px dashed rgba(255,255,255,.12);
      margin:12px 0;
    }
  </style>
</head>

<body>
<header>
  <div class="wrap">
    <div class="top">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <div>
          <h1>天使笑長｜創作工作室（全功能版）</h1>
          <div class="sub">素材庫 × 文宣庫 × 發片打包 × 咒語分流 × 一鍵轉打包（localStorage 離線資料）</div>
        </div>
      </div>
      <div class="pills" id="pills"></div>
    </div>
  </div>

  <nav id="tabs">
    <button class="tab" data-tab="create">創作區</button>
    <button class="tab" data-tab="materials">素材庫</button>
    <button class="tab" data-tab="promos">文宣庫</button>
    <button class="tab" data-tab="publish">發片打包</button>
    <button class="tab" data-tab="spells">咒語庫（分流）</button>
    <button class="tab" data-tab="backup">備份</button>
    <button class="tab" data-tab="help">使用說明</button>
  </nav>
</header>

<main id="app"></main>

<div class="toast" id="toast">完成</div>

<script>
/* =========================
   天使笑長｜創作工作室（全功能版）
   - 單檔 index.html（資料存 localStorage）
   - 咒語庫分流：系列 / 類別 / 片型 / 風格
   - 一鍵把完稿轉成發片打包：自動填標題/100字介紹/hashtags/工具連結
   ========================= */

const LS_KEY = "angel_studio_full_v1";
const nowISO = ()=> new Date().toISOString();
const uid = ()=> Math.random().toString(16).slice(2)+Date.now().toString(16);

const DEFAULTS = {
  settings:{
    brandName:"天使笑長",
    defaultSeries:"幸福教養",
    defaultPlatform:"YouTube",
    defaultHashtags:"#幸福教養 #天使笑長",
    defaultToolLinks:"（貼上你的 PWA 連結 / 表單連結 / 主頁連結）",
    introLimit: 100,
  },
  materials:[],
  promos:[],
  publishes:[],
  spells:[
    // 預塞幾個常用分流範例，方便你直接用
    {
      id: uid(),
      title:"水彩插畫｜車內安全感對話（16:9 無文字）",
      series:"幸福教養",
      kind:"插畫咒語",
      style:"水彩插畫",
      category:"車內對話",
      content:
`A watercolor illustration of a mother driving a car, seen from the back seat perspective. The mother sits calmly at the wheel, posture steady and attentive. In the front passenger seat, an older child is slightly turned toward her, speaking gently. The atmosphere is safe and intimate with warm natural light. The road ahead is softly blurred, suggesting movement without urgency. No dramatic expressions. Cinematic composition, 16:9, no text, no letters, no symbols.`
    },
    {
      id: uid(),
      title:"口說稿｜3 秒 Hook＋溫柔篤定收尾 CTA（幸福教養長片）",
      series:"幸福教養",
      kind:"文案咒語",
      style:"口說稿",
      category:"長影片",
      content:
`請用「把心站穩、活得自在、不說教、溫柔而篤定」的品牌語感，寫一支幸福教養長影片口說稿。必含：3 秒 Hook／承諾／正文／CTA（導到主頁，含「每週五更新」）。字數 ≥ 3000。`
    }
  ],
  // 創作區草稿（你在創作區打一半不會丟）
  draft:{
    title:"",
    series:"幸福教養",
    type:"長影片口說稿",
    platform:"YouTube",
    tool:"幸福教養｜零用錢練功房",
    links:"",
    hashtags:"#幸福教養 #天使笑長",
    prompt:"",
    content:""
  },
  // 發片打包草稿
  publishDraft:{
    title:"",
    date:"",
    intro:"",
    hashtags:"#幸福教養 #天使笑長",
    toolLinks:"",
    notes:""
  }
};

let state = {
  tab:"create",
  filters:{
    materialQuery:"",
    promoQuery:"",
    publishQuery:"",
    // spells 分流
    spellsQuery:"",
    spellsSeries:"全部",
    spellsKind:"全部",
    spellsStyle:"全部",
    spellsCategory:"全部",
  },
  data: null,
  // spells 編輯暫存
  spellDraft: {id:"", title:"", series:"幸福教養", kind:"插畫咒語", style:"水彩插畫", category:"", content:""}
};

function toast(msg){
  const el = document.getElementById("toast");
  el.textContent = msg || "完成";
  el.classList.add("show");
  setTimeout(()=> el.classList.remove("show"), 1400);
}

function loadAll(){
  try{
    const raw = localStorage.getItem(LS_KEY);
    if(!raw){
      state.data = structuredClone(DEFAULTS);
      saveAll();
      return;
    }
    const obj = JSON.parse(raw);
    // 合併 defaults（避免舊版缺欄位）
    state.data = mergeDeep(structuredClone(DEFAULTS), obj);
  }catch(e){
    state.data = structuredClone(DEFAULTS);
  }
}

function saveAll(){
  localStorage.setItem(LS_KEY, JSON.stringify(state.data));
  renderPills();
}

function mergeDeep(target, source){
  if(typeof target !== "object" || target===null) return source;
  if(typeof source !== "object" || source===null) return target;
  for(const k of Object.keys(source)){
    if(Array.isArray(source[k])) target[k]=source[k];
    else if(typeof source[k]==="object" && source[k]!==null) target[k]=mergeDeep(target[k] ?? {}, source[k]);
    else target[k]=source[k];
  }
  return target;
}

function $(id){ return document.getElementById(id); }

async function copyText(text){
  try{
    await navigator.clipboard.writeText(text);
    toast("已複製");
  }catch(e){
    // fallback
    const ta = document.createElement("textarea");
    ta.value = text;
    ta.style.position="fixed";
    ta.style.opacity="0";
    document.body.appendChild(ta);
    ta.select();
    document.execCommand("copy");
    document.body.removeChild(ta);
    toast("已複製");
  }
}

function short100(text){
  const lim = state.data.settings.introLimit || 100;
  const s = (text||"").replace(/\s+/g," ").trim();
  if(!s) return "";
  return s.length <= lim ? s : s.slice(0, lim) + "…";
}

function inferTitleFromContent(){
  const d = state.data.draft;
  if((d.title||"").trim()) return d.title.trim();
  const content = (d.content||"").trim();
  if(!content) return "";
  // 取第一行或第一句
  const firstLine = content.split(/\n+/)[0].trim();
  if(firstLine.length >= 2 && firstLine.length <= 40) return firstLine;
  const m = content.match(/(.+?[。！？!?])/);
  if(m) return m[1].replace(/[。！？!?]/g,"").trim().slice(0, 40);
  return content.slice(0, 20);
}

function renderPills(){
  const pills = $("pills");
  if(!pills) return;
  const m = state.data.materials.length;
  const p = state.data.promos.length;
  const pb = state.data.publishes.length;
  const s = state.data.spells.length;

  pills.innerHTML = `
    <span class="pill">素材：${m}</span>
    <span class="pill">文宣：${p}</span>
    <span class="pill">打包：${pb}</span>
    <span class="pill">咒語：${s}</span>
  `;
}

function setTab(name){
  state.tab = name;
  renderTabs();
  render();
  window.scrollTo({top:0, behavior:"smooth"});
}

function renderTabs(){
  document.querySelectorAll(".tab").forEach(b=>{
    const on = b.dataset.tab === state.tab;
    b.classList.toggle("active", on);
    b.onclick = ()=> setTab(b.dataset.tab);
  });
}

function esc(s){
  return (s||"").replace(/[&<>"']/g, c=>({ "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;" }[c]));
}

function matchesQuery(obj, q, keys){
  if(!q) return true;
  const needle = q.toLowerCase();
  return keys.some(k => ((obj[k]||"")+"").toLowerCase().includes(needle));
}

function uniq(arr){ return Array.from(new Set(arr)); }

function buildSpellsFacet(){
  const all = state.data.spells || [];
  return {
    series: ["全部", ...uniq(all.map(x=>x.series||"未分類")).sort()],
    kind: ["全部", ...uniq(all.map(x=>x.kind||"未分類")).sort()],
    style: ["全部", ...uniq(all.map(x=>x.style||"未分類")).sort()],
    category: ["全部", ...uniq(all.map(x=>x.category||"未分類")).sort()],
  };
}

/* =========================
   一鍵：把完稿轉成發片打包
   - 自動填：標題 / 100字介紹 / hashtags / 工具連結
   - 轉完自動切到「發片打包」分頁
   ========================= */
function oneClickToPublishPack(){
  const d = state.data.draft;
  const pd = state.data.publishDraft;
  const title = inferTitleFromContent() || d.title || "";
  const intro = short100(d.content || d.prompt || "");
  const tags = (d.hashtags||"").trim() || state.data.settings.defaultHashtags || "";
  const toolLinks = (d.links||"").trim() || state.data.settings.defaultToolLinks || "";

  state.data.publishDraft = {
    ...pd,
    title: title,
    intro: intro,
    hashtags: tags,
    toolLinks: toolLinks,
    notes: `【系列】${d.series||""}\n【片型】${d.type||""}\n【工具/專案】${d.tool||""}\n【平台】${d.platform||""}`
  };

  saveAll();
  toast("已轉入發片打包");
  setTab("publish");
}

/* =========================
   Render
   ========================= */
function render(){
  const app = $("app");
  if(!app) return;

  if(state.tab==="create"){
    app.innerHTML = renderCreate();
    bindCreate();
    return;
  }
  if(state.tab==="materials"){
    app.innerHTML = renderMaterials();
    bindMaterials();
    return;
  }
  if(state.tab==="promos"){
    app.innerHTML = renderPromos();
    bindPromos();
    return;
  }
  if(state.tab==="publish"){
    app.innerHTML = renderPublish();
    bindPublish();
    return;
  }
  if(state.tab==="spells"){
    app.innerHTML = renderSpells();
    bindSpells();
    return;
  }
  if(state.tab==="backup"){
    app.innerHTML = renderBackup();
    bindBackup();
    return;
  }
  if(state.tab==="help"){
    app.innerHTML = renderHelp();
    bindHelp();
    return;
  }
}

function renderCreate(){
  const d = state.data.draft;
  const facets = buildSpellsFacet();
  return `
  <div class="grid">
    <section class="card">
      <div class="hd">
        <div>
          <h2>創作區｜草稿與完稿</h2>
          <div class="hint">你可以在這裡寫口說稿、描述、貼咒語、整理連結；一鍵轉成發片打包。</div>
        </div>
        <div class="btns">
          <button class="btn ok" id="btnToPack">一鍵轉成發片打包</button>
          <button class="btn ghost" id="btnSaveDraft">保存</button>
          <button class="btn ghost" id="btnCopyAll">複製整包</button>
        </div>
      </div>

      <div class="bd">
        <div class="row2">
          <div class="field" style="flex:1.2">
            <label>標題（可空，系統會從完稿第一行自動推）</label>
            <input id="c_title" value="${esc(d.title)}" placeholder="例如：無欲則剛：等一下的選擇力" />
          </div>
          <div class="field" style="flex:.8">
            <label>系列</label>
            <select id="c_series">
              ${["幸福教養","詩詞人生","幸福關係","幸福小腦袋","其他"].map(x=>`<option ${d.series===x?"selected":""}>${x}</option>`).join("")}
            </select>
          </div>
        </div>

        <div class="row2">
          <div class="field">
            <label>片型</label>
            <select id="c_type">
              ${["長影片口說稿","短影片口說稿","Shorts 文案","貼文長文","直播提綱","其他"].map(x=>`<option ${d.type===x?"selected":""}>${x}</option>`).join("")}
            </select>
          </div>
          <div class="field">
            <label>平台</label>
            <select id="c_platform">
              ${["YouTube","FB","IG","Threads","LINE","其他"].map(x=>`<option ${d.platform===x?"selected":""}>${x}</option>`).join("")}
            </select>
          </div>
          <div class="field">
            <label>工具/專案名稱</label>
            <input id="c_tool" value="${esc(d.tool)}" placeholder="例如：幸福教養｜零用錢練功房" />
          </div>
        </div>

        <div class="field">
          <label>工具/連結（主頁 / PWA / 表單…）</label>
          <textarea id="c_links" style="min-height:90px" placeholder="貼上連結">${esc(d.links)}</textarea>
        </div>

        <div class="field">
          <label>Hashtags</label>
          <input id="c_tags" value="${esc(d.hashtags)}" placeholder="#幸福教養 #天使笑長" />
        </div>

        <div class="row2">
          <div class="field" style="flex:1">
            <label>Prompt / 咒語（可從右邊咒語庫快速插入）</label>
            <textarea id="c_prompt" placeholder="貼上插畫咒語 / 口說稿指令…">${esc(d.prompt)}</textarea>
          </div>
          <div class="field" style="flex:1">
            <label>完稿內容（可長文）</label>
            <textarea id="c_content" placeholder="貼上你完成的口說稿 / 貼文…">${esc(d.content)}</textarea>
          </div>
        </div>

        <div class="mutedline"></div>

        <details>
          <summary>快速插入咒語（分流篩選）</summary>
          <div class="row2" style="margin-top:10px">
            <div class="field">
              <label>系列</label>
              <select id="quick_spell_series">${facets.series.map(x=>`<option>${x}</option>`).join("")}</select>
            </div>
            <div class="field">
              <label>種類</label>
              <select id="quick_spell_kind">${facets.kind.map(x=>`<option>${x}</option>`).join("")}</select>
            </div>
            <div class="field">
              <label>風格</label>
              <select id="quick_spell_style">${facets.style.map(x=>`<option>${x}</option>`).join("")}</select>
            </div>
            <div class="field">
              <label>類別</label>
              <select id="quick_spell_cat">${facets.category.map(x=>`<option>${x}</option>`).join("")}</select>
            </div>
          </div>
          <div class="field">
            <label>搜尋</label>
            <input id="quick_spell_q" placeholder="關鍵字（標題/內容）" />
          </div>
          <div class="small">點「插入到 Prompt」會把咒語加到 Prompt 末端（不覆蓋原本內容）。</div>
          <div id="quickSpellList" class="list" style="margin-top:10px"></div>
        </details>

      </div>
    </section>

    <aside class="card">
      <div class="hd">
        <div>
          <h2>設定（本機）</h2>
          <div class="hint">預設 hashtags / 工具連結 / 100 字限制</div>
        </div>
        <div class="btns">
          <button class="btn ghost" id="btnSaveSettings">保存設定</button>
        </div>
      </div>
      <div class="bd">
        <div class="field">
          <label>預設 Hashtags</label>
          <input id="s_defTags" value="${esc(state.data.settings.defaultHashtags)}" />
        </div>
        <div class="field">
          <label>預設 工具/連結</label>
          <textarea id="s_defLinks" style="min-height:90px">${esc(state.data.settings.defaultToolLinks)}</textarea>
        </div>
        <div class="field">
          <label>100 字介紹字數上限（預設 100）</label>
          <input id="s_introLimit" type="number" min="30" max="200" value="${state.data.settings.introLimit||100}" />
        </div>

        <div class="mutedline"></div>

        <div class="small mono">快捷鍵：<span class="kbd">Ctrl</span>+<span class="kbd">S</span> 保存（瀏覽器若攔截可改按「保存」按鈕）</div>
      </div>
    </aside>
  </div>
  `;
}

function bindCreate(){
  const d = state.data.draft;

  const sync = ()=>{
    d.title = $("c_title").value;
    d.series = $("c_series").value;
    d.type = $("c_type").value;
    d.platform = $("c_platform").value;
    d.tool = $("c_tool").value;
    d.links = $("c_links").value;
    d.hashtags = $("c_tags").value;
    d.prompt = $("c_prompt").value;
    d.content = $("c_content").value;
  };

  ["c_title","c_series","c_type","c_platform","c_tool","c_links","c_tags","c_prompt","c_content"].forEach(id=>{
    const el=$(id);
    if(!el) return;
    el.addEventListener("input", ()=>{ sync(); });
    el.addEventListener("change", ()=>{ sync(); });
  });

  $("btnSaveDraft").onclick=()=>{
    sync();
    saveAll();
    toast("已保存草稿");
  };

  $("btnCopyAll").onclick=()=>{
    sync();
    const txt = [
      `【標題】${d.title||""}`,
      `【系列】${d.series||""}`,
      `【片型】${d.type||""}`,
      `【平台】${d.platform||""}`,
      `【工具/專案】${d.tool||""}`,
      "",
      "【工具/連結】",
      d.links||"",
      "",
      "【Hashtags】",
      d.hashtags||"",
      "",
      "【Prompt】",
      d.prompt||"",
      "",
      "【完稿】",
      d.content||""
    ].join("\n");
    copyText(txt);
  };

  $("btnToPack").onclick=()=>{
    sync();
    saveAll();
    oneClickToPublishPack();
  };

  $("btnSaveSettings").onclick=()=>{
    state.data.settings.defaultHashtags = $("s_defTags").value.trim();
    state.data.settings.defaultToolLinks = $("s_defLinks").value;
    state.data.settings.introLimit = Math.max(30, Math.min(200, parseInt($("s_introLimit").value||"100",10)));
    saveAll();
    toast("已保存設定");
  };

  // quick spells list
  const facets = buildSpellsFacet();
  const qEls = {
    series: $("quick_spell_series"),
    kind: $("quick_spell_kind"),
    style: $("quick_spell_style"),
    cat: $("quick_spell_cat"),
    q: $("quick_spell_q"),
    list: $("quickSpellList")
  };

  function filterQuick(){
    const s = qEls.series.value, k=qEls.kind.value, st=qEls.style.value, c=qEls.cat.value;
    const q = (qEls.q.value||"").trim();
    const arr = (state.data.spells||[]).filter(x=>{
      if(s!=="全部" && (x.series||"未分類")!==s) return false;
      if(k!=="全部" && (x.kind||"未分類")!==k) return false;
      if(st!=="全部" && (x.style||"未分類")!==st) return false;
      if(c!=="全部" && (x.category||"未分類")!==c) return false;
      if(q && !matchesQuery(x, q, ["title","content","category","style","kind","series"])) return false;
      return true;
    }).slice().reverse();

    if(arr.length===0){
      qEls.list.innerHTML = `<div class="small">沒有符合的咒語。</div>`;
      return;
    }

    qEls.list.innerHTML = arr.slice(0,12).map(x=>`
      <div class="item">
        <div class="t">
          <strong>${esc(x.title||"(未命名)")}</strong>
          <span class="pill">${esc(x.series||"")}</span>
        </div>
        <div class="meta">${esc([x.kind,x.style,x.category].filter(Boolean).join("｜"))}</div>
        <div class="actions">
          <button class="btn ghost" data-act="copy" data-id="${x.id}">複製</button>
          <button class="btn ok" data-act="insert" data-id="${x.id}">插入到 Prompt</button>
        </div>
      </div>
    `).join("");

    qEls.list.querySelectorAll("button").forEach(b=>{
      b.onclick=()=>{
        const id=b.dataset.id;
        const act=b.dataset.act;
        const item = state.data.spells.find(z=>z.id===id);
        if(!item) return;
        if(act==="copy") return copyText(item.content||"");
        if(act==="insert"){
          const cur = $("c_prompt").value || "";
          const next = (cur.trim()? (cur.trim()+"\n\n") : "") + (item.content||"");
          $("c_prompt").value = next;
          d.prompt = next;
          saveAll();
          toast("已插入 Prompt");
        }
      };
    });
  }

  ["change","input"].forEach(evt=>{
    qEls.series.addEventListener(evt, filterQuick);
    qEls.kind.addEventListener(evt, filterQuick);
    qEls.style.addEventListener(evt, filterQuick);
    qEls.cat.addEventListener(evt, filterQuick);
    qEls.q.addEventListener(evt, filterQuick);
  });
  filterQuick();

  // Ctrl+S quick save
  window.onkeydown = (e)=>{
    if((e.ctrlKey || e.metaKey) && e.key.toLowerCase()==="s"){
      e.preventDefault();
      sync();
      saveAll();
      toast("已保存");
    }
  };
}

/* =========================
   Materials
   ========================= */
function renderMaterials(){
  const q = state.filters.materialQuery.trim();
  const arr = (state.data.materials||[]).filter(x=>matchesQuery(x, q, ["title","type","note","links","tags"])).slice().reverse();

  return `
  <div class="grid">
    <section class="card">
      <div class="hd">
        <div>
          <h2>素材庫</h2>
          <div class="hint">存放：素材名稱、用途、連結、備註。可複製/載入到創作區。</div>
        </div>
        <div class="btns">
          <button class="btn ghost" id="m_clear">清空輸入</button>
          <button class="btn ok" id="m_save">保存素材</button>
        </div>
      </div>
      <div class="bd">
        <div class="field">
          <label>素材名稱</label>
          <input id="m_title" placeholder="例如：零用錢練功房｜說明頁" />
        </div>
        <div class="row2">
          <div class="field">
            <label>用途/類型</label>
            <input id="m_type" placeholder="例如：PWA／說明頁／表單" />
          </div>
          <div class="field">
            <label>Tags</label>
            <input id="m_tags" placeholder="#幸福教養 #工具" />
          </div>
        </div>
        <div class="field">
          <label>連結</label>
          <textarea id="m_links" style="min-height:90px" placeholder="貼上網址…"></textarea>
        </div>
        <div class="field">
          <label>備註</label>
          <textarea id="m_note" style="min-height:90px" placeholder="例如：要放在影片描述最上面…"></textarea>
        </div>
      </div>
    </section>

    <aside class="card">
      <div class="hd">
        <div>
          <h2>素材清單</h2>
          <div class="hint">搜尋、複製、載入到創作區</div>
        </div>
      </div>
      <div class="bd">
        <div class="field">
          <label>搜尋</label>
          <input id="m_q" value="${esc(state.filters.materialQuery)}" placeholder="關鍵字" />
        </div>
        <div class="list" id="m_list">
          ${arr.length? arr.map(x=>`
            <div class="item" data-id="${x.id}">
              <div class="t">
                <strong>${esc(x.title||"(未命名)")}</strong>
                <span class="pill">${esc(x.type||"")}</span>
              </div>
              <div class="meta">${esc((x.tags||"")+"")}</div>
              <div class="actions">
                <button class="btn ghost btnMCopy">複製</button>
                <button class="btn ok btnMLoad">載入到創作區(連結)</button>
                <button class="btn danger btnMDel">刪除</button>
              </div>
            </div>
          `).join("") : `<div class="small">尚無素材或沒有符合搜尋。</div>`}
        </div>
      </div>
    </aside>
  </div>
  `;
}

function bindMaterials(){
  $("m_q").oninput=(e)=>{ state.filters.materialQuery=e.target.value; render(); };

  $("m_clear").onclick=()=>{
    ["m_title","m_type","m_tags","m_links","m_note"].forEach(id=>$(id).value="");
    toast("已清空");
  };

  $("m_save").onclick=()=>{
    const item = {
      id: uid(),
      title: $("m_title").value.trim() || "(未命名素材)",
      type: $("m_type").value.trim(),
      tags: $("m_tags").value.trim(),
      links: $("m_links").value || "",
      note: $("m_note").value || "",
      createdAt: nowISO(),
      updatedAt: nowISO()
    };
    state.data.materials.push(item);
    saveAll();
    render();
    toast("已保存素材");
  };

  document.querySelectorAll("#m_list .item").forEach(el=>{
    const id = el.getAttribute("data-id");
    const item = state.data.materials.find(x=>x.id===id);
    if(!item) return;

    el.querySelector(".btnMCopy").onclick=()=>{
      const txt = [
        `【素材】${item.title}`,
        `【類型】${item.type||""}`,
        "",
        "【連結】",
        item.links||"",
        "",
        "【備註】",
        item.note||"",
        "",
        "【Tags】",
        item.tags||""
      ].join("\n");
      copyText(txt);
    };

    el.querySelector(".btnMLoad").onclick=()=>{
      state.data.draft.links = (state.data.draft.links||"").trim()
        ? (state.data.draft.links.trim()+"\n"+(item.links||""))
        : (item.links||"");
      saveAll();
      toast("已載入到創作區連結");
    };

    el.querySelector(".btnMDel").onclick=()=>{
      if(!confirm("刪除這筆素材？")) return;
      state.data.materials = state.data.materials.filter(x=>x.id!==id);
      saveAll();
      render();
      toast("已刪除");
    };
  });
}

/* =========================
   Promos
   ========================= */
function renderPromos(){
  const q = state.filters.promoQuery.trim();
  const arr = (state.data.promos||[]).filter(x=>matchesQuery(x, q, ["title","platform","series","tool","body","tags","links","cta"])).slice().reverse();

  const d = state.data.draft;

  return `
  <div class="grid">
    <section class="card">
      <div class="hd">
        <div>
          <h2>文宣庫｜貼文/短介紹/活動文案</h2>
          <div class="hint">保存可重用的文宣：FB/IG/Threads… 一鍵複製整包。</div>
        </div>
        <div class="btns">
          <button class="btn ghost" id="p_fillFromCreate">從創作區帶入</button>
          <button class="btn ghost" id="p_clear">清空輸入</button>
          <button class="btn ok" id="p_save">保存文宣</button>
        </div>
      </div>
      <div class="bd">
        <div class="row2">
          <div class="field">
            <label>文宣標題</label>
            <input id="p_title" placeholder="例如：零用錢練功房｜延遲選擇訓練" />
          </div>
          <div class="field">
            <label>平台</label>
            <input id="p_platform" placeholder="FB（長文）/ IG / Threads" />
          </div>
        </div>

        <div class="row2">
          <div class="field">
            <label>系列</label>
            <input id="p_series" placeholder="幸福教養/詩詞人生…" />
          </div>
          <div class="field">
            <label>工具/專案</label>
            <input id="p_tool" placeholder="幸福教養｜零用錢練功房" />
          </div>
        </div>

        <div class="field">
          <label>連結</label>
          <textarea id="p_links" style="min-height:90px" placeholder="貼上主頁 / 工具 / 表單"></textarea>
        </div>

        <div class="field">
          <label>Hashtags</label>
          <input id="p_tags" placeholder="#幸福教養 #天使笑長" />
        </div>

        <div class="field">
          <label>文宣內容</label>
          <textarea id="p_body" placeholder="貼文內容…"></textarea>
        </div>

        <div class="field">
          <label>CTA / 互動引導</label>
          <textarea id="p_cta" style="min-height:90px" placeholder="例如：留言：理智隊長報到！"></textarea>
        </div>
      </div>
    </section>

    <aside class="card">
      <div class="hd">
        <div>
          <h2>文宣清單</h2>
          <div class="hint">搜尋、載入、複製、刪除</div>
        </div>
      </div>
      <div class="bd">
        <div class="field">
          <label>搜尋</label>
          <input id="p_q" value="${esc(state.filters.promoQuery)}" placeholder="關鍵字" />
        </div>
        <div class="list" id="p_list">
          ${arr.length? arr.map(x=>`
            <div class="item" data-id="${x.id}">
              <div class="t">
                <strong>${esc(x.title||"(未命名)")}</strong>
                <span class="pill">${esc(x.platform||"")}</span>
              </div>
              <div class="meta">${esc([x.series, x.tool].filter(Boolean).join("｜"))}</div>
              <div class="actions">
                <button class="btn ghost btnPCopy">複製整包</button>
                <button class="btn ok btnPLoad">載入到表單</button>
                <button class="btn danger btnPDel">刪除</button>
              </div>
            </div>
          `).join("") : `<div class="small">尚無文宣或沒有符合搜尋。</div>`}
        </div>
      </div>
    </aside>
  </div>
  `;
}

function bindPromos(){
  $("p_q").oninput=(e)=>{ state.filters.promoQuery=e.target.value; render(); };

  $("p_clear").onclick=()=>{
    ["p_title","p_platform","p_series","p_tool","p_links","p_tags","p_body","p_cta"].forEach(id=>$(id).value="");
    toast("已清空");
  };

  $("p_fillFromCreate").onclick=()=>{
    const d = state.data.draft;
    $("p_series").value = d.series||"";
    $("p_tool").value = d.tool||"";
    $("p_platform").value = d.platform||"";
    $("p_links").value = d.links||"";
    $("p_tags").value = d.hashtags||"";
    $("p_title").value = inferTitleFromContent() || d.title || "";
    $("p_body").value = short100(d.content||d.prompt||"");
    $("p_cta").value = "留言：「理智隊長報到！」一起交流";
    toast("已帶入");
  };

  $("p_save").onclick=()=>{
    const item = {
      id: uid(),
      title: $("p_title").value.trim() || "(未命名文宣)",
      platform: $("p_platform").value.trim(),
      series: $("p_series").value.trim(),
      tool: $("p_tool").value.trim(),
      links: $("p_links").value || "",
      tags: $("p_tags").value.trim(),
      body: $("p_body").value || "",
      cta: $("p_cta").value || "",
      createdAt: nowISO(),
      updatedAt: nowISO()
    };
    state.data.promos.push(item);
    saveAll();
    render();
    toast("已保存文宣");
  };

  document.querySelectorAll("#p_list .item").forEach(el=>{
    const id = el.getAttribute("data-id");
    const item = state.data.promos.find(x=>x.id===id);
    if(!item) return;

    el.querySelector(".btnPCopy").onclick=()=>{
      const txt=[
        `【標題】${item.title}`,
        `【工具/專案】${item.tool||""}`,
        `【系列】${item.series||""}`,
        `【平台】${item.platform||""}`,
        "",
        "【連結】",
        item.links||"",
        "",
        "【Hashtags】",
        item.tags||"",
        "",
        "【文宣內容】",
        item.body||"",
        "",
        "【互動/CTA】",
        item.cta||""
      ].join("\n");
      copyText(txt);
    };

    el.querySelector(".btnPLoad").onclick=()=>{
      $("p_title").value = item.title||"";
      $("p_platform").value = item.platform||"";
      $("p_series").value = item.series||"";
      $("p_tool").value = item.tool||"";
      $("p_links").value = item.links||"";
      $("p_tags").value = item.tags||"";
      $("p_body").value = item.body||"";
      $("p_cta").value = item.cta||"";
      toast("已載入");
    };

    el.querySelector(".btnPDel").onclick=()=>{
      if(!confirm("刪除這筆文宣？")) return;
      state.data.promos = state.data.promos.filter(x=>x.id!==id);
      saveAll();
      render();
      toast("已刪除");
    };
  });
}

/* =========================
   Publish pack
   ========================= */
function renderPublish(){
  const d = state.data.publishDraft;
  const q = state.filters.publishQuery.trim();
  const arr = (state.data.publishes||[]).filter(x=>matchesQuery(x, q, ["title","intro","hashtags","toolLinks","notes","date"])).slice().reverse();

  return `
  <div class="grid">
    <section class="card">
      <div class="hd">
        <div>
          <h2>發片打包｜描述、hashtags、工具連結一次到位</h2>
          <div class="hint">你可以直接複製貼上 YouTube 描述欄；也能保存成打包模板。</div>
        </div>
        <div class="btns">
          <button class="btn ghost" id="pb_clear">清空</button>
          <button class="btn ghost" id="pb_copy">複製打包</button>
          <button class="btn ok" id="pb_save">保存打包</button>
        </div>
      </div>
      <div class="bd">
        <div class="row2">
          <div class="field" style="flex:1.2">
            <label>影片標題</label>
            <input id="pb_title" value="${esc(d.title)}" placeholder="會從一鍵轉打包自動填，也可手改" />
          </div>
          <div class="field" style="flex:.8">
            <label>日期（可空）</label>
            <input id="pb_date" value="${esc(d.date)}" placeholder="2026-01-04" />
          </div>
        </div>

        <div class="field">
          <label>影片介紹（100 字自動截斷可手改）</label>
          <textarea id="pb_intro" style="min-height:120px">${esc(d.intro)}</textarea>
        </div>

        <div class="field">
          <label>Hashtags</label>
          <input id="pb_tags" value="${esc(d.hashtags)}" />
        </div>

        <div class="field">
          <label>工具/連結（主頁 / PWA / 表單…）</label>
          <textarea id="pb_links" style="min-height:120px">${esc(d.toolLinks)}</textarea>
        </div>

        <div class="field">
          <label>備註（不一定要貼到描述欄，可當內部提示）</label>
          <textarea id="pb_notes" style="min-height:120px">${esc(d.notes)}</textarea>
        </div>

        <div class="small">小提醒：你也可以回到「創作區」按 <strong>一鍵轉成發片打包</strong>，它會自動填標題、100字介紹、hashtags、工具連結。</div>
      </div>
    </section>

    <aside class="card">
      <div class="hd">
        <div>
          <h2>打包清單</h2>
          <div class="hint">載入 / 複製 / 刪除</div>
        </div>
      </div>
      <div class="bd">
        <div class="field">
          <label>搜尋</label>
          <input id="pb_q" value="${esc(state.filters.publishQuery)}" placeholder="關鍵字" />
        </div>
        <div class="list" id="pb_list">
          ${arr.length? arr.map(x=>`
            <div class="item" data-id="${x.id}">
              <div class="t">
                <strong>${esc(x.title||"(未命名打包)")}</strong>
                <span class="pill">${esc(x.date||"")}</span>
              </div>
              <div class="meta">${esc(short100(x.intro||""))}</div>
              <div class="actions">
                <button class="btn ghost btnPBLoad">載入</button>
                <button class="btn ok btnPBCopy">複製</button>
                <button class="btn danger btnPBDel">刪除</button>
              </div>
            </div>
          `).join("") : `<div class="small">尚無打包或沒有符合搜尋。</div>`}
        </div>
      </div>
    </aside>
  </div>
  `;
}

function bindPublish(){
  $("pb_q").oninput=(e)=>{ state.filters.publishQuery=e.target.value; render(); };

  const d = state.data.publishDraft;

  ["pb_title","pb_date","pb_intro","pb_tags","pb_links","pb_notes"].forEach(id=>{
    $(id).oninput = (e)=>{
      if(id==="pb_title") d.title=e.target.value;
      if(id==="pb_date") d.date=e.target.value;
      if(id==="pb_intro") d.intro=e.target.value;
      if(id==="pb_tags") d.hashtags=e.target.value;
      if(id==="pb_links") d.toolLinks=e.target.value;
      if(id==="pb_notes") d.notes=e.target.value;
    };
  });

  $("pb_clear").onclick=()=>{
    state.data.publishDraft = { title:"", date:"", intro:"", hashtags: state.data.settings.defaultHashtags, toolLinks: state.data.settings.defaultToolLinks, notes:"" };
    saveAll();
    render();
    toast("已清空");
  };

  $("pb_copy").onclick=()=>{
    const txt=[
      `【影片標題】${d.title||""}`,
      d.date ? `【日期】${d.date}` : "",
      "",
      "【影片介紹】",
      d.intro||"",
      "",
      "【Hashtags】",
      d.hashtags||"",
      "",
      "【工具/連結】",
      d.toolLinks||"",
      d.notes ? ("\n【備註】\n"+(d.notes||"")) : ""
    ].filter(Boolean).join("\n");
    copyText(txt);
  };

  $("pb_save").onclick=()=>{
    const item={
      id: uid(),
      title: (d.title||"").trim() || "(未命名打包)",
      date: (d.date||"").trim(),
      intro: d.intro||"",
      hashtags: d.hashtags||"",
      toolLinks: d.toolLinks||"",
      notes: d.notes||"",
      createdAt: nowISO(),
      updatedAt: nowISO()
    };
    state.data.publishes.push(item);
    saveAll();
    render();
    toast("已保存打包");
  };

  document.querySelectorAll("#pb_list .item").forEach(el=>{
    const id=el.getAttribute("data-id");
    const item=state.data.publishes.find(x=>x.id===id);
    if(!item) return;

    el.querySelector(".btnPBLoad").onclick=()=>{
      state.data.publishDraft = {
        title: item.title||"",
        date: item.date||"",
        intro: item.intro||"",
        hashtags: item.hashtags||state.data.settings.defaultHashtags,
        toolLinks: item.toolLinks||state.data.settings.defaultToolLinks,
        notes: item.notes||""
      };
      saveAll();
      render();
      toast("已載入");
    };

    el.querySelector(".btnPBCopy").onclick=()=>{
      const txt=[
        `【影片標題】${item.title||""}`,
        item.date ? `【日期】${item.date}` : "",
        "",
        "【影片介紹】",
        item.intro||"",
        "",
        "【Hashtags】",
        item.hashtags||"",
        "",
        "【工具/連結】",
        item.toolLinks||"",
        item.notes ? ("\n【備註】\n"+(item.notes||"")) : ""
      ].filter(Boolean).join("\n");
      copyText(txt);
    };

    el.querySelector(".btnPBDel").onclick=()=>{
      if(!confirm("刪除這筆打包？")) return;
      state.data.publishes = state.data.publishes.filter(x=>x.id!==id);
      saveAll();
      render();
      toast("已刪除");
    };
  });
}

/* =========================
   Spells（分流）
   ========================= */
function renderSpells(){
  const facets = buildSpellsFacet();

  // 修正：若篩選值不存在，就回到「全部」
  if(!facets.series.includes(state.filters.spellsSeries)) state.filters.spellsSeries="全部";
  if(!facets.kind.includes(state.filters.spellsKind)) state.filters.spellsKind="全部";
  if(!facets.style.includes(state.filters.spellsStyle)) state.filters.spellsStyle="全部";
  if(!facets.category.includes(state.filters.spellsCategory)) state.filters.spellsCategory="全部";

  const q = (state.filters.spellsQuery||"").trim();
  const arr = (state.data.spells||[]).filter(x=>{
    const s=state.filters.spellsSeries, k=state.filters.spellsKind, st=state.filters.spellsStyle, c=state.filters.spellsCategory;
    if(s!=="全部" && (x.series||"未分類")!==s) return false;
    if(k!=="全部" && (x.kind||"未分類")!==k) return false;
    if(st!=="全部" && (x.style||"未分類")!==st) return false;
    if(c!=="全部" && (x.category||"未分類")!==c) return false;
    if(q && !matchesQuery(x, q, ["title","content","category","style","kind","series"])) return false;
    return true;
  }).slice().reverse();

  const d = state.spellDraft;

  return `
  <div class="grid">
    <section class="card">
      <div class="hd">
        <div>
          <h2>咒語庫｜分流管理</h2>
          <div class="hint">分流維度：系列 / 種類 / 風格 / 類別。可複製、載入編輯、插入創作區。</div>
        </div>
        <div class="btns">
          <button class="btn ghost" id="s_clear">清空輸入</button>
          <button class="btn ghost" id="s_copy">複製咒語</button>
          <button class="btn ok" id="s_save">保存咒語</button>
        </div>
      </div>
      <div class="bd">
        <div class="row2">
          <div class="field">
            <label>標題</label>
            <input id="s_title" value="${esc(d.title)}" placeholder="例如：水彩插畫｜車內對話（16:9）" />
          </div>
          <div class="field">
            <label>系列</label>
            <select id="s_series">
              ${["幸福教養","詩詞人生","幸福關係","幸福小腦袋","其他"].map(x=>`<option ${d.series===x?"selected":""}>${x}</option>`).join("")}
            </select>
          </div>
        </div>

        <div class="row2">
          <div class="field">
            <label>種類（分流）</label>
            <select id="s_kind">
              ${["插畫咒語","文案咒語","口說稿咒語","封面咒語","其他"].map(x=>`<option ${d.kind===x?"selected":""}>${x}</option>`).join("")}
            </select>
          </div>
          <div class="field">
            <label>風格（分流）</label>
            <select id="s_style">
              ${["水彩插畫","寫實電影感","繪本風","簡報風","口說稿","其他"].map(x=>`<option ${d.style===x?"selected":""}>${x}</option>`).join("")}
            </select>
          </div>
          <div class="field">
            <label>類別（分流）</label>
            <input id="s_cat" value="${esc(d.category)}" placeholder="例如：車內對話/超市情境/前額葉/Hook+CTA" />
          </div>
        </div>

        <div class="field">
          <label>咒語內容</label>
          <textarea id="s_content" placeholder="貼上完整咒語…">${esc(d.content)}</textarea>
        </div>

        <div class="row">
          <button class="btn ghost" id="s_toCreatePrompt">插入到創作區 Prompt</button>
          <button class="btn ghost" id="s_toCreateContent">插入到創作區 完稿</button>
        </div>

        <div class="small" style="margin-top:10px">
          小技巧：你可以用「類別」把咒語分得更細（例如：車內、超市、情緒急救、前額葉…），之後用右側篩選一秒找回來。
        </div>
      </div>
    </section>

    <aside class="card">
      <div class="hd">
        <div>
          <h2>咒語清單（分流篩選）</h2>
          <div class="hint">篩選後只顯示符合分流的咒語</div>
        </div>
      </div>
      <div class="bd">
        <div class="row2">
          <div class="field">
            <label>系列</label>
            <select id="sf_series">${facets.series.map(x=>`<option ${state.filters.spellsSeries===x?"selected":""}>${x}</option>`).join("")}</select>
          </div>
          <div class="field">
            <label>種類</label>
            <select id="sf_kind">${facets.kind.map(x=>`<option ${state.filters.spellsKind===x?"selected":""}>${x}</option>`).join("")}</select>
          </div>
        </div>
        <div class="row2">
          <div class="field">
            <label>風格</label>
            <select id="sf_style">${facets.style.map(x=>`<option ${state.filters.spellsStyle===x?"selected":""}>${x}</option>`).join("")}</select>
          </div>
          <div class="field">
            <label>類別</label>
            <select id="sf_cat">${facets.category.map(x=>`<option ${state.filters.spellsCategory===x?"selected":""}>${x}</option>`).join("")}</select>
          </div>
        </div>
        <div class="field">
          <label>搜尋</label>
          <input id="sf_q" value="${esc(state.filters.spellsQuery)}" placeholder="關鍵字（標題/內容）" />
        </div>

        <div class="list" id="s_list">
          ${arr.length ? arr.map(x=>`
            <div class="item" data-id="${x.id}">
              <div class="t">
                <strong>${esc(x.title||"(未命名)")}</strong>
                <span class="pill">${esc(x.series||"")}</span>
              </div>
              <div class="meta">${esc([x.kind,x.style,x.category].filter(Boolean).join("｜"))}</div>
              <div class="actions">
                <button class="btn ghost btnSCopy">複製</button>
                <button class="btn ok btnSEdit">編輯</button>
                <button class="btn ghost btnSInsertPrompt">插入Prompt</button>
                <button class="btn danger btnSDel">刪除</button>
              </div>
            </div>
          `).join("") : `<div class="small">沒有符合的咒語。</div>`}
        </div>
      </div>
    </aside>
  </div>
  `;
}

function bindSpells(){
  // filters
  $("sf_series").onchange=(e)=>{ state.filters.spellsSeries=e.target.value; render(); };
  $("sf_kind").onchange=(e)=>{ state.filters.spellsKind=e.target.value; render(); };
  $("sf_style").onchange=(e)=>{ state.filters.spellsStyle=e.target.value; render(); };
  $("sf_cat").onchange=(e)=>{ state.filters.spellsCategory=e.target.value; render(); };
  $("sf_q").oninput=(e)=>{ state.filters.spellsQuery=e.target.value; render(); };

  // draft inputs
  const d = state.spellDraft;

  ["s_title","s_series","s_kind","s_style","s_cat","s_content"].forEach(id=>{
    $(id).oninput=(e)=>{
      if(id==="s_title") d.title=e.target.value;
      if(id==="s_series") d.series=e.target.value;
      if(id==="s_kind") d.kind=e.target.value;
      if(id==="s_style") d.style=e.target.value;
      if(id==="s_cat") d.category=e.target.value;
      if(id==="s_content") d.content=e.target.value;
    };
    $(id).onchange=(e)=>$(id).oninput(e);
  });

  $("s_clear").onclick=()=>{
    state.spellDraft = {id:"", title:"", series:"幸福教養", kind:"插畫咒語", style:"水彩插畫", category:"", content:""};
    render();
    toast("已清空");
  };

  $("s_copy").onclick=()=>{
    copyText($("s_content").value || "");
  };

  $("s_save").onclick=()=>{
    const obj = {
      id: d.id || uid(),
      title: ($("s_title").value||"").trim() || "(未命名咒語)",
      series: $("s_series").value || "其他",
      kind: $("s_kind").value || "其他",
      style: $("s_style").value || "其他",
      category: ($("s_cat").value||"").trim() || "未分類",
      content: $("s_content").value || "",
      createdAt: d.id ? (d.createdAt || nowISO()) : nowISO(),
      updatedAt: nowISO()
    };

    if(d.id){
      state.data.spells = state.data.spells.map(x=> x.id===d.id ? {...x, ...obj} : x);
    }else{
      state.data.spells.push(obj);
    }
    state.spellDraft = {...obj};
    saveAll();
    render();
    toast(d.id ? "已覆蓋保存" : "已保存咒語");
  };

  // insert to create
  function insertToCreate(field){
    const content = $("s_content").value || "";
    if(!content.trim()) return toast("咒語內容是空的");
    const d2 = state.data.draft;
    if(field==="prompt"){
      d2.prompt = (d2.prompt||"").trim()
        ? (d2.prompt.trim()+"\n\n"+content)
        : content;
    }else{
      d2.content = (d2.content||"").trim()
        ? (d2.content.trim()+"\n\n"+content)
        : content;
    }
    saveAll();
    toast("已插入創作區");
  }

  $("s_toCreatePrompt").onclick=()=> insertToCreate("prompt");
  $("s_toCreateContent").onclick=()=> insertToCreate("content");

  // list actions
  document.querySelectorAll("#s_list .item").forEach(el=>{
    const id = el.getAttribute("data-id");
    const item = state.data.spells.find(x=>x.id===id);
    if(!item) return;

    el.querySelector(".btnSCopy").onclick=()=> copyText(item.content||"");

    el.querySelector(".btnSEdit").onclick=()=>{
      state.spellDraft = {...item};
      render();
      toast("已載入可編輯");
    };

    el.querySelector(".btnSInsertPrompt").onclick=()=>{
      const d2 = state.data.draft;
      d2.prompt = (d2.prompt||"").trim()
        ? (d2.prompt.trim()+"\n\n"+(item.content||""))
        : (item.content||"");
      saveAll();
      toast("已插入 Prompt");
      setTab("create");
    };

    el.querySelector(".btnSDel").onclick=()=>{
      if(!confirm("刪除這筆咒語？")) return;
      state.data.spells = state.data.spells.filter(x=>x.id!==id);
      saveAll();
      render();
      toast("已刪除");
    };
  });
}

/* =========================
   Backup
   ========================= */
function renderBackup(){
  return `
  <div class="grid">
    <section class="card">
      <div class="hd">
        <div>
          <h2>備份｜匯出/匯入（JSON）</h2>
          <div class="hint">把整套資料（素材/文宣/打包/咒語/草稿）備份到檔案，或從檔案復原。</div>
        </div>
        <div class="btns">
          <button class="btn ok" id="b_export">匯出備份檔</button>
          <button class="btn ghost" id="b_importBtn">匯入備份檔</button>
          <button class="btn danger" id="b_reset">重置全部資料</button>
        </div>
      </div>
      <div class="bd">
        <div class="small">
          <div>1) 匯出會下載一個 <span class="kbd">.json</span> 檔。</div>
          <div>2) 匯入會用檔案內容覆蓋目前資料（建議先匯出留存）。</div>
        </div>
        <div class="mutedline"></div>
        <details>
          <summary>（可選）直接在這裡貼 JSON 匯入</summary>
          <div class="field" style="margin-top:10px">
            <label>JSON</label>
            <textarea id="b_paste" class="mono" style="min-height:160px" placeholder='貼上整段 JSON…'></textarea>
          </div>
          <button class="btn ok" id="b_importPaste">用貼上內容匯入</button>
        </details>
      </div>
    </section>

    <aside class="card">
      <div class="hd">
        <div>
          <h2>目前資料概況</h2>
          <div class="hint">確認資料數量</div>
        </div>
      </div>
      <div class="bd">
        <div class="mono">${esc(JSON.stringify({
          materials: state.data.materials.length,
          promos: state.data.promos.length,
          publishes: state.data.publishes.length,
          spells: state.data.spells.length
        }, null, 2))}</div>
      </div>
    </aside>
  </div>
  <input type="file" id="b_file" accept="application/json" style="display:none" />
  `;
}

function bindBackup(){
  $("b_export").onclick=()=>{
    const blob = new Blob([JSON.stringify(state.data, null, 2)], {type:"application/json"});
    const a = document.createElement("a");
    a.href = URL.createObjectURL(blob);
    a.download = `angel_studio_backup_${new Date().toISOString().slice(0,10)}.json`;
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    toast("已匯出");
  };

  $("b_importBtn").onclick=()=> $("b_file").click();

  $("b_file").onchange=async(e)=>{
    const f = e.target.files && e.target.files[0];
    if(!f) return;
    try{
      const txt = await f.text();
      const obj = JSON.parse(txt);
      state.data = mergeDeep(structuredClone(DEFAULTS), obj);
      saveAll();
      render();
      toast("已匯入");
    }catch(err){
      alert("匯入失敗：JSON 解析錯誤");
    }finally{
      e.target.value="";
    }
  };

  $("b_importPaste").onclick=()=>{
    const txt = $("b_paste").value || "";
    if(!txt.trim()) return toast("沒有內容");
    try{
      const obj = JSON.parse(txt);
      state.data = mergeDeep(structuredClone(DEFAULTS), obj);
      saveAll();
      render();
      toast("已匯入");
    }catch(err){
      alert("匯入失敗：JSON 解析錯誤");
    }
  };

  $("b_reset").onclick=()=>{
    if(!confirm("確定重置？這會清空所有資料。")) return;
    state.data = structuredClone(DEFAULTS);
    saveAll();
    render();
    toast("已重置");
  };
}

/* =========================
   Help
   ========================= */
function renderHelp(){
  return `
  <section class="card">
    <div class="hd">
      <div>
        <h2>使用說明</h2>
        <div class="hint">你要的兩個重點：① 咒語分流 ② 一鍵轉發片打包</div>
      </div>
    </div>
    <div class="bd">
      <h3 style="margin:0 0 10px; font-size:14px;">① 咒語分流怎麼用？</h3>
      <div class="small">
        <div>到「咒語庫」新增咒語時，填：<strong>系列 / 種類 / 風格 / 類別</strong>。</div>
        <div>以後右側用分流篩選，一秒找到你要的咒語。</div>
        <div>也可以在「創作區」的「快速插入咒語」用分流直接插入 Prompt。</div>
      </div>

      <div class="mutedline"></div>

      <h3 style="margin:0 0 10px; font-size:14px;">② 一鍵把完稿轉成發片打包</h3>
      <div class="small">
        <div>在「創作區」按 <strong>一鍵轉成發片打包</strong>：</div>
        <ul>
          <li>標題：優先用你填的標題；若沒填，就取完稿第一行/第一句當標題。</li>
          <li>介紹：自動從完稿內容抓 <strong>100 字</strong>（可在設定改字數上限）。</li>
          <li>Hashtags：用你草稿裡的 hashtags；若空白，用設定的預設 hashtags。</li>
          <li>工具連結：用你草稿裡的連結；若空白，用設定的預設工具連結。</li>
        </ul>
        <div>轉完會自動跳到「發片打包」分頁，你直接按「複製打包」貼到 YouTube 描述欄即可。</div>
      </div>

      <div class="mutedline"></div>

      <h3 style="margin:0 0 10px; font-size:14px;">資料安全</h3>
      <div class="small">
        <div>所有資料都存在你的瀏覽器 <span class="kbd">localStorage</span>（不會上傳）。</div>
        <div>建議常用「備份 → 匯出備份檔」存一份 JSON。</div>
      </div>
    </div>
  </section>
  `;
}

function bindHelp(){}

/* =========================
   Init
   ========================= */
loadAll();
renderTabs();
renderPills();
render();
</script>
</body>
</html>
